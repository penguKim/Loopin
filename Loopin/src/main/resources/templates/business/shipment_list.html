<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<style>
.col1 {
	width: 160px !important;
	position: relative;
	z-index: 9998;
	margin-right: 5px;
}

.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-timepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>
<body>
	<main id="main" class="main">
	    <div class="pagetitle"></div>
	    <section class="section">
			<!-- ìƒë‹¨ í•„í„° ì˜ì—­ -->
			<div class="row mb-3">
			    <div class="col-12">
			        <div class="card">
			            <div class="card-body">
			                <h5 class="card-title">í•„í„°</h5>
			                <div id="filterModule"></div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">ì¶œí•˜ ê´€ë¦¬</h5>
	                        </div>
							<div class="col-sm-12">
		                        <!-- ì¶œí•˜ ê´€ë¦¬ ê·¸ë¦¬ë“œ -->
		                        <div id="contract_grid"></div>
							</div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">ì¶œí•˜ ìƒì„¸</h5>
	                        </div>
	                        <!-- ì¶œí•˜ ìƒì„¸ ê·¸ë¦¬ë“œ -->
	                        <div id="detail_grid"></div>
			            </div>
			        </div>
			    </div>
			</div>
	    </section>
	</main>
</body>

<script>
	// ì¶œí•˜ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
	function fetchShipmentDetails(contract_cd) {
	    console.log(`fetchShipmentDetails í˜¸ì¶œ: contract_cd=${contract_cd}`); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
		
		if (!contract_cd) {
		    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ contract_cdì…ë‹ˆë‹¤:", contract_cd);
		    return;
		}
		
	    $.ajax({
	        url: `/get_CONTRACT_SHIPMENT?contract_cd=${contract_cd}`,
	        method: 'GET',
	        success: function (response) {
	            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response); // ì‘ë‹µ ë°ì´í„° í™•ì¸

				// ì¶œí•˜ ë°ì´í„° ê²€ì¦
				if (!response || !response.contract || !response.contract.contract_cd) {
				    console.error("ì‘ë‹µ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", response);
				    Swal.fire({
				        icon: 'error',
				        title: 'ì˜¤ë¥˜ ë°œìƒ!',
				        text: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
				        confirmButtonText: 'í™•ì¸'
				    });
				    return;
				}
				
				// ì¶œí•˜ ë°ì´í„°ì™€ ìƒì„¸ ë°ì´í„° ì „ë‹¬í•˜ì—¬ ëª¨ë‹¬ ì—´ê¸°
				openModal(response);
	        },
	        error: function (xhr) {
				window.isFetchingDetails = false; // í”Œë˜ê·¸ í•´ì œ
	            console.error("ì„œë²„ ìš”ì²­ ì˜¤ë¥˜:", xhr.status, xhr.responseText);
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ!',
	                text: 'ì¶œí•˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });
	}

	// ì¶œí•˜ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
	function updateContractSummary(grid) {
	    const data = grid.getData();
	    let totalQty = 0;

	    data.forEach(row => {
	        const qty = parseFloat(row.product_am) || 0;

	        totalQty += qty;
	    });

	    $('#contract_am').val(totalQty);
	}	
	
		
	// ë™ì  ëª¨ë‹¬ ìƒì„± ë° í‘œì‹œ
	function openModal(rowData) {
		
		console.log("openModal í˜¸ì¶œë¨", "rowData:", rowData);
		
		// ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
		if (!rowData || !rowData.contract || !rowData.contract.contract_cd) {
		    console.error("rowDataê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ contract_cdê°€ ì—†ìŠµë‹ˆë‹¤.", rowData);
		    Swal.fire({
		        icon: 'error',
		        title: 'ì˜¤ë¥˜ ë°œìƒ!',
		        text: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
		        confirmButtonText: 'í™•ì¸'
		    });
		    return;
		}

		console.log("ëª¨ë‹¬ ì´ˆê¸°í™” ì„±ê³µ:", rowData);

	    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
	    $('#contractInsertModal').remove();

		// ëª¨ë‹¬ ì œëª© ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		let modalTitle = 'ì¶œí•˜ ë“±ë¡';
		const submitButtonText = 'ë“±ë¡';
			
	    let contractStatus = rowData.contract.contract_st ? rowData.contract.contract_st.trim() : "ì§„í–‰ì¤‘";
	    let isCompleted = contractStatus === "ì™„ë£Œ";
		
	    // ëª¨ë‹¬ HTML ìƒì„±
	    const modalHtml = `
	        <div class="modal" id="contractInsertModal" tabindex="-1" aria-labelledby="contractInsertModalLabel" aria-hidden="true">
	            <div class="modal-dialog modal-dialog-centered modal-xl">
	                <div class="modal-content">
	                    <div class="modal-header">
	                        <h5 class="modal-title" id="dynamicModalLabel">${modalTitle}</h5>
	                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	                    </div>
	                    <div class="modal-body">
	                        <form id="appointment_form" method="post" enctype="multipart/form-data">
	                            <div class="row mb-3">
	                                <div class="col-md-4">
	                                    <label for="contract_ps" class="form-label">ìˆ˜ì£¼ë²ˆí˜¸</label>
	                                    <input type="text" class="form-control" id="contract_cd" name="contract_cd" disabled>
	                                </div>
									<div class="col-md-4">
									    <label for="account_sd" class="form-label">ìˆ˜ì£¼ì¼</label>
									    <input type="text" class="form-control" id="contract_sd" name="contract_sd" disabled>
									    <div id="modal_startpicker-container"></div>
									</div>
									<div class="col-md-4">
									    <label for="contract_ed" class="form-label">ì¶œí•˜ì¼</label>
									    <input type="text" class="form-control" id="contract_ed" name="contract_ed" readonly>
									    <div id="modal_endpicker-container"></div>
									</div>
	                            </div>
								<div class="row mb-3">
									<div class="col-md-4">
									    <label for="account_cp" class="form-label">ê±°ë˜ì²˜ì½”ë“œ</label>
									    <input type="text" class="form-control" id="account_cd" name="account_cd" disabled>
									</div>
									<div class="col-md-4">
									    <label for="contract_st" class="form-label">ì¶œí•˜ìƒíƒœ</label>
									    <input type="text" class="form-control" id="contract_st" name="contract_st" disabled>
									</div>
									<div class="col-md-4">
									    <label for="contract_am" class="form-label">ì¶œí•˜ìˆ˜ëŸ‰</label>
									    <input type="text" class="form-control" id="contract_am" name="contract_am" disabled>
									</div>
								</div>
	                            <div class="row mb-3">
			                        <div class="col-sm-3 text-start">
		                            	<h5 class="modal-title">ì¶œí•˜ ì œí’ˆ ëª©ë¡</h5>
									</div>
	                            </div>
	                            <div class="row">
	                                <div id="productGrid"></div>
	                            </div>
	                        </form>
	                    </div>
	                    <div class="modal-footer  d-flex justify-content-between">
		                    <div>    
		                    	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
		                        <button type="button" class="btn btn-primary" id="modal_submit_button">${submitButtonText}</button>
		                    </div>
	                    </div>
	                </div>
	            </div>
	        </div>`;

		// ëª¨ë‹¬ HTMLì„ ë™ì ìœ¼ë¡œ bodyì— ì¶”ê°€
		document.body.insertAdjacentHTML('beforeend', modalHtml);

		// ëª¨ë‹¬ì´ ì¶”ê°€ëœ í›„ ì‹¤í–‰
		const modalElement = document.getElementById('contractInsertModal');
		if (!modalElement) {
		    console.error("ëª¨ë‹¬ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
		    return;
		}
		
	    
	    // Bootstrap ëª¨ë‹¬ í‘œì‹œ
	    const modalInstance = new bootstrap.Modal(document.getElementById('contractInsertModal'));
	    modalInstance.show();
		    
	    // ì œí’ˆ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
	    make_product_grid();

	    // DatePicker ì´ˆê¸°í™”
	    initializeDatePickers();
		
	    // ì¶œí•˜ ìƒíƒœ ì„¤ì • (ê¸°ë³¸ ê°’) - grid ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
	    $('#contract_cd').val(rowData.contract.contract_cd || '');
	    $('#account_cd').val(rowData.contract.account_cd || '');
	    $('#contract_sd').val(rowData.contract.contract_sd || '');
	    $('#contract_ed').val(rowData.contract.contract_ed || '');
	    $('#contract_st').val(rowData.contract.contract_st || ''); // Gridì˜ ë°ì´í„° ì‚¬ìš©
	    $('#contract_am').val(rowData.contract.contract_am?.toLocaleString() || '');

	    if (contractStatus === "ì™„ë£Œ") {
	        $('#contract_ed').prop('disabled', true); // ì¶œí•˜ì¼ ë¹„í™œì„±í™”
	        $('#modal_submit_button').hide(); // ë“±ë¡ ë²„íŠ¼ ìˆ¨ê¹€
	        modalTitle = 'ì¶œí•˜ ì™„ë£Œ';
	    } else {
	        $('#contract_ed').prop('readonly', false); // ì¶œí•˜ì¼ í™œì„±í™”
	        $('#modal_submit_button').show(); // ë“±ë¡ ë²„íŠ¼ í‘œì‹œ
	    }
	
		// ë³€ê²½ëœ modalTitleì„ ëª¨ë‹¬ì— ì ìš©
		$('#dynamicModalLabel').text(modalTitle);
	    
	    // ì¶œí•˜ ìƒíƒœì— ë”°ë¼ `productGrid` ì»¬ëŸ¼ ë³€ê²½
	    make_product_grid(isCompleted);
	    
		if (rowData.details && Array.isArray(rowData.details)) {
		    // ì²« ë²ˆì§¸ ìƒì„¸ ë°ì´í„°ì˜ ë‚©ê¸°ì¼ì„ ë°”ì¸ë”©
		    if (rowData.details.length > 0) {
		        $('#detail_contract_ed').val(rowData.details[0].detail_contract_ed || '').prop('disabled', false); // ì²« ë²ˆì§¸ ìƒì„¸ ë°ì´í„°ì˜ ë‚©ê¸°ì¼ í™œì„±í™”
		    }

		    // ìƒì„¸ ë°ì´í„° `productGrid`ì— ì ìš©
		    productGrid.resetData(rowData.details);
		}
		

		// Toast UI Grid ë°ì´í„° ë³€ê²½ ì‹œ ì¶œí•˜ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
		productGrid.on('afterChange', function (ev) {
		    updateContractSummary(productGrid);
		});

			
		// ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì œì¶œ ì‹¤í–‰ (ì¤‘ë³µ ë°©ì§€)
		$(document).off('click', '#modal_submit_button').on('click', '#modal_submit_button', function () {
		    console.log("ë“±ë¡ ë²„íŠ¼ í´ë¦­ë¨!");

		    // ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ë²„íŠ¼ ë¹„í™œì„±í™”)
		    $(this).prop('disabled', true);

		    // í¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì œì¶œ ì‹¤í–‰
		    if ($('#appointment_form').length > 0) {
		        $('#appointment_form').trigger('submit');  // í¼ ì œì¶œ ì‹¤í–‰
		    } else {
		        console.error("ì˜¤ë¥˜: #appointment_form ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
		        $(this).prop('disabled', false);  // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
		    }
		});
		
		
		// í¼ ì œì¶œ ì´ë²¤íŠ¸
		$(document).off('submit', '#appointment_form').on('submit', '#appointment_form', function (event) {
			
	        event.preventDefault();
	        
		    if (!validateForm()) {
		        console.log("í¼ ê²€ì¦ ì‹¤íŒ¨, ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”");
		        $('#modal_submit_button').prop('disabled', false);
		        return false; // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì œì¶œ ì¤‘ë‹¨
		    }
	        
		    const contractDTO = {
		    	    contract_cd: $('#contract_cd').val(),
		    	    contract_ed: $('#contract_ed').val(),
		    	    contract_st: $('#contract_st').val()
		    	};

		    	const details = productGrid.getData().map(row => ({
		    	    product_cd: row.product_cd,
		    	    product_sz: row.product_sz,
		    	    product_cr: row.product_cr,
		    	    product_am: parseInt(row.product_am)
		    	}));
		    	
			console.log("ë³´ë‚¼ ë°ì´í„°:", { contract: contractDTO, details: details });
		    
	        // AJAX ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
	        $.ajax({
	            url: '/update_CONTRACT_SHIPMENT',
	            method: 'POST',
	            contentType: "application/json",  // JSON í˜•ì‹ ì§€ì •
	            data: JSON.stringify({ contract: contractDTO, details: details }),
	            headers: { 'X-CSRF-TOKEN': csrfToken },
	            success: function (response) {
	                if (response.success) {
	                    Swal.fire({ icon: 'success', title: 'ì¶œí•˜ ì™„ë£Œ', text: response.message });
	                } else {
	                    Swal.fire({ icon: 'error', title: 'ì¶œí•˜ ì‹¤íŒ¨', text: response.message });
	                }
	            	modalInstance.hide();
	            	make_contract_grid();
				    make_detail_grid({ contract_cd: contractDTO.contract_cd });
	            },
	            error: function () {
	            	Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	            }
	        });
	    });
	}
	
	function validateForm() {
	    let isValid = true;
	    let errorMessage = "";

	    // í•„ìˆ˜ê°’ ê²€ì¦í•  í•„ë“œ ëª©ë¡
	    const requiredFields = [
	        { id: '#contract_ed', message: 'ì¶œí•˜ì¼ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }
	    ];

	    requiredFields.forEach(field => {
	        const value = $(field.id).val()?.trim();
	        if (!value) {
	            errorMessage = field.message;
	            isValid = false;
	            return false; // ì²« ë²ˆì§¸ ì˜¤ë¥˜ì—ì„œ ì¤‘ë‹¨
	        }
	    });

	    if (!isValid) {
	        Swal.fire({
	            icon: 'error',
	            title: 'ì…ë ¥ ì˜¤ë¥˜',
	            text: errorMessage,
	            confirmButtonText: 'í™•ì¸'
	        });
	        return false;
	    }

	    return true; // ëª¨ë“  í•„ìˆ˜ê°’ì´ ì…ë ¥ëœ ê²½ìš° true ë°˜í™˜
	}

	
	
	// DatePicker ì´ˆê¸°í™” í•¨ìˆ˜
	function initializeDatePickers() {
		 console.log('DatePicker ì´ˆê¸°í™” ì‹œì‘');
		
		const today = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ

	    
	    // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ DatePicker ì´ˆê¸°í™”
	    const startPicker = tui.DatePicker.createRangePicker({
	    	language: 'ko',
	    	startpicker: {
	            date: today,
	            input: '#contract_sd',
	            container: '#modal_startpicker-container',
	        },
	        endpicker: {
	            date: null,
	            input: '#contract_ed',
	            container: '#modal_endpicker-container',
	            disabled: true,
	        },
	        format: 'YYYY-MM-dd',
	        timePicker: false,
	    });

	    // ì˜¬ë°”ë¥¸ ì‹œì‘ì¼ ë³€ê²½ ì´ë²¤íŠ¸
	    startPicker.getStartpicker().on('change', function () {
	        const startDate = startPicker.getStartpicker().getDate(); // ì‹œì‘ì¼ ê°€ì ¸ì˜¤ê¸°
	        console.log('ì„ íƒëœ ì‹œì‘ì¼:', startDate);

	        if (!startDate) {
	            console.error('ì‹œì‘ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!');
	            return;
	        }

	        const minEndDate = new Date(startDate);
	        minEndDate.setDate(minEndDate.getDate() + 1);

	        startPicker.getEndpicker().setDate({
	            date: minEndDate,
	            disabled: false,
	        });

	        updateShipmentStatus();
	    });

		// ì˜¬ë°”ë¥¸ ì¢…ë£Œì¼ ë³€ê²½ ì´ë²¤íŠ¸
	    startPicker.getEndpicker().on('change', function () {
	        const endDate = startPicker.getEndpicker().getDate(); // ì¢…ë£Œì¼ ê°€ì ¸ì˜¤ê¸°
	        console.log('ì„ íƒëœ ì¢…ë£Œì¼:', endDate);

	        if (!endDate) {
	            console.error('ì¢…ë£Œ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!');
	            return;
	        }

	        updateShipmentStatus();
	    });
	}
	
	// ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
	function formatDate(date) {
	    if (!date) return null;
	    let d = new Date(date);
	    let year = d.getFullYear();
	    let month = String(d.getMonth() + 1).padStart(2, '0');
	    let day = String(d.getDate()).padStart(2, '0');
	    return `${year}-${month}-${day}`;
	}

	// ì¶œí•˜ ìƒíƒœ ìë™ ì„¤ì • í•¨ìˆ˜
	function updateShipmentStatus() {
	    let contractSd = $('#contract_sd').val();
	    let contractEd = $('#contract_ed').val();
	    let today = new Date().toISOString().split('T')[0]; // ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD)

	    console.log("updateShipmentStatus ì‹¤í–‰ë¨ | contract_sd:", contractSd, "contract_ed:", contractEd, "today:", today);

	    contractSd = formatDate(new Date(contractSd));
	    contractEd = contractEd ? formatDate(new Date(contractEd)) : "";
	    
	    let status = "ì•Œ ìˆ˜ ì—†ìŒ";

	    if (contractSd > today) {
	        status = "ëŒ€ê¸°ì¤‘";
	    } 
	    else if (contractSd <= today) {
	        // ì¢…ë£Œì¼ì´ ì—†ê±°ë‚˜ ì˜¤ëŠ˜ì´í›„ "ì§„í–‰ì¤‘"
	        if (!contractEd || contractEd > today) {
	            status = "ì§„í–‰ì¤‘";
	        } 
	        // ì¢…ë£Œì¼ì´ ì˜¤ëŠ˜ ì´ì „ì´ê±°ë‚˜ ì˜¤ëŠ˜ì´ë©´  "ì™„ë£Œ"
	        else if (contractEd <= today) {
	            status = "ì™„ë£Œ";
	        }
	    }

	    console.log("ê³„ì‚°ëœ ìˆ˜ì£¼ ìƒíƒœ:", status);
	    $('#contract_st').val(status);
	}
	
</script>


<script th:inline="javascript">
	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    // ë³€ìˆ˜ ì§€ì •
    let contract_grid;
    let detail_grid;
    let productGrid;
    setGridTheme();
    
    
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    $(function () {
    	
        // í•„í„° ì„¤ì •
        const filterConfig = [
            { key: 'startDate', label: 'ì¡°íšŒê¸°ê°„ ì‹œì‘ì¼', type: 'daterangepicker', format: 'YYYY-MM-dd', value: '2024-01-01'},
            { key: 'endDate', label: 'ì¡°íšŒê¸°ê°„ ì¢…ë£Œì¼', type: 'daterangepicker', format: 'YYYY-MM-dd', value: '2025-12-31'},
            { key: 'contractCd', label: 'ìˆ˜ì£¼ë²ˆí˜¸', type: 'text', placeholder: 'ìˆ˜ì£¼ë²ˆí˜¸ ì…ë ¥', col: 'col-4' },
            { key: 'accountCd', label: 'ê±°ë˜ì²˜ì½”ë“œ', type: 'text', placeholder: 'ê±°ë˜ì²˜ì½”ë“œ ì…ë ¥', col: 'col-4' },
            { key: 'contractPs', label: 'ë‹´ë‹¹ìëª…', type: 'text', placeholder: 'ë‹´ë‹¹ìëª… ì…ë ¥', col: 'col-4' },
        ];

        // í•„í„° ëª¨ë“ˆ ì´ˆê¸°í™”
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            console.log('ì ìš©ëœ í•„í„°:', filterValues);

            // ì„œë²„ ìš”ì²­ ë° ê·¸ë¦¬ë“œ ê°±ì‹ 
            fetch('/select_FILTERED_CONTRACT_SHIPMENT', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token, // CSRF í† í°
                },
                body: JSON.stringify(filterValues)
            })
            .then(response => response.json())
            .then(filteredData => {
                console.log('í•„í„°ë§ëœ ë°ì´í„°:', filteredData);
                contract_grid.resetData(filteredData); // ê·¸ë¦¬ë“œ ë°ì´í„° ê°±ì‹ 
                make_detail_grid(); // í•„í„° ê²€ìƒ‰ ì‹œ ì¶œí•˜ ìƒì„¸ ì´ˆê¸°í™”
            })
            .catch(error => console.error('í•„í„° ì ìš© ì˜¤ë¥˜:', error));
        });

        // ìƒë‹¨(Contract Grid) ìƒì„±
		make_contract_grid();
        // í•˜ë‹¨(Detail Grid) ìƒì„±
		make_detail_grid();
        
	    // í•„í„° ì—”í„°í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
		$('#filterModule').on('keypress', function (e) {
		    if (e.keyCode !== 13) return;
		    const filterValues = {};
	
		    for (const config of filterConfig) {
		        const input = $(`#${config.key}`);
		        let value = input.val();
	
		        filterValues[config.key] = value;
				
				console.log('í•„í„°ê°’:', filterValues);  // í•„í„°ë§ëœ ê°’ í™•ì¸
		    }
	
		    // ì„œë²„ ìš”ì²­ ë° ê·¸ë¦¬ë“œ ê°±ì‹ 
		    $.ajax({
		        url: '/select_FILTERED_CONTRACT_SHIPMENT',
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		            [csrfHeader]: csrfToken,
		        },
		        data: JSON.stringify(filterValues),
		        success: function(filteredData) {
		        	console.log('ì—”í„°í‚¤ë¡œ í•„í„°ë§ëœ ë°ì´í„°:', filteredData);
		        	contract_grid.resetData(filteredData); // ê·¸ë¦¬ë“œ ë°ì´í„° ê°±ì‹ 
					make_detail_grid(); // í•„í„° ê²€ìƒ‰ ì‹œ ì¶œí•˜ ìƒì„¸ ì´ˆê¸°í™”
		        },
		        error: function(error) {
		            console.error('ì—”í„°í‚¤ í•„í„° ì ìš© ì˜¤ë¥˜:', error);
		        }
		    });
		});
    });

    
    // ìƒë‹¨(Contract Grid) ìƒì„± í•¨ìˆ˜
    function make_contract_grid() {
		
        $.ajax({
            url: '/select_CONTRACT_SHIPMENT',
            method: 'GET',
            success: function (response) {
                const contractList = response;

                if (contract_grid) {
                    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ê°±ì‹ 
                    contract_grid.resetData(contractList.map(row => ({
                        contract_cd: row.contract_cd,
                        account_cd: row.account_cd,
                        employee_cd: row.employee_cd,
                        contract_ps: row.contract_ps,
                        contract_sd: row.contract_sd,
                        contract_ed: row.contract_ed,
                        contract_am: row.contract_am,
                        contract_st: row.contract_st
                    })));
                } else {
                    // ì²˜ìŒ ë¡œë“œ ì‹œ ìƒˆë¡œìš´ ê·¸ë¦¬ë“œ ìƒì„±
                    contract_grid = new tui.Grid({
                        el: document.getElementById('contract_grid'),
                        data: contractList.map(row => ({
                            contract_cd: row.contract_cd,
                            account_cd: row.account_cd,
                            employee_cd: row.employee_cd,
                            contract_ps: row.contract_ps,
                            contract_sd: row.contract_sd,
                            contract_ed: row.contract_ed,
                            contract_am: row.contract_am,
                            contract_st: row.contract_st
                        })),
                        scrollX: true,
                        scrollY: true,
                        autoWidth: true,
                        rowHeight: 'auto',
                        bodyHeight: 'fitToParent',
                        zIndex: 100,
                        columns: [
							{ header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
							{ header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center', sortable: true },
							{ header: 'ì‚¬ì›ì½”ë“œ', name: 'employee_cd', align: 'center', sortable: true },
							{ header: 'ì¶œí•˜ìš”ì²­ì', name: 'contract_ps', align: 'center', sortable: true },
							{ header: 'ìˆ˜ì£¼ì¼ì', name: 'contract_sd', align: 'center', sortable: true },
							{ header: 'ì¶œí•˜ì¼ì', name: 'contract_ed', align: 'center', sortable: true },
							{ header: 'ì¶œí•˜ìƒíƒœ', name: 'contract_st', align: 'center', sortable: true },
							{ header: 'ì¶œí•˜ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true }
                        ],
        				summary: {
        				    height: 40,
        				    position: 'bottom', // or 'top'
        				    columnContent: {
        				    	contract_am: {
        				            template: (valueMap) => {
        				                return `ì´  ${valueMap.cnt} ê±´`
        				            }
        				        }
        				    }
        				}
                    });

                	 // ë‹¨ì¼ í´ë¦­ ì´ë²¤íŠ¸: ìƒì„¸ ì •ë³´ í‘œì‹œ
                    contract_grid.on('click', (ev) => {
                        const rowKey = ev.rowKey;
                        const rowData = contract_grid.getRow(rowKey);

                        if (rowKey === null || rowKey === undefined) {
                            console.warn("í—¤ë” í´ë¦­ì€ ë¬´ì‹œë©ë‹ˆë‹¤.");
                            return;
                        }

                        console.log("í´ë¦­ëœ í–‰ ë°ì´í„°:", rowData); // ë””ë²„ê¹…ìš©
                        if (!rowData) {
                            console.error("rowDataê°€ ì—†ìŠµë‹ˆë‹¤!");
                            return;
                        }
                        if (!rowData.contract_cd) {
                            console.error("contract_cdê°€ ì—†ìŠµë‹ˆë‹¤!", rowData);
                            return;
                        }
                        
                        make_detail_grid(rowData); // í•˜ë‹¨ ê·¸ë¦¬ë“œ ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ
                    });

                }
            },
            error: function (error) {
                console.error('ì¶œí•˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        });
    }

    // í•˜ë‹¨(Detail Grid) ìƒì„± í•¨ìˆ˜
	function make_detail_grid(rowData = null) {
	    // ìƒì„¸ ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë©´ ë¨¼ì € ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
	    if (!detail_grid) {
	        detail_grid = new tui.Grid({
	            el: document.getElementById('detail_grid'),
	            data: [], // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì–´ìˆìŒ
	            scrollX: false,
	            scrollY: false,
	            bodyHeight: 200, // ê³ ì • ë†’ì´ ì„¤ì •
	            columns: [
					 { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
					 { header: 'ì œí’ˆì½”ë“œ', name: 'product_cd', align: 'center', sortable: true },
					 { header: 'ì‚¬ì´ì¦ˆ', name: 'product_sz', align: 'center', sortable: true },
					 { header: 'ìƒ‰ìƒ', name: 'product_cr', align: 'center', sortable: true },
					 { header: 'ì œí’ˆìˆ˜ëŸ‰', name: 'product_am', align: 'center', sortable: true },
					 { header: 'ì¶œí•˜ì¼ì', name: 'contract_ed', align: 'center', sortable: true },
	            ],
				summary: {
				    height: 40,
				    position: 'bottom', // or 'top'
				    columnContent: {
				    	contract_ed: {
				            template: (valueMap) => {
				                return `ì´  ${valueMap.cnt} ê±´`
				            }
				        }
				    }
				}
	        });
			
			// ìˆ˜ì • ëª¨ë‹¬ í˜¸ì¶œì„ ìœ„í•œ í´ë¦­ ì´ë²¤íŠ¸
			detail_grid.on('click', (ev) => {
			    const rowKey = ev.rowKey;
				const clickedRowData = detail_grid.getRow(rowKey);

				// í´ë¦­ëœ ë¶€ë¶„ì´ ìœ íš¨í•œ ë°ì´í„°ì¸ì§€ í™•ì¸
				if (!clickedRowData || Object.keys(clickedRowData).length === 0 || !clickedRowData.contract_cd) {
				    console.warn("ë°ì´í„°ê°€ ì—†ëŠ” ì…€ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤. í´ë¦­ëœ ë°ì´í„°:", clickedRowData);
				    return; // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
				}
				
				// ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆì„ ê²½ìš°
				console.log("ì¶œí•˜ ìƒì„¸ í´ë¦­ë¨, contract_cd:", clickedRowData.contract_cd);

				fetchShipmentDetails(clickedRowData.contract_cd);
			});
			
	    }
	
		// ì´ˆê¸° ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì¼ ê²½ìš° ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
		if (!rowData || !rowData.contract_cd) {
		    console.warn("rowDataê°€ ìœ íš¨í•˜ì§€ ì•Šì•„ ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
		    detail_grid.resetData([]); // ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
		    return;
		}
		
	    console.log("ì„ íƒëœ ì¶œí•˜ ë°ì´í„°:", rowData); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
	
		
	    $.ajax({
	        url: '/select_CONTRACTDETAIL',
	        method: 'GET',
	        data: { contract_cd: rowData.contract_cd }, // ìˆ˜ì£¼ë²ˆí˜¸ ì „ë‹¬
	        success: function (response) {
	            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
	
			    if (Array.isArray(response) && response.length > 0) {
			        detail_grid.resetData(response);
			        console.log("í•˜ë‹¨ ê·¸ë¦¬ë“œ ê°±ì‹  ì™„ë£Œ");
			    } else {
			        console.warn("ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
			        Swal.fire({
			            icon: 'warning',
			            title: 'ë°ì´í„° ì—†ìŒ',
			            text: 'ì¶œí•˜ ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
			            confirmButtonText: 'í™•ì¸'
			        });
			        detail_grid.resetData([]); // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ì´ˆê¸°í™”
			    }
			},
			error: function (error) {
			    console.error("ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
			    Swal.fire({
			        icon: 'error',
			        title: 'ì˜¤ë¥˜ ë°œìƒ!',
			        text: 'ì¶œí•˜ ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
			        confirmButtonText: 'í™•ì¸'
			    });
			    detail_grid.resetData([]); // ì˜¤ë¥˜ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
	        }
	    });

    }
    
    
	// ì´ˆê¸°í™”ëœ productGridë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
	function make_product_grid(isCompleted) {
	    // ê¸°ì¡´ productGrid ì œê±° (ë§Œì•½ ì¡´ì¬í•˜ë©´)
	    if (productGrid) {
	        productGrid.destroy(); // ê·¸ë¦¬ë“œ ì™„ì „ ì‚­ì œ
	        $('#productGrid').empty(); // HTML ìš”ì†Œ ì´ˆê¸°í™”
	        console.log("ê¸°ì¡´ productGrid ì‚­ì œ ì™„ë£Œ");
	    }
	
	    console.log(`ğŸš€ ì¶œí•˜ ìƒíƒœ í™•ì¸: ${isCompleted ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘"} | total_stock, can_ship ì»¬ëŸ¼ ì œê±° ì—¬ë¶€: ${isCompleted}`);
	
	    // ì»¬ëŸ¼ ì„¤ì • (ì¶œí•˜ ìƒíƒœê°€ ì™„ë£Œë©´ total_stock ë° can_ship ì»¬ëŸ¼ ì œê±°)
	    const columns = [
	        { header: 'ì œí’ˆì½”ë“œ', name: 'product_cd', align: 'center' },
	        { header: 'ìƒ‰ìƒ', name: 'product_cr', align: 'center' },
	        { header: 'ì‚¬ì´ì¦ˆ', name: 'product_sz', align: 'center' },
	        { header: 'ê¸°ì¤€ë‹¨ìœ„', name: 'product_un', align: 'center' },
	        { header: 'ìˆ˜ëŸ‰', name: 'product_am', align: 'center' }
	    ];
	
	    if (!isCompleted) {
	        columns.push(
	            { header: 'ì œí’ˆì¬ê³ ', name: 'total_stock', align: 'center' },
	            { 
	                header: 'ì¶œí•˜ì—¬ë¶€', 
	                name: 'can_ship', 
	                align: 'center',
	                formatter: ({ value }) => {
	                    if (value && value.includes('ì¬ê³ ë¶€ì¡±')) {
	                        return `<span style="color: red; font-weight: bold;">${value}</span>`;
	                    } else {
	                        return `<span style="color: green; font-weight: bold;">${value}</span>`;
	                    }
	                }
	            }
	        );
	    }
	
	    // ìƒˆë¡œìš´ ê·¸ë¦¬ë“œ ìƒì„±
	    const summaryConfig = {
	        height: 40,
	        position: 'bottom',
	        columnContent: isCompleted
	            ? {  // ì™„ë£Œ ìƒíƒœ â†’ product_am ì»¬ëŸ¼ì— Summary ì ìš©
	                product_am: {
	                    template: (valueMap) => `ì´ ${valueMap.cnt} ê±´`
	                }
	            }
	            : {  // ì§„í–‰ì¤‘ / ëŒ€ê¸°ì¤‘ â†’ can_ship ì»¬ëŸ¼ì— Summary ì ìš©
	                can_ship: {
	                    template: (valueMap) => `ì´ ${valueMap.cnt} ê±´`
	                }
	            }
	    };
	
	    // ìƒˆë¡œìš´ ê·¸ë¦¬ë“œ ìƒì„±
	    productGrid = new tui.Grid({
	        el: document.getElementById('productGrid'),
	        data: [], // ì´ˆê¸° ë°ì´í„° ì—†ìŒ
	        columns: columns,
	        scrollX: false,
	        scrollY: false,
	        summary: summaryConfig
	    });

	
	    productGrid.on('afterChange', function () {
	        updateContractSummary(productGrid);
	    });
	
	    console.log("âœ… productGrid ì»¬ëŸ¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ë°ì´í„° ìœ ì§€)");
	}

</script>

</html>
