<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{layout}" 
				layout:fragment="content">
				
<style>
.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>				
				
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">ì˜ì—…í˜„í™©</h5>
							<div class="d-flex justify-content-between">
								<div>
									<ul class="nav nav-pills mb-3" id="business-tab" role="tablist">
										<li class="nav-item" role="presentation">
											<button class="nav-link active" id="btn_contract_tab" data-bs-toggle="pill" data-bs-target="#tab_contract" 
											type="button" role="tab" aria-controls="tab_contract" aria-selected="false">ìˆ˜ì£¼</button>
										</li>
										<li class="nav-item" role="presentation">
											<button class="nav-link" id="btn_order_tab" data-bs-toggle="pill" data-bs-target="#tab_order" 
											type="button" role="tab" aria-controls="tab_order" aria-selected="true">ë°œì£¼</button>
										</li>
										<li class="nav-item" role="presentation">
											<button class="nav-link" id="btn_shipment_tab" data-bs-toggle="pill" data-bs-target="#tab_shipment" 
											type="button" role="tab" aria-controls="tab_shipment" aria-selected="true">ì¶œí•˜</button>
										</li>
									</ul>
								</div>
							</div>
							<div class="row mb-3 align-items-end">
							    <div class="col-md-2">
							        <label for="start_dt" class="form-label">ì‹œì‘ì¼</label>
							        <input type="text" class="form-control" id="start_dt" name="start_dt" aria-label="Date">
							        <div id="startpicker-container"></div>
							    </div>
							    <div class="col-md-2">
							        <label for="end_dt" class="form-label">ì¢…ë£Œì¼</label>
							        <input type="text" class="form-control" id="end_dt" name="end_dt" aria-label="Date">
							        <div id="endpicker-container"></div>
							    </div>
							
							    <!-- ì¡°íšŒ ë²„íŠ¼ì„ ì…ë ¥ í•„ë“œì™€ ê°™ì€ ë†’ì´ì— ë°°ì¹˜ -->
							    <div class="col-md-3 d-flex align-items-end">
							        <button type="button" class="btn btn-primary" id="search-btn">ì¡°íšŒ</button>
							    </div>
							</div>

							<!-- ê·¸ë¦¬ë“œ -->
							<div class="row mb-3">
							    <div class="col-sm-12">
							        <div id="contract_grid" class="grid-container"></div>
							        <div id="order_grid" class="grid-container" style="display: none;"></div>
							        <div id="shipment_grid" class="grid-container" style="display: none;"></div>
							    </div>
							</div>
							<div class="row mb-3">
								<!-- ë°” ì°¨íŠ¸ -->
								<div class="col-sm-6">
									<div id="chart-product"></div>
									<div id="chart-material"></div>
									<div id="chart-shipment"></div>
								</div>
								<!-- íŒŒì´ ì°¨íŠ¸ -->
								<div class="col-sm-6">
									<div id="chart-product-amount"></div>
									<div id="chart-material-amount"></div>
									<div id="chart-shipment-amount"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>

<script th:inline="javascript">
	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	
	const btn_contract_tab = $('#btn_contract_tab');
	const btn_order_tab = $('#btn_order_tab');
	const btn_shipment_tab = $('#btn_shipment_tab');
	
	let contract_grid;
	let order_grid;
	let shipment_grid;
	
	$(function () {
	    tui.Grid.setLanguage('ko');
	    tui.Grid.applyTheme('striped');

	    // 1ê°œì›” ì „ê³¼ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
	    const today = new Date();
	    const oneMonthAgo = new Date();
	    oneMonthAgo.setMonth(today.getMonth() - 1);

	    // DatePicker ê°ì²´ ìƒì„±
	    const rangePicker = tui.DatePicker.createRangePicker({
	    	language: 'ko',
	        startpicker: {
	            date: oneMonthAgo,
	            input: '#start_dt',
	            container: '#startpicker-container',
	        },
	        endpicker: {
	            date: today,
	            input: '#end_dt',
	            container: '#endpicker-container',
	            disabled: false,
	        },
	        format: 'yyyy-MM-dd',
	        timePicker: false
	    });

	    // íƒ­ í´ë¦­ ì‹œ í•´ë‹¹ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
	    $('.nav-link').on('click', function () {
	        const selectedTab = $(this).attr('id');
	        const startDt = rangePicker.getStartDate()?.toISOString().split('T')[0] || null;
	        const endDt = rangePicker.getEndDate()?.toISOString().split('T')[0] || null;

	        if (!startDt || !endDt) {
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', confirmButtonText: 'í™•ì¸' });
	            return;
	        }


	        $('.grid-container').hide();
	        $('#chart-product, #chart-material, #chart-product-amount, #chart-material-amount, #chart-shipment, #chart-shipment-amount').hide();

	        // ì°¨íŠ¸ ìš”ì†Œ ì´ˆê¸°í™”
	        $('#chart-product, #chart-material, #chart-product-amount, #chart-material-amount, #chart-shipment, #chart-shipment-amount').empty();

	        if (selectedTab === 'btn_contract_tab') {
	            $('#contract_grid').show();
	            $('#chart-product').show();
	            $('#chart-product-amount').show();
	            make_contract_grid(startDt, endDt);
	            fetchDataAndRenderContractCharts('/select_CONTRACT_PRODUCT', 'chart-product', startDt, endDt);
	            fetchDataAndRenderContractAmountPieChart('/select_CONTRACT_PRODUCT_AMOUNT', 'chart-product-amount', startDt, endDt);
	        } else if (selectedTab === 'btn_order_tab') {
	            $('#order_grid').show();
	            $('#chart-material').show();
	            $('#chart-material-amount').show();
	            make_order_grid(startDt, endDt);
	            fetchDataAndRenderOrderMaterialChart('/select_ORDER_MATERIAL', 'chart-material', startDt, endDt);
	            fetchDataAndRenderOrderAmountPieChart('/select_ORDER_MATERIAL_AMOUNT', 'chart-material-amount', startDt, endDt);
	        } else if (selectedTab === 'btn_shipment_tab') {
	            $('#shipment_grid').show();
	            $('#chart-shipment').show();
	            $('#chart-shipment-amount').show();
	            make_shipment_grid(startDt, endDt);
	            fetchDataAndRenderShipmentChart('/select_SHIPMENT_PRODUCT', 'chart-shipment', startDt, endDt);
	            fetchDataAndRenderShipmentPieChart('/select_SHIPMENT_PRODUCT_AMOUNT', 'chart-shipment-amount', startDt, endDt);
	        }
	    });

	    // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸°
	    $('#search-btn').on('click', function () {
	    	const selectedTab = $('.nav-link.active').attr('id');
	        const startDt = rangePicker.getStartDate()?.toISOString().split('T')[0] || null;
	        const endDt = rangePicker.getEndDate()?.toISOString().split('T')[0] || null;

	        if (!startDt || !endDt) {
	        	Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', confirmButtonText: 'í™•ì¸' });
	            return;
	        }
	        
	        if (selectedTab === 'btn_contract_tab') {
	        	make_contract_grid(startDt, endDt);
	        	fetchDataAndRenderContractCharts('/select_CONTRACT_PRODUCT', 'chart-product', startDt, endDt);
	            fetchDataAndRenderContractAmountPieChart('/select_CONTRACT_PRODUCT_AMOUNT', 'chart-product-amount', startDt, endDt);
	        } else if (selectedTab === 'btn_order_tab') {
	        	make_order_grid(startDt, endDt);
	            fetchDataAndRenderOrderMaterialChart('/select_ORDER_MATERIAL', 'chart-material', startDt, endDt);
	            fetchDataAndRenderOrderAmountPieChart('/select_ORDER_MATERIAL_AMOUNT', 'chart-material-amount', startDt, endDt);
	        } else if (selectedTab === 'btn_shipment_tab') {
	        	make_shipment_grid(startDt, endDt);
	            fetchDataAndRenderShipmentChart('/select_SHIPMENT_PRODUCT', 'chart-shipment', startDt, endDt);
	            fetchDataAndRenderShipmentPieChart('/select_SHIPMENT_PRODUCT_AMOUNT', 'chart-shipment-amount', startDt, endDt);
	        }
	    });

	    //  í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
	    const initialStartDt = rangePicker.getStartDate()?.toISOString().split('T')[0] || null;
	    const initialEndDt = rangePicker.getEndDate()?.toISOString().split('T')[0] || null;
	    if (initialStartDt && initialEndDt) {
	        $('#contract_grid').show();
	        make_contract_grid(initialStartDt, initialEndDt);
	        fetchDataAndRenderContractCharts('/select_CONTRACT_PRODUCT', 'chart-product', initialStartDt, initialEndDt);
	        fetchDataAndRenderContractAmountPieChart('/select_CONTRACT_PRODUCT_AMOUNT', 'chart-product-amount', initialStartDt, initialEndDt);
	    }
	});

	// ìˆ˜ì£¼ íƒ­ ì‹œì‘ 
	
	
	// ìˆ˜ì£¼ ê·¸ë¦¬ë“œ
	function make_contract_grid(startDt, endDt) {
	    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šê³  ë°ì´í„°ë§Œ ê°±ì‹ 
	    if (contract_grid) {
	        load_contract_data(startDt, endDt);  // ë°ì´í„° ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_CONTRACT_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (contract_grid) {
	                contract_grid.resetData(response);
	                return;
	            }
	            contract_grid = new tui.Grid({
	                el: document.getElementById('contract_grid'),
	                data: response, // ì§ì ‘ ë°ì´í„° ì „ë‹¬
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
	                    { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ì¼ì', name: 'contract_sd', align: 'center', sortable: true },
	                    { header: 'ë‚©ê¸°ì¼', name: 'contract_ed', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ê¸ˆì•¡', name: 'contract_mn', align: 'center', formatter: ({ value }) => `â‚©${value.toLocaleString()}`}
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                    	contract_am: {
	                    		template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ê°œ</div>`
	                        },
	                        contract_mn: {
	                        	template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ì›</div>`
	                        }
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ìˆ˜ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	// ìˆ˜ì£¼ ê·¸ë¦¬ë“œ
	function load_contract_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_CONTRACT_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (contract_grid) {
	                contract_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ìˆ˜ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}


	// ìˆ˜ì£¼ ë°” ì°¨íŠ¸
	function fetchDataAndRenderContractCharts(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken // CSRF í† í° í—¤ë” ì¶”ê°€
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);
	
	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }
	
	            const productMap = {};
	            const categories = new Set();
	
	            response.forEach(item => {
	                const productKey = `${item.product_nm} (${item.product_sz}/${item.product_cr})`; // ì œí’ˆëª… (ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ)
	                const date = item.contract_sd;   // ê³„ì•½ ë‚ ì§œ
	                const amount = Number(item.product_am); // ê³„ì•½ ìˆ˜ëŸ‰ (ìˆ«ìë¡œ ë³€í™˜)
	
	                categories.add(date);
	
	                if (!productMap[productKey]) {
	                    productMap[productKey] = [];
	                }
	                productMap[productKey].push({ date, amount });
	            });
	
	            const sortedCategories = Array.from(categories).sort();
	
	            const seriesData = Object.keys(productMap).map(productKey => {
	                const dataArr = sortedCategories.map(date => {
	                    const found = productMap[productKey].find(d => d.date === date);
	                    return found ? found.amount : 0;
	                });
	
	                return { name: productKey, data: dataArr };
	            });
	
	            const data = {
	                categories: sortedCategories,
	                series: seriesData
	            };
	
	            console.log("ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderContractChart(data, chartId); // ğŸ”¹ ë³€í™˜ëœ ë°ì´í„° ì „ë‹¬
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}


	// ìˆ˜ì£¼ ë°” ì°¨íŠ¸ ëœë”ë§ í•¨ìˆ˜
	function renderContractChart(response, chartId) {
	    const data = {
	        categories: response.categories,
	        series: response.series
	    };
	
	    const options = {
	        chart: {
	            title: 'ìˆ˜ì£¼ ì œí’ˆ ìˆ˜ëŸ‰',
	            width: 800,
	            height: 500
	        },
	        xAxis: {
	            title: 'ìˆ˜ì£¼ëŸ‰',
	            type: 'category'
	        },
	        yAxis: {
	            title: 'ìˆ˜ì£¼ ë‚ ì§œ'
	        },
	        series: {
	            stack: false // ëˆ„ì  ê·¸ë˜í”„ ë¹„í™œì„±í™” (ê° ì œí’ˆ ê°œë³„ í‘œì‹œ)
	        },
	        tooltip: {
	            formatter: (value) => `${value} ê°œ`
	        }
	    };
	
	    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.barChart({ el, data, options });
	}
	
	// ìˆ˜ì£¼ íŒŒì´ ì°¨íŠ¸
	function fetchDataAndRenderContractAmountPieChart(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken // CSRF í† í° í—¤ë” ì¶”ê°€
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);

	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }

	            const seriesData = response.map(item => ({
	                name: `${item.product_nm} (${item.product_sz}/${item.product_cr})`,
	                data: Number(item.total_price)
	            }));

	            const data = {
	                series: seriesData
	            };

	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderContractAmountPieChart(data, chartId);
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}

	// ìˆ˜ì£¼ íŒŒì´ ì°¨íŠ¸ ëœë”ë§ í•¨ìˆ˜
	function renderContractAmountPieChart(response, chartId) {
	    const data = {
	        series: response.series
	    };

	    const options = {
	        chart: {
	            title: 'ì œí’ˆë³„ ìˆ˜ì£¼ ê¸ˆì•¡',
	            width: 600,
	            height: 500
	        },
	        tooltip: {
	            formatter: (value) => `â‚©${value.toLocaleString()}`
	        },
	        legend: {
	            align: 'bottom'
	        }
	    };

	    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.pieChart({ el, data, options });
	}
	
	// ìˆ˜ì£¼ íƒ­ ë
	
	
	
	
	
	
	// ë°œì£¼ íƒ­ ì‹œì‘
	// ë°œì£¼ ê·¸ë¦¬ë“œ 
	function make_order_grid(startDt, endDt) {
	    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ê°±ì‹ 
	    if (order_grid) {
	        load_order_data(startDt, endDt);  // ë°ì´í„°ë§Œ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_ORDER_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (order_grid) {
	                order_grid.resetData(response);
	                return;
	            }

	            order_grid = new tui.Grid({
	                el: document.getElementById('order_grid'),
	                data: response, // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ë°œì£¼ë²ˆí˜¸', name: 'order_cd', align: 'center', sortable: true },
	                    { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ì¼ì', name: 'order_sd', align: 'center', sortable: true },
	                    { header: 'ì…ê³ ì¼ì', name: 'order_ed', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ìˆ˜ëŸ‰', name: 'order_am', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ê¸ˆì•¡', name: 'order_mn', align: 'center', formatter: ({ value }) => `â‚©${value.toLocaleString()}`},
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                    	order_am: {
	                    		template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ê°œ</div>`
	                        },
	                        order_mn: {
	                    		template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ì›</div>`
	                        }
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ë°œì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	// ë°œì£¼ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	function load_order_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_ORDER_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (order_grid) {
	                order_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ë°œì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}

	
	// ë°œì£¼ ë°” ì°¨íŠ¸
	function fetchDataAndRenderOrderMaterialChart(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ë°œì£¼ ì œí’ˆ ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);

	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }

	            // ğŸ”¹ ì œí’ˆë³„ ë°ì´í„°ë¥¼ ê·¸ë£¹í™”í•˜ì—¬ ì°¨íŠ¸ ë°ì´í„° êµ¬ì¡° ìƒì„±
	            const productMap = {};
	            const categories = new Set();

	            response.forEach(item => {
	                const productKey = `${item.material_nm} (${item.material_cd})`; // ì œí’ˆëª… (ì½”ë“œ í¬í•¨)
	                const date = item.order_sd;   // ë°œì£¼ ë‚ ì§œ
	                const amount = Number(item.material_am); // ë°œì£¼ ìˆ˜ëŸ‰

	                categories.add(date);

	                if (!productMap[productKey]) {
	                    productMap[productKey] = [];
	                }
	                productMap[productKey].push({ date, amount });
	            });

	            // ğŸ”¹ xì¶• ë‚ ì§œ (categories) ì •ë ¬
	            const sortedCategories = Array.from(categories).sort();

	            // ğŸ”¹ Series ë°ì´í„° ìƒì„± (ë‚ ì§œë³„ ë°œì£¼ ìˆ˜ëŸ‰)
	            const seriesData = Object.keys(productMap).map(productKey => {
	                const dataArr = sortedCategories.map(date => {
	                    const found = productMap[productKey].find(d => d.date === date);
	                    return found ? found.amount : 0;
	                });

	                return { name: productKey, data: dataArr };
	            });

	            // ğŸ”¹ ì°¨íŠ¸ì— ì „ë‹¬í•  ë°ì´í„°
	            const data = {
	                categories: sortedCategories,
	                series: seriesData
	            };

	            console.log("ë°œì£¼ ì œí’ˆ ë°” ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderOrderProductChart(data, chartId); // âœ… ë°” ì°¨íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}


	// ë°œì£¼ ë°” ì°¨íŠ¸ í•¨ìˆ˜
	function renderOrderProductChart(response, chartId) {
	    const data = {
	        categories: response.categories, // xì¶• (ë°œì£¼ ë‚ ì§œ)
	        series: response.series // ì œí’ˆë³„ ë°œì£¼ ìˆ˜ëŸ‰
	    };

	    const options = {
	        chart: {
	            title: 'ê¸°ê°„ë³„ ë°œì£¼ ì œí’ˆ í˜„í™©',
	            width: 800,
	            height: 500
	        },
	        xAxis: {
	            title: 'ë°œì£¼ ìˆ˜ëŸ‰',
	            type: 'category' // ë‚ ì§œë¥¼ ë²”ì£¼í˜• ë°ì´í„°ë¡œ ì„¤ì •
	        },
	        yAxis: {
	            title: 'ë°œì£¼ ë‚ ì§œ'
	        },
	        series: {
	            stack: false // ê°œë³„ ì œí’ˆë³„ë¡œ ìˆ˜ëŸ‰ í‘œì‹œ
	        },
	        tooltip: {
	            formatter: (value) => `${value} ê°œ`
	        }
	    };

	    // âœ… ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.barChart({ el, data, options });
	}
	
	
	
	// ë°œì£¼ íŒŒì´ ì°¨íŠ¸ í•¨ìˆ˜
	function fetchDataAndRenderOrderAmountPieChart(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken // CSRF í† í° í—¤ë” ì¶”ê°€
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);

	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }

	            const seriesData = response.map(item => ({
	                name: `${item.material_nm}`,
	                data: Number(item.total_price)
	            }));

	            const data = {
	                series: seriesData
	            };

	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderOrderAmountPieChart(data, chartId);
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}

	// ë°œì£¼ íŒŒì´ ì°¨íŠ¸ í•¨ìˆ˜
	function renderOrderAmountPieChart(response, chartId) {
	    const data = {
	        series: response.series
	    };

	    const options = {
	        chart: {
	            title: 'ì œí’ˆë³„ ìˆ˜ì£¼ ê¸ˆì•¡',
	            width: 600,
	            height: 500
	        },
	        tooltip: {
	            formatter: (value) => `â‚©${value.toLocaleString()}`
	        },
	        legend: {
	            align: 'bottom'
	        }
	    };

	    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.pieChart({ el, data, options });
	}

	// ë°œì£¼ íƒ­ ë
	
	
	
	
	
	
	// ì¶œí•˜ íƒ­ ì‹œì‘
	function make_shipment_grid(startDt, endDt) {
	    if (shipment_grid) {
	        load_shipment_data(startDt, endDt);  // ë°ì´í„°ë§Œ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_SHIPMENT_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (shipment_grid) {
	                shipment_grid.resetData(response);
	                return;
	            }

	            shipment_grid = new tui.Grid({
	                el: document.getElementById('shipment_grid'),
	                data: response, // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ì¼ì', name: 'contract_ed', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ê¸ˆì•¡', name: 'contract_mn', align: 'center', sortable: true }
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                        contract_am: {
	                        	template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ê°œ</div>`
	                        },
	                        contract_mn: {
	                        	template: (valueMap) => `<div style="text-align: center;">ì´ ${valueMap.sum} ì›</div>`
	                        },
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ì¶œí•˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	function load_shipment_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_SHIPMENT_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (shipment_grid) {
	                shipment_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ì¶œí•˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}


	function fetchDataAndRenderShipmentChart(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken // CSRF í† í° í—¤ë” ì¶”ê°€
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);
	
	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }
	
	            const productMap = {};
	            const categories = new Set();
	
	            response.forEach(item => {
	                const productKey = `${item.product_nm} (${item.product_sz}/${item.product_cr})`; // ì œí’ˆëª… (ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ)
	                const date = item.contract_sd;   // ê³„ì•½ ë‚ ì§œ
	                const amount = Number(item.product_am); // ê³„ì•½ ìˆ˜ëŸ‰ (ìˆ«ìë¡œ ë³€í™˜)
	
	                categories.add(date);
	
	                if (!productMap[productKey]) {
	                    productMap[productKey] = [];
	                }
	                productMap[productKey].push({ date, amount });
	            });
	
	            const sortedCategories = Array.from(categories).sort();
	
	            const seriesData = Object.keys(productMap).map(productKey => {
	                const dataArr = sortedCategories.map(date => {
	                    const found = productMap[productKey].find(d => d.date === date);
	                    return found ? found.amount : 0;
	                });
	
	                return { name: productKey, data: dataArr };
	            });
	
	            const data = {
	                categories: sortedCategories,
	                series: seriesData
	            };
	
	            console.log("ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderShipmentChart(data, chartId); // ğŸ”¹ ë³€í™˜ëœ ë°ì´í„° ì „ë‹¬
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}

	function renderShipmentChart(response, chartId) {
	    const data = {
	        categories: response.categories,
	        series: response.series
	    };
	
	    const options = {
	        chart: {
	            title: 'ì¶œí•˜ ì œí’ˆ ìˆ˜ëŸ‰',
	            width: 800,
	            height: 500
	        },
	        xAxis: {
	            title: 'ì¶œí•˜ëŸ‰',
	            type: 'category'
	        },
	        yAxis: {
	            title: 'ì¶œí•˜ ë‚ ì§œ'
	        },
	        series: {
	            stack: false // ëˆ„ì  ê·¸ë˜í”„ ë¹„í™œì„±í™” (ê° ì œí’ˆ ê°œë³„ í‘œì‹œ)
	        },
	        tooltip: {
	            formatter: (value) => `${value} ê°œ`
	        }
	    };
	
	    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.barChart({ el, data, options });
	}
	

	function fetchDataAndRenderShipmentPieChart(url, chartId, startDt, endDt) {
	    $.ajax({
	        url: url,
	        method: 'GET',
	        headers: {
	            [csrfHeader]: csrfToken // CSRF í† í° í—¤ë” ì¶”ê°€
	        },
	        data: { start_dt: startDt, end_dt: endDt },
	        success: function (response) {
	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:", response);

	            if (!response || response.length === 0) {
	                console.warn("ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŒ");
	                Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	                return;
	            }

	            const seriesData = response.map(item => ({
	                name: `${item.product_nm} (${item.product_sz}/${item.product_cr})`,
	                data: Number(item.total_price)
	            }));

	            const data = {
	                series: seriesData
	            };

	            console.log("ìˆ˜ì£¼ ê¸ˆì•¡ íŒŒì´ ì°¨íŠ¸ ë Œë”ë§ ë°ì´í„°:", data);
	            renderShipmentAmountPieChart(data, chartId);
	        },
	        error: function (xhr, status, error) {
	            console.error('Error fetching data:', error);
	            Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	        }
	    });
	}

	function renderShipmentAmountPieChart(response, chartId) {
	    const data = {
	        series: response.series
	    };

	    const options = {
	        chart: {
	            title: 'ì œí’ˆë³„ ìˆ˜ì£¼ ê¸ˆì•¡',
	            width: 600,
	            height: 500
	        },
	        tooltip: {
	            formatter: (value) => `â‚©${value.toLocaleString()}`
	        },
	        legend: {
	            align: 'bottom'
	        }
	    };

	    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
	    $(`#${chartId}`).empty();
	    const el = document.getElementById(chartId);
	    toastui.Chart.pieChart({ el, data, options });
	}
	// ì¶œí•˜ íƒ­ ë
	
</script>

</html>