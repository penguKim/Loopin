<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{layout}" 
				layout:fragment="content">
				
<style>
.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>				
				
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title">ì¸ì‚¬í˜„í™©</h5>
							<div class="d-flex justify-content-between">
								<div>
									<ul class="nav nav-pills mb-3" id="business-tab" role="tablist">
										<li class="nav-item" role="presentation">
											<button class="nav-link active" id="btn_contract_tab" data-bs-toggle="pill" data-bs-target="#tab_contract" 
											type="button" role="tab" aria-controls="tab_contract" aria-selected="false">ìˆ˜ì£¼</button>
										</li>
										<li class="nav-item" role="presentation">
											<button class="nav-link" id="btn_order_tab" data-bs-toggle="pill" data-bs-target="#tab_order" 
											type="button" role="tab" aria-controls="tab_order" aria-selected="true">ë°œì£¼</button>
										</li>
										<li class="nav-item" role="presentation">
											<button class="nav-link" id="btn_shipment_tab" data-bs-toggle="pill" data-bs-target="#tab_shipment" 
											type="button" role="tab" aria-controls="tab_shipment" aria-selected="true">ì¶œí•˜</button>
										</li>
									</ul>
								</div>
							</div>
							<div class="row mb-3 align-items-end">
							    <div class="col-md-2">
							        <label for="start_dt" class="form-label">ì‹œì‘ì¼</label>
							        <input type="text" class="form-control" id="start_dt" name="start_dt" aria-label="Date">
							        <div id="startpicker-container"></div>
							    </div>
							    <div class="col-md-2">
							        <label for="end_dt" class="form-label">ì¢…ë£Œì¼</label>
							        <input type="text" class="form-control" id="end_dt" name="end_dt" aria-label="Date">
							        <div id="endpicker-container"></div>
							    </div>
							
							    <!-- ì¡°íšŒ ë²„íŠ¼ì„ ì…ë ¥ í•„ë“œì™€ ê°™ì€ ë†’ì´ì— ë°°ì¹˜ -->
							    <div class="col-md-3 d-flex align-items-end">
							        <button type="button" class="btn btn-primary" id="search-btn">ì¡°íšŒ</button>
							    </div>
							</div>

							<!-- ê·¸ë¦¬ë“œ -->
							<div class="row mb-3">
							    <div class="col-sm-12">
							        <div id="contract_grid" class="grid-container"></div>
							        <div id="order_grid" class="grid-container" style="display: none;"></div>
							        <div id="shipment_grid" class="grid-container" style="display: none;"></div>
							    </div>
							</div>
							<div class="row mb-3">
								<div class="col-sm-6">
									<div id="chart-posi"></div>
								</div>
								<div class="col-sm-6">
									<div id="chart-hdrd"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>

<script th:inline="javascript">
	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	
	const btn_contract_tab = $('#btn_contract_tab');
	const btn_order_tab = $('#btn_order_tab');
	const btn_shipment_tab = $('#btn_shipment_tab');
	
	let contract_grid;
	let order_grid;
	let shipment_grid;
	
	$(function () {
	    tui.Grid.setLanguage('ko');
	    tui.Grid.applyTheme('striped');

	    // 1ê°œì›” ì „ê³¼ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
	    const today = new Date();
	    const oneMonthAgo = new Date();
	    oneMonthAgo.setMonth(today.getMonth() - 1);

	    // DatePicker ê°ì²´ ìƒì„±
	    const rangePicker = tui.DatePicker.createRangePicker({
	        startpicker: {
	            date: oneMonthAgo,
	            input: '#start_dt',
	            container: '#startpicker-container',
	        },
	        endpicker: {
	            date: today,
	            input: '#end_dt',
	            container: '#endpicker-container',
	            disabled: false,
	        },
	        format: 'yyyy-MM-dd',
	        timePicker: false
	    });

		// ğŸ“Œ íƒ­ í´ë¦­ ì´ë²¤íŠ¸ - ì„ íƒëœ íƒ­ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ ë¶ˆëŸ¬ì˜¤ê¸°
		function loadGridByTab(gridType) {
		    $('.grid-container').hide(); // ëª¨ë“  ê·¸ë¦¬ë“œ ìˆ¨ê¹€
		    const startDt = rangePicker.getStartDate() ? rangePicker.getStartDate().toISOString().split('T')[0] : null;
		    const endDt = rangePicker.getEndDate() ? rangePicker.getEndDate().toISOString().split('T')[0] : null;

		    console.log(`íƒ­ í´ë¦­: ${gridType} | ì‹œì‘ì¼: ${startDt}, ì¢…ë£Œì¼: ${endDt}`);

		    if (!startDt || !endDt) {
		        alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		        return;
		    }

		    if (gridType === 'contract') {
		        $('#contract_grid').show();
		        make_contract_grid(startDt, endDt);
		    } else if (gridType === 'order') {
		        $('#order_grid').show();
		        make_order_grid(startDt, endDt);
		    } else if (gridType === 'shipment') {
		        $('#shipment_grid').show();
		        make_shipment_grid(startDt, endDt);
		    }
		}

		$('#btn_contract_tab').on('click', function () {
		    loadGridByTab('contract');
		});

		$('#btn_order_tab').on('click', function () {
		    loadGridByTab('order');
		});

		$('#btn_shipment_tab').on('click', function () {
		    loadGridByTab('shipment');
		});
		
		
		$('#search-btn').on('click', function () {
		    const startDt = rangePicker.getStartDate() ? rangePicker.getStartDate().toISOString().split('T')[0] : null;
		    const endDt = rangePicker.getEndDate() ? rangePicker.getEndDate().toISOString().split('T')[0] : null;

		    console.log("ì¡°íšŒ ë²„íŠ¼ í´ë¦­: ì‹œì‘ì¼ =", startDt, "ì¢…ë£Œì¼ =", endDt);

		    if (!startDt || !endDt) {
		        alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		        return;
		    }

		    make_contract_grid(startDt, endDt);
		    make_order_grid(startDt, endDt);
		    make_shipment_grid(startDt, endDt);
		});

		// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
		make_contract_grid(
		    rangePicker.getStartDate() ? rangePicker.getStartDate().toISOString().split('T')[0] : null, 
		    rangePicker.getEndDate() ? rangePicker.getEndDate().toISOString().split('T')[0] : null
		);

	});



	function make_contract_grid(startDt, endDt) {
	    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šê³  ë°ì´í„°ë§Œ ê°±ì‹ 
		console.log("ì „ì†¡ ë°ì´í„°:", startDt, endDt);
	    if (contract_grid) {
	        load_contract_data(startDt, endDt);  // ë°ì´í„° ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_CONTRACT_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (contract_grid) {
	                contract_grid.resetData(response);
	                return;
	            }
	            contract_grid = new tui.Grid({
	                el: document.getElementById('contract_grid'),
	                data: response, // ì§ì ‘ ë°ì´í„° ì „ë‹¬
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
	                    { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ì¼ì', name: 'contract_sd', align: 'center', sortable: true },
	                    { header: 'ë‚©ê¸°ì¼', name: 'contract_ed', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true },
	                    { header: 'ìˆ˜ì£¼ê¸ˆì•¡', name: 'contract_mn', align: 'center', formatter: ({ value }) => `â‚©${value.toLocaleString()}`}
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                        contract_mn: {
	                            template: (valueMap) => `ì´ ${valueMap.cnt} ê±´`
	                        }
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ìˆ˜ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	function load_contract_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_CONTRACT_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (contract_grid) {
	                contract_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ìˆ˜ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}


	
	function make_order_grid(startDt, endDt) {
	    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ê°±ì‹ 
		console.log("ì „ì†¡ ë°ì´í„°:", startDt, endDt);
	    if (order_grid) {
	        load_order_data(startDt, endDt);  // ë°ì´í„°ë§Œ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_ORDER_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (order_grid) {
	                order_grid.resetData(response);
	                return;
	            }

	            order_grid = new tui.Grid({
	                el: document.getElementById('order_grid'),
	                data: response, // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ë°œì£¼ë²ˆí˜¸', name: 'order_cd', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ë²ˆí˜¸', name: 'account_cd', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ì¼ì', name: 'order_sd', align: 'center', sortable: true },
	                    { header: 'ì…ê³ ì¼ì', name: 'order_ed', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ìˆ˜ëŸ‰', name: 'order_am', align: 'center', sortable: true },
	                    { header: 'ë°œì£¼ê¸ˆì•¡', name: 'order_mn', align: 'center', formatter: ({ value }) => `â‚©${value.toLocaleString()}`},
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                        order_mn: {
	                            template: (valueMap) => `ì´ ${valueMap.cnt} ê±´`
	                        }
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ë°œì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	function load_order_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_ORDER_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (order_grid) {
	                order_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ë°œì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}

	
	function make_shipment_grid(startDt, endDt) {
	    if (shipment_grid) {
	        load_shipment_data(startDt, endDt);  // ë°ì´í„°ë§Œ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
	        return;
	    }

	    $.ajax({
	        url: '/select_SHIPMENT_STATE',
			data: { start_dt: startDt, end_dt: endDt }, 
	        method: 'GET',
	        success: function (response) {
	            if (shipment_grid) {
	                shipment_grid.resetData(response);
	                return;
	            }

	            shipment_grid = new tui.Grid({
	                el: document.getElementById('shipment_grid'),
	                data: response, // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
	                scrollX: true,
	                scrollY: true,
	                autoWidth: true,
	                rowHeight: 'auto',
	                bodyHeight: 'fitToParent',
	                zIndex: 100,
	                columns: [
	                    { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ì¼ì', name: 'contract_sd', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ì¼ì', name: 'contract_ed', align: 'center', sortable: true },
	                    { header: 'ì¶œí•˜ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true }
	                ],
	                summary: {
	                    height: 40,
	                    position: 'bottom', 
	                    columnContent: {
	                        contract_am: {
	                            template: (valueMap) => `ì´ ${valueMap.cnt} ê±´`
	                        }
	                    }
	                }
	            });
	        },
	        error: function (error) {
	            console.error('ì¶œí•˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	function load_shipment_data(startDt, endDt) {
	    $.ajax({
	        url: '/select_SHIPMENT_STATE',
	        method: 'GET',
			data: { start_dt: startDt, end_dt: endDt }, 
	        success: function(response) {
	            if (shipment_grid) {
	                shipment_grid.resetData(response);
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error("ì¶œí•˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", xhr.status, error);
	        }
	    });
	}

	
	
</script>

</html>