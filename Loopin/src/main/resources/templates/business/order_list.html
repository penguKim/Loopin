<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<style>
.col1 {
	width: 160px !important;
	position: relative;
	z-index: 9998;
	margin-right: 5px;
}

.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-timepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>
<body>
	<main id="main" class="main">
	    <div class="pagetitle"></div>
	    <section class="section">
			<!-- 상단 필터 영역 -->
			<div class="row mb-3">
			    <div class="col-12">
			        <div class="card">
			            <div class="card-body">
			                <h5 class="card-title">필터</h5>
			                <div id="filterModule"></div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">발주 등록</h5>
	                            <div>
	                                <input type="button" id="btn_open_modal" class="btn btn-primary" value="등록">
	                                <input type="button" id="btn_group_remove" class="btn btn-primary" value="삭제">
	                            </div>
	                        </div>
							<div class="col-sm-12">
		                        <!-- 발주 등록 그리드 -->
		                        <div id="order_grid"></div>
							</div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">발주 상세</h5>
	                        </div>
	                        <!-- 발주 상세 그리드 -->
	                        <div id="detail_grid"></div>
			            </div>
			        </div>
			    </div>
			</div>
	    </section>
	</main>
</body>

<script>
    $(document).ready(function () {
        // 발주 등록 모달 트리거
		$('#btn_open_modal').on('click', function () {
		    openModal();
		});

		// 동적 모달 생성 및 표시
		function openModal() {
		    // 기존 모달 제거
		    $('#orderInsertModal').remove();

		    // 모달 HTML 생성
		    const modalHTML = `
		        <div class="modal" id="orderInsertModal" tabindex="-1" aria-labelledby="orderInsertModalLabel" aria-hidden="true">
		            <div class="modal-dialog modal-dialog-centered modal-xl">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title" id="dynamicModalLabel">발주 등록</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		                    </div>
		                    <div class="modal-body">
		                        <form id="appointment_form" method="post" enctype="multipart/form-data">
		                            <input type="hidden" id="order_cd" name="order_cd">
		                            <div class="row mb-3">
		                                <div class="col-md-4">
		                                    <label for="order_ps" class="form-label">담당자명</label>
		                                    <input type="text" class="form-control" id="order_ps" name="order_ps">
		                                </div>
		                                <div class="col-md-4">
		                                    <label for="account_sd" class="form-label">발주일자</label>
		                                    <input type="text" class="form-control" id="order_sd" name="account_sd">
		                                    <div id="modal_startpicker-container"></div>
		                                </div>
		                                <div class="col-md-4">
		                                    <label for="account_ed" class="form-label">입고일자</label>
		                                    <input type="text" class="form-control" id="order_ed" name="account_ed">
		                                    <div id="modal_endpicker-container"></div>
		                                </div>
		                            </div>
		                            <div class="row mb-3">
		                                <div class="col-md-3">
		                                    <label for="account_cp" class="form-label">거래처코드</label>
		                                    <input type="text" class="form-control" id="account_cd" name="account_cp">
		                                </div>
										<div class="col-md-3">
										    <label for="order_st" class="form-label">발주상태</label>
										    <input type="text" class="form-control" id="order_st" name="order_st" readonly>
										</div>
										<div class="col-md-3">
										    <label for="order_am" class="form-label">발주수량</label>
										    <input type="text" class="form-control" id="order_am" name="order_am" readonly>
										</div>
										<div class="col-md-3">
										    <label for="order_mn" class="form-label">발주금액</label>
										    <input type="text" class="form-control" id="order_mn" name="order_mn" readonly>
										</div>
										<div class="col-sm-12">
											<label for="order_rm" class="form-label">비고</label>
											<textarea class="form-control" id="order_rm" name="order_rm" style="height: 200px"></textarea>
										</div>
		                            </div>
		                            <div class="row mb-3">
		                                <div class="col-sm-12 text-end">
		                                    <button type="button" id="addProductBtn" class="btn btn-primary">추가</button>
											<button type="button" id="deleteProductBtn" class="btn btn-danger">행 삭제</button>
		                                </div>
		                            </div>
		                            <div class="row">
		                                <div id="productGrid"></div>
		                            </div>
		                        </form>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="submit" class="btn btn-primary" form="appointment_form">등록</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    // 모달을 body에 추가
		    $('body').append(modalHTML);

		    // Toast UI Grid 초기화
		    const productGrid = new tui.Grid({
		        el: document.getElementById('productGrid'),
		        data: [],
		        columns: [
		            { header: '원자재코드', name: 'material_cd', align: 'center' },
		            { header: '원자재명', name: 'material_nm', align: 'center' },
		            { header: '수량', name: 'order_am', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
		            { header: '단가', name: 'order_ct', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false
		    });

		    // DatePicker 초기화
		    initializeDatePickers();

		    // Bootstrap 모달 표시
		    const modalInstance = new bootstrap.Modal(document.getElementById('orderInsertModal'));
		    modalInstance.show();

			// 행 삭제 버튼 클릭 이벤트
			$('#deleteProductBtn').on('click', function () {
			    const checkedRowKeys = productGrid.getCheckedRowKeys(); // 체크된 행의 rowKey 가져오기
			    if (checkedRowKeys.length > 0) {
			        productGrid.removeRows(checkedRowKeys); // 체크된 행 삭제
			        updateOrderSummary(productGrid); // 발주수량 및 발주금액 업데이트
			    } else {
			        showAlert(null, "error", "삭제 실패 알림", "삭제할 행을 선택해주세요");
			    }
			});
			
			
			// Toast UI Grid 데이터 변경 시 발주수량 및 발주금액 업데이트
			productGrid.on('afterChange', function (ev) {
			    updateOrderSummary(productGrid);
			});

			// 발주수량 및 발주금액 업데이트 함수
			function updateOrderSummary(grid) {
			    const data = grid.getData();
			    let totalQty = 0;
			    let totalAmount = 0;

			    data.forEach(row => {
			        const qty = parseFloat(row.order_am) || 0;
			        const money = parseFloat(row.order_ct) || 0;

			        totalQty += qty;
			        totalAmount += qty * money;
			    });

			    $('#order_am').val(totalQty);
			    $('#order_mn').val(totalAmount.toLocaleString()); // 천 단위 구분
			}
			
			
			
		    // "추가" 버튼 클릭 시 제품 선택 모달 열기
		    $('#addProductBtn').on('click', function () {
		        openProductModal(productGrid);
		    });

		    // 폼 submit 이벤트 처리
		    $('#appointment_form').on('submit', function (event) {
		        event.preventDefault();

		        const formData = productGrid.getData(); // Grid 데이터 가져오기
		        console.log('등록 데이터:', formData);

		        // AJAX 요청으로 데이터 전송
		        $.ajax({
		            url: '/your-server-endpoint',
		            method: 'POST',
		            data: { products: formData },
		            success: function () {
		                alert('등록 성공!');
		                modalInstance.hide();
		            },
		            error: function () {
		                alert('등록 실패. 다시 시도해주세요.');
		            }
		        });
		    });
		}

		// DatePicker 초기화 함수
		function initializeDatePickers() {
		    const today = new Date(); // 오늘 날짜

		    // 시작일과 종료일 DatePicker 초기화
		    const startPicker = tui.DatePicker.createRangePicker({
		        startpicker: {
		            date: today,
		            input: '#order_sd',
		            container: '#modal_startpicker-container',
		        },
		        endpicker: {
		            date: null,
		            input: '#order_ed',
		            container: '#modal_endpicker-container',
		            disabled: true,
		        },
		        format: 'YYYY-MM-dd',
		        timePicker: false,
		    });

		    // 종료일 필드 초기화 및 비활성화
		    $('#order_ed').val('').prop('disabled', true);

		    // 시작일 선택 이벤트 처리
		    startPicker.on('change:start', function (event) {
		        if (event && event.date) {
		            console.log('선택된 시작일: ', event.date);

		            const minEndDate = new Date(event.date);
		            minEndDate.setDate(minEndDate.getDate() + 1);

		            startPicker.getEndpicker().setOptions({
		                date: minEndDate,
		                disabled: false,
		            });

		            $('#order_ed').prop('disabled', false);
		        }
		    });

		    // 종료일 선택 이벤트 처리
		    startPicker.on('change:end', function (event) {
		        if (event && event.date) {
		            console.log('선택된 종료일: ', event.date);
		        }
		    });
		}


        // 제품 선택 모달 생성
		function openProductModal(productGrid) {
		    $('#productSelectModal').remove();
		    const productModalHTML = `
		        <div class="modal" id="productSelectModal" tabindex="-1">
		            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title">제품 선택</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		                    </div>
		                    <div class="modal-body">
		                        <div id="productSelectGrid"></div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="button" class="btn btn-primary" id="selectProductBtn">추가</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    $('body').append(productModalHTML);

		    const productData = [
		        { material_cd: 'OD001', material_nm: '가죽1' },
		        { material_cd: 'OD002', material_nm: '가죽2' },
		        { material_cd: 'OD003', material_nm: '고무1' },
		        { material_cd: 'OD004', material_nm: '고무2' }
		    ];

		    const productSelectGrid = new tui.Grid({
		        el: document.getElementById('productSelectGrid'),
		        data: productData,
		        columns: [
		            { header: '원자재코드', name: 'material_cd', align: 'center' },
		            { header: '원자재명', name: 'material_nm', align: 'center' }
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false
		    });

			const productModal = new bootstrap.Modal(document.getElementById('productSelectModal'), {
			    backdrop: false,    // 추가적인 배경 방지
			    keyboard: false     // ESC 키로 닫기 방지 (옵션)
			});

		    productModal.show();

		    // "추가" 버튼 클릭 시 선택 데이터 처리
			$('#selectProductBtn').on('click', function () {
			    const selectedRows = productSelectGrid.getCheckedRows();

			    if (selectedRows.length > 0) {
			        const existingData = productGrid.getData();
			        const newRows = [];
			        let shouldCloseModal = true; // 모달을 닫을지 여부

			        selectedRows.forEach(row => {
			            const isDuplicate = existingData.some(existingRow => existingRow.material_cd === row.material_cd);
			            if (!isDuplicate) {
			                newRows.push(row);
			            } else {
			                alert(`이미 등록된 제품입니다: ${row.product_cd}`);
			                shouldCloseModal = false; // 중복 제품이 있으면 모달을 닫지 않음
			            }
			        });

			        if (newRows.length > 0) {
			            productGrid.resetData([...existingData, ...newRows]);

			            // 첫 번째 새로 추가된 행의 수량 셀에 포커스 이동
			            const rowIndex = existingData.length;
			            productGrid.focus(rowIndex, 'order_am');
			            productGrid.startEditing(rowIndex, 'order_am');
			        }

			        // 중복된 제품이 없을 때만 모달 닫기
			        if (shouldCloseModal) {
			            productModal.hide();
			        }
			    } else {
			        alert('추가할 제품을 선택하세요.');
			    }
			});

		}

    });
</script>


<script th:inline="javascript">
    // 변수 지정
    let order_grid;
    let detail_grid;
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    $(function () {
        // 필터 설정
        const filterConfig = [
            { key: 'startDate', label: '조회기간 시작일', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'endDate', label: '조회기간 종료일', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'order_cd', label: '발주번호', type: 'text', placeholder: '발주번호 입력', col: 'col-2' },
            { key: 'account_cd', label: '거래처코드', type: 'text', placeholder: '거래처코드 입력', col: 'col-2' },
            { key: 'order_ps', label: '담당자명', type: 'text', placeholder: '담당자명 입력', col: 'col-2' },
        ];

        // 필터 모듈 초기화
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            console.log('적용된 필터:', filterValues);

            // 서버 요청 및 그리드 갱신
            fetch('/select_FILTERED_ORDER', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token, // CSRF 토큰
                },
                body: JSON.stringify(filterValues)
            })
            .then(response => response.json())
            .then(filteredData => {
                console.log('필터링된 데이터:', filteredData);
                order_grid.resetData(filteredData); // 그리드 데이터 갱신
            })
            .catch(error => console.error('필터 적용 오류:', error));
        });

        // 상단(Order Grid) 생성
        make_order_grid();
        // 하단(Detail Grid) 생성
        make_detail_grid();
    });

	
    // 상단(Order Grid) 생성 함수
    function make_order_grid() {
        const dataSource = {
            api: {
                readData: { url: '/select_order_code', method: 'GET' },
            }
        };

        order_grid = new tui.Grid({
            el: document.getElementById('order_grid'),
            data: dataSource,
            scrollX: false,
            scrollY: false,
            rowHeaders: [
                { type: 'rowNum' },
                { type: 'checkbox' },
            ],
            selectionUnit: 'row',
			bodyHeight: 100, // 고정 높이 설정
            columns: [
                { header: '발주일자', name: 'order_sd', align: 'center', sortable: true },
                { header: '발주번호', name: 'order_cd', align: 'center', sortable: true },
                { header: '거래처코드', name: 'account_cd', align: 'center', sortable: true },
                { header: '발주수량', name: 'order_am', align: 'center', sortable: true },
                { header: '발주예정일', name: 'order_ed', align: 'center', sortable: true },
                { header: '발주상태', name: 'order_st', align: 'center', sortable: true },
            ]
        });
    }

    // 하단(Detail Grid) 생성 함수
    function make_detail_grid() {
        detail_grid = new tui.Grid({
            el: document.getElementById('detail_grid'),
            data: [],
            scrollX: false,
            scrollY: false,
            rowHeaders: [
                { type: 'rowNum' },
                { type: 'checkbox' },
            ],
            selectionUnit: 'row',
			bodyHeight: 200, // 고정 높이 설정
            columns: [
                { header: '발주번호', name: 'order_cd', sortable: true, editor: 'text' },
                { header: '원자재코드', name: 'material_cd', sortable: true, editor: 'text' },
                { header: '원자재명', name: 'material_nm', sortable: true, align: 'center', editor: 'text' },
                { header: '발주수량', name: 'order_am', sortable: true, editor: 'text' },
                { header: '기준단위', name: 'product_un', sortable: true, editor: 'text' },
                { header: '납기일', name: 'order_ed', sortable: true, editor: 'text' }
            ]
        });
    }
</script>

</html>
