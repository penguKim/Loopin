<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<style>
.col1 {
	width: 160px !important;
	position: relative;
	z-index: 9998;
	margin-right: 5px;
}

.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-timepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>
<body>
	<main id="main" class="main">
	    <div class="pagetitle"></div>
	    <section class="section">
			<!-- ìƒë‹¨ í•„í„° ì˜ì—­ -->
			<div class="row mb-3">
			    <div class="col-12">
			        <div class="card">
			            <div class="card-body">
			                <h5 class="card-title">í•„í„°</h5>
			                <div id="filterModule"></div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">ìˆ˜ì£¼ ë“±ë¡</h5>
	                            <div>
									<button type="button" class="btn btn-primary" id="btn_contract_create" onclick="openModal('add')">ë“±ë¡</button>
									<button type="button" class="btn btn-primary" id="btn_contract_delete">ì‚­ì œ</button>
	                            </div>
	                        </div>
							<div class="col-sm-12">
		                        <!-- ìˆ˜ì£¼ ë“±ë¡ ê·¸ë¦¬ë“œ -->
		                        <div id="contract_grid"></div>
							</div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">ìˆ˜ì£¼ ìƒì„¸</h5>
	                        </div>
	                        <!-- ìˆ˜ì£¼ ìƒì„¸ ê·¸ë¦¬ë“œ -->
	                        <div id="detail_grid"></div>
			            </div>
			        </div>
			    </div>
			</div>
	    </section>
	</main>
</body>

<script>
	// ìˆ˜ì£¼ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ìˆ˜ì • ëª¨ë“œì—ì„œ ì‚¬ìš©)
	function fetchContractDetails(contract_cd) {
	    console.log(`ğŸ” fetchContractDetails í˜¸ì¶œ: contract_cd=${contract_cd}`); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
		
		if (!contract_cd) {
		    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ contract_cdì…ë‹ˆë‹¤:", contract_cd);
		    return;
		}
		
	    $.ajax({
	        url: `/get_CONTRACT?contract_cd=${contract_cd}`,
	        method: 'GET',
	        success: function (response) {
	            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response); // ì‘ë‹µ ë°ì´í„° í™•ì¸

				// ìˆ˜ì£¼ ë°ì´í„° ê²€ì¦
				if (!response || !response.contract || !response.contract.contract_cd) {
				    console.error("ì‘ë‹µ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", response);
				    Swal.fire({
				        icon: 'error',
				        title: 'ì˜¤ë¥˜ ë°œìƒ!',
				        text: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
				        confirmButtonText: 'í™•ì¸'
				    });
				    return;
				}
				
				// ìˆ˜ì£¼ ë°ì´í„°ì™€ ìƒì„¸ ë°ì´í„° ì „ë‹¬í•˜ì—¬ ëª¨ë‹¬ ì—´ê¸°
				openModal('edit', response);
	        },
	        error: function (xhr) {
				window.isFetchingDetails = false; // í”Œë˜ê·¸ í•´ì œ
	            console.error("ì„œë²„ ìš”ì²­ ì˜¤ë¥˜:", xhr.status, xhr.responseText);
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ!',
	                text: 'ìˆ˜ì£¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });
	}

		
		
	// ë™ì  ëª¨ë‹¬ ìƒì„± ë° í‘œì‹œ
	function openModal(mode, rowData = null) {
		
		console.log("openModal í˜¸ì¶œë¨", "mode:", mode, "rowData:", rowData);
		
		// ìˆ˜ì • ëª¨ë“œì—ì„œ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
		if (mode === 'edit') {
			if (!rowData || !rowData.contract || !rowData.contract.contract_cd) {
			    console.error("rowDataê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ contract_cdê°€ ì—†ìŠµë‹ˆë‹¤.", rowData);
			    Swal.fire({
			        icon: 'error',
			        title: 'ì˜¤ë¥˜ ë°œìƒ!',
			        text: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
			        confirmButtonText: 'í™•ì¸'
			    });
			    return;
			}
		}

		console.log("ëª¨ë‹¬ ì´ˆê¸°í™” ì„±ê³µ:", rowData);

	    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
	    $('#contractInsertModal').remove();

				// ëª¨ë‹¬ ì œëª© ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		const modalTitle = mode === 'edit' ? 'ìˆ˜ì£¼ ìˆ˜ì •' : 'ìˆ˜ì£¼ ë“±ë¡';
		const submitButtonText = mode === 'edit' ? 'ìˆ˜ì •' : 'ë“±ë¡';
			
	    // ëª¨ë‹¬ HTML ìƒì„±
	    const modalHtml = `
	        <div class="modal" id="contractInsertModal" tabindex="-1" aria-labelledby="contractInsertModalLabel" aria-hidden="true">
	            <div class="modal-dialog modal-dialog-centered modal-xl">
	                <div class="modal-content">
	                    <div class="modal-header">
	                        <h5 class="modal-title" id="dynamicModalLabel">${modalTitle}</h5>
	                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	                    </div>
	                    <div class="modal-body">
	                        <form id="appointment_form" method="post" enctype="multipart/form-data">
	                            <input type="hidden" id="contract_cd" name="contract_cd">
	                            <div class="row mb-3">
	                                <div class="col-md-4">
	                                    <label for="contract_ps" class="form-label">ë‹´ë‹¹ìëª…</label>
	                                    <input type="text" class="form-control" id="contract_ps" name="contract_ps">
	                                </div>
	                                <div class="col-md-4">
	                                    <label for="account_sd" class="form-label">ìˆ˜ì£¼ì¼</label>
	                                    <input type="text" class="form-control" id="contract_sd" name="account_sd" readonly>
	                                    <div id="modal_startpicker-container"></div>
	                                </div>
	                                <div class="col-md-4">
	                                    <label for="account_ed" class="form-label">ë‚©ê¸°ì¼</label>
	                                    <input type="text" class="form-control" id="contract_ed" name="account_ed" readonly>
	                                    <div id="modal_endpicker-container"></div>
	                                </div>
	                            </div>
	                            <div class="row mb-3">
	                                <div class="col-md-3">
	                                    <label for="account_cp" class="form-label">ê±°ë˜ì²˜ì½”ë“œ</label>
	                                    <input type="text" class="form-control" id="account_cd" name="account_cd" readonly>
	                                </div>
									<div class="col-md-3">
	                                    <label for="contract_st" class="form-label">ìˆ˜ì£¼ìƒíƒœ</label>
	                                    <select class="form-select" id="contract_st" name="contract_st">
	                                        <option value="">ì„ íƒ</option>
	                                    </select>
									</div>
									<div class="col-md-3">
									    <label for="contract_am" class="form-label">ìˆ˜ì£¼ìˆ˜ëŸ‰</label>
									    <input type="text" class="form-control" id="contract_am" name="contract_am" readonly>
									</div>
									<div class="col-md-3">
									    <label for="contract_mn" class="form-label">ìˆ˜ì£¼ê¸ˆì•¡</label>
									    <input type="text" class="form-control" id="contract_mn" name="contract_mn" readonly>
									</div>
									<div class="col-sm-12">
									    <label for="contract_rm" class="form-label">ë¹„ê³ </label>
										<textarea class="form-control" id="contract_rm" name="contract_rm" style="height: 200px"></textarea>
									</div>
	                            </div>
	                            <div class="row mb-3">
	                                <div class="col-sm-12 text-end">
	                                    <button type="button" id="addProductBtn" class="btn btn-primary">ì¶”ê°€</button>
										<button type="button" id="deleteProductBtn" class="btn btn-danger">í–‰ ì‚­ì œ</button>
	                                </div>
	                            </div>
	                            <div class="row">
	                                <div id="productGrid"></div>
	                            </div>
	                        </form>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	                        <button type="button" class="btn btn-primary" id="modal_submit_button">${submitButtonText}</button>
	                    </div>
	                </div>
	            </div>
	        </div>`;

	    var status_list = window.status_list || [];

		// ëª¨ë‹¬ HTMLì„ ë™ì ìœ¼ë¡œ bodyì— ì¶”ê°€
		document.body.insertAdjacentHTML('beforeend', modalHtml);

		// ëª¨ë‹¬ì´ ì¶”ê°€ëœ í›„ ì‹¤í–‰
		const modalElement = document.getElementById('contractInsertModal');
		if (!modalElement) {
		    console.error("ëª¨ë‹¬ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
		    return;
		}
		
	    
		// ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê´€ë ¨ í•¨ìˆ˜
		function populateSelectOptions(selectId, dataList) {
		    const selectElement = document.getElementById(selectId);
		    if (Array.isArray(dataList) && dataList.length > 0) {
		        dataList.forEach(item => {
		            const option = document.createElement('option');
		            option.value = item.common_cc;
		            option.textContent = item.common_nm;
		            selectElement.appendChild(option);
		        });
		    }
		}

		// ê±°ë˜ì²˜ êµ¬ë¶„ (contract_st) ì˜µì…˜ ì¶”ê°€
		populateSelectOptions('contract_st', window.status_list);
		    
	    // Bootstrap ëª¨ë‹¬ í‘œì‹œ
	    const modalInstance = new bootstrap.Modal(document.getElementById('contractInsertModal'));
	    modalInstance.show();
		    
	    // Toast UI Grid ì´ˆê¸°í™”
	    const productGrid = new tui.Grid({
	        el: document.getElementById('productGrid'),
	        data: [],
	        columns: [
	            { header: 'ì œí’ˆì½”ë“œ', name: 'product_cd', align: 'center' },
	            //{ header: 'ì œí’ˆëª…', name: 'product_nm', align: 'center' },
	            { header: 'ìƒ‰ìƒ', name: 'product_cr', align: 'center' },
	            { header: 'ì‚¬ì´ì¦ˆ', name: 'product_sz', align: 'center' },
	            { header: 'ê¸°ì¤€ë‹¨ìœ„', name: 'product_un', align: 'center' },
	            { header: 'ìˆ˜ëŸ‰', name: 'product_am', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
	            { header: 'ë‹¨ê°€', name: 'contract_ct', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
	        ],
	        rowHeaders: ['checkbox'],
	        scrollX: false,
	        scrollY: false
	    });

	    // DatePicker ì´ˆê¸°í™”
	    initializeDatePickers();
		
		// ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš°, ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
//		if (mode === 'edit' && rowData && rowData.contract_cd) {
//		    fetchContractDetails(rowData.contract_cd);
//		}
			
		// ìˆ˜ì • ëª¨ë“œ ë°ì´í„° ë°˜ì˜
		if (mode === 'edit' && rowData) {
		    console.log("ğŸ”„ ëª¨ë‹¬ì— ë°ì´í„° ë°˜ì˜");
			$('#contract_cd').val(rowData.contract.contract_cd || '');
			$('#account_cd').val(rowData.contract.account_cd || '');
			$('#contract_ps').val(rowData.contract.contract_ps || '');
			$('#contract_sd').val(rowData.contract.contract_sd || '');
			$('#contract_ed').val(rowData.contract.contract_ed || '');
			$('#contract_am').val(rowData.contract.contract_am?.toLocaleString() || '');
			$('#contract_mn').val(rowData.contract.contract_mn?.toLocaleString() || '');
			$('#contract_st').val(rowData.contract.contract_st || '');
			$('#contract_rm').val(rowData.contract.contract_rm || '');
		
		    // ìƒì„¸ ë°ì´í„° `productGrid`ì— ì ìš©
		    if (rowData.details && Array.isArray(rowData.details)) {
		        productGrid.resetData(rowData.details);
		    }
		}
		
		// í–‰ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		$('#deleteProductBtn').on('click', function () {
		    const checkedRowKeys = productGrid.getCheckedRowKeys(); // ì²´í¬ëœ í–‰ì˜ rowKey ê°€ì ¸ì˜¤ê¸°
		    if (checkedRowKeys.length > 0) {
		        productGrid.removeRows(checkedRowKeys); // ì²´í¬ëœ í–‰ ì‚­ì œ
		        updateContractSummary(productGrid); // ìˆ˜ì£¼ìˆ˜ëŸ‰ ë° ìˆ˜ì£¼ê¸ˆì•¡ ì—…ë°ì´íŠ¸
		    } else {
		        showAlert(null, "error", "ì‚­ì œ ì‹¤íŒ¨ ì•Œë¦¼", "ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
		    }
		});
		
		
		// Toast UI Grid ë°ì´í„° ë³€ê²½ ì‹œ ìˆ˜ì£¼ìˆ˜ëŸ‰ ë° ìˆ˜ì£¼ê¸ˆì•¡ ì—…ë°ì´íŠ¸
		productGrid.on('afterChange', function (ev) {
		    updateContractSummary(productGrid);
		});

		// ìˆ˜ì£¼ìˆ˜ëŸ‰ ë° ìˆ˜ì£¼ê¸ˆì•¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
		function updateContractSummary(grid) {
		    const data = grid.getData();
		    let totalQty = 0;
		    let totalAmount = 0;

		    data.forEach(row => {
		        const qty = parseFloat(row.product_am) || 0;
		        const money = parseFloat(row.contract_ct) || 0;

		        totalQty += qty;
		        totalAmount += qty * money;
		    });

		    $('#contract_am').val(totalQty);
		    $('#contract_mn').val(totalAmount.toLocaleString()); // ì²œ ë‹¨ìœ„ êµ¬ë¶„
		}
			
			
			
	    // "ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ ì œí’ˆ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
	    $('#addProductBtn').on('click', function () {
	        openProductModal(productGrid);
	    });

		
		// ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì œì¶œ ì‹¤í–‰ (ì¤‘ë³µ ë°©ì§€)
		$(document).off('click', '#modal_submit_button').on('click', '#modal_submit_button', function () {
		    console.log("ë“±ë¡ ë²„íŠ¼ í´ë¦­ë¨!");

		    // ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ë²„íŠ¼ ë¹„í™œì„±í™”)
		    $(this).prop('disabled', true);

		    // í¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì œì¶œ ì‹¤í–‰
		    if ($('#appointment_form').length > 0) {
		        $('#appointment_form').trigger('submit');  // í¼ ì œì¶œ ì‹¤í–‰
		    } else {
		        console.error("ì˜¤ë¥˜: #appointment_form ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
		        $(this).prop('disabled', false);  // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
		    }
		});
		
		
		// í¼ ì œì¶œ ì´ë²¤íŠ¸
		$(document).off('submit', '#appointment_form').on('submit', '#appointment_form', function (event) {
			
	        event.preventDefault();
	        
			const mode = $('#modal_submit_button').text().trim();
			const url = mode === 'ë“±ë¡' ? '/insert_CONTRACT' : '/update_CONTRACT';
			console.log("í¼ ì œì¶œ ì‹œ mode:", mode, "ìš”ì²­ URL:", url);
			
		    const contractDTO = {
					contract_cd: $('#contract_cd').val(),
			        account_cd: $('#account_cd').val(),
			        contract_ps: $('#contract_ps').val(),
			        contract_sd: $('#contract_sd').val(),
			        contract_ed: $('#contract_ed').val(),
			        contract_am: parseInt($('#contract_am').val().replace(/,/g, '')) || 0, // ì‰¼í‘œ ì œê±° í›„ ì •ìˆ˜ ë³€í™˜
			        contract_mn: parseInt($('#contract_mn').val().replace(/,/g, '')) || 0, // ì‰¼í‘œ ì œê±° í›„ ì •ìˆ˜ ë³€í™˜
			        contract_st: $('#contract_st').val(),
			        contract_rm: $('#contract_rm').val(),
			        contract_wr: $('#contract_wr').val(),
			        contract_wd: $('#contract_wd').val(),
			        contract_mf: $('#contract_mf').val(),
			        contract_md: $('#contract_md').val()
			    };
		    
		    const details = productGrid.getData().map(row => ({
		        product_cd: row.product_cd,
		        product_sz: row.product_sz,
		        product_cr: row.product_cr,
		        product_am: parseInt(row.product_am), // ì •ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜
		        contract_ct: parseInt(row.contract_ct), // ì •ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜
		        contract_ed: row.contract_ed,
		        product_un: row.product_un
		    }));
		    
			console.log("ë³´ë‚¼ ë°ì´í„°:", { contract: contractDTO, details: details });
		    
	        // AJAX ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
	        $.ajax({
	            url: url,
	            method: 'POST',
	            contentType: "application/json",  // JSON í˜•ì‹ ì§€ì •
	            data: JSON.stringify({ contract: contractDTO, details: details }),
	            headers: { 'X-CSRF-TOKEN': csrfToken },
	            success: function () {
	            	Swal.fire({ icon: 'success',
								title: mode === 'ë“±ë¡' ? 'ë“±ë¡ ì™„ë£Œ' : 'ìˆ˜ì • ì™„ë£Œ',
								text: mode === 'ë“±ë¡' ? 'ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
								confirmButtonText: 'í™•ì¸' 
							});
					
	            	modalInstance.hide();
	            	make_contract_grid();
					if (mode === 'edit') {
					    make_detail_grid({ contract_cd: contractDTO.contract_cd });
					}
	            },
	            error: function () {
	            	Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜ ë°œìƒ!', text: 'ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', confirmButtonText: 'í™•ì¸' });
	            }
	        });
	    });
	}

	// DatePicker ì´ˆê¸°í™” í•¨ìˆ˜
	function initializeDatePickers() {
	    const today = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ

	    // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ DatePicker ì´ˆê¸°í™”
	    const startPicker = tui.DatePicker.createRangePicker({
	        startpicker: {
	            date: today,
	            input: '#contract_sd',
	            container: '#modal_startpicker-container',
	        },
	        endpicker: {
	            date: null,
	            input: '#contract_ed',
	            container: '#modal_endpicker-container',
	            disabled: true,
	        },
	        format: 'YYYY-MM-dd',
	        timePicker: false,
	    });

	    // ì¢…ë£Œì¼ í•„ë“œ ì´ˆê¸°í™” ë° ë¹„í™œì„±í™”
	    $('#contract_ed').val('').prop('disabled', true);

	    // ì‹œì‘ì¼ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
	    startPicker.on('change:start', function (event) {
	        if (event && event.date) {
	            console.log('ì„ íƒëœ ì‹œì‘ì¼: ', event.date);

	            const minEndDate = new Date(event.date);
	            minEndDate.setDate(minEndDate.getDate() + 1);

	            startPicker.getEndpicker().setOptions({
	                date: minEndDate,
	                disabled: false,
	            });

	            $('#contract_ed').prop('disabled', false);
	        }
	    });

	    // ì¢…ë£Œì¼ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
	    startPicker.on('change:end', function (event) {
	        if (event && event.date) {
	            console.log('ì„ íƒëœ ì¢…ë£Œì¼: ', event.date);
	        }
	    });
	}


    // ì œí’ˆ ì„ íƒ ëª¨ë‹¬ ìƒì„±
	function openProductModal(productGrid) {
	    $('#productSelectModal').remove();
	    const productModalHTML = `
	        <div class="modal" id="productSelectModal" tabindex="-1">
	            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
	                <div class="modal-content">
	                    <div class="modal-header">
	                        <h5 class="modal-title">ì œí’ˆ ì„ íƒ</h5>
	                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	                    </div>
	                    <div class="modal-body">
	                        <div id="productSelectGrid"></div>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	                        <button type="button" class="btn btn-primary" id="selectProductBtn">ì¶”ê°€</button>
	                    </div>
	                </div>
	            </div>
	        </div>`;

	    $('body').append(productModalHTML);

	    const productSelectGrid = new tui.Grid({
	        el: document.getElementById('productSelectGrid'),
	        data: [],
	        columns: [
	            { header: 'ì œí’ˆì½”ë“œ', name: 'product_cd', align: 'center' },
	            { header: 'ì œí’ˆëª…', name: 'product_nm', align: 'center' },
	            { header: 'ìƒ‰ìƒ', name: 'product_cr', align: 'center' },
	            { header: 'ì‚¬ì´ì¦ˆ', name: 'product_sz', align: 'center' },
	            { header: 'ê¸°ì¤€ë‹¨ìœ„', name: 'product_un', align: 'center' }
	        ],
	        rowHeaders: ['checkbox'],
	        scrollX: false,
	        scrollY: false,
	        bodyHeight: 300, // ê³ ì • ë†’ì´ ì„¤ì •
			summary: {
			    height: 40,
			    position: 'bottom', // or 'top'
			    columnContent: {
			    	product_sz: {
			            template: (valueMap) => {
			                return `ì´  ${valueMap.cnt} ê±´`
			            }
			        }
			    }
			}
	    });

	    // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	    $.ajax({
	        url: '/select_RPODUCT', // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸
	        method: 'GET',
	        success: function (response) {
	            // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ Toast UI Gridì— ì„¤ì •
	            productSelectGrid.resetData(response);
	        },
	        error: function () {
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ!',
	                text: 'ì œí’ˆ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });
	    
	    
		const productModal = new bootstrap.Modal(document.getElementById('productSelectModal'), {
		    backdrop: false,    // ì¶”ê°€ì ì¸ ë°°ê²½ ë°©ì§€
		    keyboard: false     // ESC í‚¤ë¡œ ë‹«ê¸° ë°©ì§€ (ì˜µì…˜)
		});

	    productModal.show();

	    // "ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ ë°ì´í„° ì²˜ë¦¬
		$('#selectProductBtn').on('click', function () {
		    const selectedRows = productSelectGrid.getCheckedRows();

		    if (selectedRows.length > 0) {
		        // ê¸°ì¡´ ë°ì´í„°ì™€ ì¤‘ë³µ ì²´í¬
		        const existingData = productGrid.getData();
		        const newRows = [];

		        selectedRows.forEach(row => {
		            const isDuplicate = existingData.some(existingRow => existingRow.product_cd === row.product_cd);
		            if (!isDuplicate) {
		                newRows.push(row); // ì¤‘ë³µì´ ì•„ë‹ ê²½ìš°ë§Œ ì¶”ê°€
		            } else {
			            showAlert(null, "error", "ì˜¤ë¥˜ ë°œìƒ", `ì´ë¯¸ ë“±ë¡ëœ ì œí’ˆì…ë‹ˆë‹¤: ${row.product_cd}`);
		            }
		        });

		        // ì¤‘ë³µì´ ì•„ë‹Œ ë°ì´í„°ë§Œ ì¶”ê°€
		        if (newRows.length > 0) {
		            productGrid.resetData([...existingData, ...newRows]);

		            // ì²« ë²ˆì§¸ ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì˜ ìˆ˜ëŸ‰ ì…€ì— í¬ì»¤ìŠ¤ ì´ë™
		            const rowIndex = existingData.length; // ìƒˆë¡œ ì¶”ê°€ëœ ì²« ë²ˆì§¸ í–‰ì˜ ì¸ë±ìŠ¤
		            productGrid.focus(rowIndex, 'product_am'); // 'qty' í•„ë“œì— í¬ì»¤ìŠ¤ ì´ë™
		            productGrid.startEditing(rowIndex, 'product_am'); // ìˆ˜ëŸ‰ í•„ë“œë¥¼ ë°”ë¡œ í¸ì§‘ ìƒíƒœë¡œ ì„¤ì •
		        }
		    } else {
	            showAlert(null, "error", "ì˜¤ë¥˜ ë°œìƒ", "ì¶”ê°€í•  ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");
	            return
		    }

		    productModal.hide();
		});
	}
		
        
    // ê±°ë˜ì²˜ì½”ë“œ í´ë¦­ ì‹œ ê±°ë˜ì²˜ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
	$(document).on('click', '#account_cd', function () {
	    console.log('ê±°ë˜ì²˜ ì„ íƒ input í´ë¦­ë¨!'); // í´ë¦­ ì´ë²¤íŠ¸ í™•ì¸
	    openAccountModal();
	});

    
    
    // ê±°ë˜ì²˜ ì„ íƒ ëª¨ë‹¬
	function openAccountModal() {
	    $('#accountSelectModal').remove();
	    const accountModalHTML = `
	        <div class="modal" id="accountSelectModal" tabindex="-1">
	            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
	                <div class="modal-content">
	                    <div class="modal-header">
	                        <h5 class="modal-title">ê±°ë˜ì²˜ ì„ íƒ</h5>
	                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	                    </div>
	                    <div class="modal-body">
	                        <div id="accountSelectGrid"></div>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	                        <button type="button" class="btn btn-primary" id="selectAccountBtn">ì¶”ê°€</button>
	                    </div>
	                </div>
	            </div>
	        </div>`;

	    $('body').append(accountModalHTML);

	    const accountSelectGrid = new tui.Grid({
	        el: document.getElementById('accountSelectGrid'),
	        data: [],
	        columns: [
	            { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center' },
	            { header: 'ê±°ë˜ì²˜ëª…', name: 'account_nm', align: 'center' }
	        ],
	        rowHeaders: ['checkbox'],
	        scrollX: false,
	        scrollY: false,
	        bodyHeight: 300, // ê³ ì • ë†’ì´ ì„¤ì •
	        summary: {
	            height: 40,
	            position: 'bottom',
	            columnContent: {
	                account_nm: {
	                    template: (valueMap) => {
	                    	return `ì´  ${valueMap.cnt} ê±´`
	                    }
	                }
	            }
	        }
	    });

	    // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	    $.ajax({
	        url: '/select_ACCOUNT_CONTRACT',
	        method: 'GET',
	        success: function (response) {
	            // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ Toast UI Gridì— ì„¤ì •
	            accountSelectGrid.resetData(response);
	        },
	        error: function () {
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ!',
	                text: 'ê±°ë˜ì²˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });

	    const accountModal = new bootstrap.Modal(document.getElementById('accountSelectModal'), {
	        backdrop: false, // ì¶”ê°€ì ì¸ ë°°ê²½ ë°©ì§€
	        keyboard: false // ESC í‚¤ë¡œ ë‹«ê¸° ë°©ì§€ (ì˜µì…˜)
	    });

	    accountModal.show();

	    // ì²´í¬ë°•ìŠ¤ ë‹¨ì¼ ì„ íƒ ì œí•œ
	    accountSelectGrid.on('check', (ev) => {
	        const checkedRows = accountSelectGrid.getCheckedRows();
	        if (checkedRows.length > 1) {
	            // ë§ˆì§€ë§‰ìœ¼ë¡œ ì²´í¬ëœ í•­ëª© ì œì™¸
	            accountSelectGrid.uncheck(ev.rowKey);
	            Swal.fire({
	                icon: 'warning',
	                title: 'ì•Œë¦¼',
	                text: 'í•˜ë‚˜ì˜ ê±°ë˜ì²˜ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });

	    // "ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ ë°ì´í„° ì²˜ë¦¬
	    $('#selectAccountBtn').off('click').on('click', function () {
	        const selectedRow = accountSelectGrid.getCheckedRows()[0]; // ì„ íƒëœ í•œ í–‰ë§Œ ê°€ì ¸ì˜´
	        console.log('ì„ íƒëœ í–‰:', selectedRow);
	        
	        if (selectedRow) {
	            // ì„ íƒëœ ê±°ë˜ì²˜ ë°ì´í„°ë¥¼ inputì— ì„¤ì •
	            $('#account_cd').val(selectedRow.account_cd);
	            accountModal.hide(); // ëª¨ë‹¬ ë‹«ê¸°
	        } else {
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ',
	                text: 'ì¶”ê°€í•  ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });
	} // ê±°ë˜ì²˜ ê´€ë ¨ ë
    
		
		
    // ë‹´ë‹¹ì í´ë¦­ ì‹œ ë‹´ë‹¹ì ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
	$(document).on('click', '#contract_ps', function () {
	    console.log('ë‹´ë‹¹ì ì„ íƒ input í´ë¦­ë¨!'); // í´ë¦­ ì´ë²¤íŠ¸ í™•ì¸
	    openPersonModal();
	});

    
    
    // ê±°ë˜ì²˜ ì„ íƒ ëª¨ë‹¬
	function openPersonModal() {
	    $('#personSelectModal').remove();
	    const personModalHTML = `
	        <div class="modal" id="personSelectModal" tabindex="-1">
	            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
	                <div class="modal-content">
	                    <div class="modal-header">
	                        <h5 class="modal-title">ë‹´ë‹¹ì ì„ íƒ</h5>
	                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	                    </div>
	                    <div class="modal-body">
	                        <div id="personSelectGrid"></div>
	                    </div>
	                    <div class="modal-footer">
	                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	                        <button type="button" class="btn btn-primary" id="selectPersonBtn">ì¶”ê°€</button>
	                    </div>
	                </div>
	            </div>
	        </div>`;

	    $('body').append(personModalHTML);

	    const personSelectGrid = new tui.Grid({
	        el: document.getElementById('personSelectGrid'),
	        data: [],
	        columns: [
	            { header: 'ì‚¬ì›ì½”ë“œ', name: 'employee_cd', align: 'center' },
	            { header: 'ì‚¬ì›ëª…', name: 'employee_nm', align: 'center' },
	            { header: 'ë¶€ì„œ', name: 'employee_dp', align: 'center' },
	            { header: 'ì§ìœ„', name: 'employee_gd', align: 'center' }
	        ],
	        rowHeaders: ['checkbox'],
	        scrollX: false,
	        scrollY: false,
	        bodyHeight: 300, // ê³ ì • ë†’ì´ ì„¤ì •
	        summary: {
	            height: 40,
	            position: 'bottom',
	            columnContent: {
	                account_nm: {
	                    template: (valueMap) => {
	                        return `ì´ ${valueMap.cnt} ê±´`;
	                    }
	                }
	            }
	        }
	    });

	    // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	    $.ajax({
	        url: '/select_CONTRACT_PS',
	        method: 'GET',
	        success: function (response) {
	            // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¥¼ Toast UI Gridì— ì„¤ì •
	            personSelectGrid.resetData(response);
	        },
	        error: function () {
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ!',
	                text: 'ë‹´ë‹¹ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });

	    const personModal = new bootstrap.Modal(document.getElementById('personSelectModal'), {
	        backdrop: false, // ì¶”ê°€ì ì¸ ë°°ê²½ ë°©ì§€
	        keyboard: false // ESC í‚¤ë¡œ ë‹«ê¸° ë°©ì§€ (ì˜µì…˜)
	    });

	    personModal.show();

	    // ì²´í¬ë°•ìŠ¤ ë‹¨ì¼ ì„ íƒ ì œí•œ
	    personSelectGrid.on('check', (ev) => {
	        const checkedRows = personSelectGrid.getCheckedRows();
	        if (checkedRows.length > 1) {
	            // ë§ˆì§€ë§‰ìœ¼ë¡œ ì²´í¬ëœ í•­ëª© ì œì™¸
	            personSelectGrid.uncheck(ev.rowKey);
	            Swal.fire({
	                icon: 'warning',
	                title: 'ì•Œë¦¼',
	                text: 'í•œëª…ì˜ ì‚¬ì›ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });

	    // "ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ ë°ì´í„° ì²˜ë¦¬
	    $('#selectPersonBtn').off('click').on('click', function () {
	        const selectedRow = personSelectGrid.getCheckedRows()[0]; // ì„ íƒëœ í•œ í–‰ë§Œ ê°€ì ¸ì˜´
	        console.log('ì„ íƒëœ í–‰:', selectedRow);
	        
	        if (selectedRow) {
	            // ì„ íƒëœ ë‹´ë‹¹ì ë°ì´í„°ë¥¼ inputì— ì„¤ì •
	            $('#contract_ps').val(selectedRow.employee_nm);
	            personModal.hide(); // ëª¨ë‹¬ ë‹«ê¸°
	        } else {
	            Swal.fire({
	                icon: 'error',
	                title: 'ì˜¤ë¥˜ ë°œìƒ',
	                text: 'ì¶”ê°€í•  ì‚¬ì› ì„ íƒí•˜ì„¸ìš”.',
	                confirmButtonText: 'í™•ì¸'
	            });
	        }
	    });
	} // ë‹´ë‹¹ì ì •ë³´ ë
</script>


<script th:inline="javascript">
	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    // ë³€ìˆ˜ ì§€ì •
    let contract_grid;
    let detail_grid;
	
    setGridTheme();
    
	window.status_list = /*[[${status_list != null ? status_list : '[]'}]]*/ [];

	["status_list"].forEach(key => {
	    window[key] = typeof window[key] === "string" ? JSON.parse(window[key]) : window[key];
	});
    
    
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    $(function () {
    	
        // í•„í„° ì„¤ì •
        const filterConfig = [
            { key: 'startDate', label: 'ì¡°íšŒê¸°ê°„ ì‹œì‘ì¼', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'endDate', label: 'ì¡°íšŒê¸°ê°„ ì¢…ë£Œì¼', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'contractCd', label: 'ìˆ˜ì£¼ë²ˆí˜¸', type: 'text', placeholder: 'ìˆ˜ì£¼ë²ˆí˜¸ ì…ë ¥', col: 'col-2' },
            { key: 'accountCd', label: 'ê±°ë˜ì²˜ì½”ë“œ', type: 'text', placeholder: 'ê±°ë˜ì²˜ì½”ë“œ ì…ë ¥', col: 'col-2' },
            { key: 'contractPs', label: 'ë‹´ë‹¹ìëª…', type: 'text', placeholder: 'ë‹´ë‹¹ìëª… ì…ë ¥', col: 'col-2' },
        ];

        // í•„í„° ëª¨ë“ˆ ì´ˆê¸°í™”
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            console.log('ì ìš©ëœ í•„í„°:', filterValues);

            // ì„œë²„ ìš”ì²­ ë° ê·¸ë¦¬ë“œ ê°±ì‹ 
            fetch('/select_FILTERED_CONTRACT', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token, // CSRF í† í°
                },
                body: JSON.stringify(filterValues)
            })
            .then(response => response.json())
            .then(filteredData => {
                console.log('í•„í„°ë§ëœ ë°ì´í„°:', filteredData);
                contract_grid.resetData(filteredData); // ê·¸ë¦¬ë“œ ë°ì´í„° ê°±ì‹ 
            })
            .catch(error => console.error('í•„í„° ì ìš© ì˜¤ë¥˜:', error));
        });

        // ìƒë‹¨(Contract Grid) ìƒì„±
        make_contract_grid();
        // í•˜ë‹¨(Detail Grid) ìƒì„±
        make_detail_grid();
    });

	
    // ìƒë‹¨(Contract Grid) ìƒì„± í•¨ìˆ˜
    function make_contract_grid() {
		
        $.ajax({
            url: '/select_CONTRACT',
            method: 'GET',
            success: function (response) {
                const contractList = response;

                if (contract_grid) {
                    // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ê°±ì‹ 
                    contract_grid.resetData(contractList.map(row => ({
                        contract_cd: row.contract_cd,
                        account_cd: row.account_cd,
                        contract_ps: row.contract_ps,
                        contract_sd: row.contract_sd,
                        contract_ed: row.contract_ed,
                        contract_am: row.contract_am,
                        contract_mn: row.contract_mn,
                        contract_st: row.contract_st,
                        contract_rm: row.contract_rm,
                        contract_wr: row.contract_wr,
                        contract_wd: row.contract_wd,
                        contract_mf: row.contract_mf,
                        contract_md: row.contract_md
                    })));
                } else {
                    // ì²˜ìŒ ë¡œë“œ ì‹œ ìƒˆë¡œìš´ ê·¸ë¦¬ë“œ ìƒì„±
                    contract_grid = new tui.Grid({
                        el: document.getElementById('contract_grid'),
                        data: contractList.map(row => ({
                            contract_cd: row.contract_cd,
                            account_cd: row.account_cd,
                            contract_ps: row.contract_ps,
                            contract_sd: row.contract_sd,
                            contract_ed: row.contract_ed,
                            contract_am: row.contract_am,
                            contract_mn: row.contract_mn,
                            contract_st: row.contract_st,
                            contract_rm: row.contract_rm,
                            contract_wr: row.contract_wr,
                            contract_wd: row.contract_wd,
                            contract_mf: row.contract_mf,
                            contract_md: row.contract_md
                        })),
                        scrollX: true,
                        scrollY: true,
                        autoWidth: true,
                        rowHeight: 'auto',
                        bodyHeight: 'fitToParent',
                        rowHeaders: ['checkbox'],
                        zIndex: 100,
                        columns: [
                            { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
                            { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'account_cd', align: 'center', sortable: true },
                            { header: 'ë‹´ë‹¹ìëª…', name: 'contract_ps', align: 'center', sortable: true },
                            { header: 'ìˆ˜ì£¼ì¼ì', name: 'contract_sd', align: 'center', sortable: true },
                            { header: 'ë‚©ê¸°ì¼ì', name: 'contract_ed', align: 'center', sortable: true },
                            { header: 'ìˆ˜ì£¼ìˆ˜ëŸ‰', name: 'contract_am', align: 'center', sortable: true },
                            { header: 'ìˆ˜ì£¼ê¸ˆì•¡', name: 'contract_mn', align: 'center', sortable: true },
                            { header: 'ìˆ˜ì£¼ìƒíƒœ', name: 'contract_st', align: 'center', sortable: true },
                            
                            // ìˆ¨ê¹€ ì»¬ëŸ¼
                            { header: 'ë¹„ê³ ', name: 'contract_rm', hidden: true },
                            { header: 'ì‘ì„±ì', name: 'contract_wr', hidden: true },
                            { header: 'ì‘ì„±ì¼', name: 'contract_wd', hidden: true },
                            { header: 'ìˆ˜ì •ì', name: 'contract_mf', hidden: true },
                            { header: 'ìˆ˜ì •ì¼', name: 'contract_md', hidden: true }
                        ],
        				summary: {
        				    height: 40,
        				    position: 'bottom', // or 'top'
        				    columnContent: {
        				    	contract_st: {
        				            template: (valueMap) => {
        				                return `ì´  ${valueMap.cnt} ê±´`
        				            }
        				        }
        				    }
        				}
                    });

                	 // ë‹¨ì¼ í´ë¦­ ì´ë²¤íŠ¸: ìƒì„¸ ì •ë³´ í‘œì‹œ
                    contract_grid.on('click', (ev) => {
                        const rowKey = ev.rowKey;
                        const rowData = contract_grid.getRow(rowKey);

                        if (rowKey === null || rowKey === undefined) {
                            console.warn("í—¤ë” í´ë¦­ì€ ë¬´ì‹œë©ë‹ˆë‹¤.");
                            return;
                        }

                        console.log("í´ë¦­ëœ í–‰ ë°ì´í„°:", rowData); // ë””ë²„ê¹…ìš©
                        if (!rowData) {
                            console.error("rowDataê°€ ì—†ìŠµë‹ˆë‹¤!");
                            return;
                        }
                        if (!rowData.contract_cd) {
                            console.error("contract_cdê°€ ì—†ìŠµë‹ˆë‹¤!", rowData);
                            return;
                        }
                        
                        make_detail_grid(rowData); // í•˜ë‹¨ ê·¸ë¦¬ë“œ ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ
                    });

                }
            },
            error: function (error) {
                console.error('ìˆ˜ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        });
    }

    // í•˜ë‹¨(Detail Grid) ìƒì„± í•¨ìˆ˜
	function make_detail_grid(rowData = null) {
	    // ìƒì„¸ ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë©´ ë¨¼ì € ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
	    if (!detail_grid) {
	        detail_grid = new tui.Grid({
	            el: document.getElementById('detail_grid'),
	            data: [], // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì–´ìˆìŒ
	            scrollX: false,
	            scrollY: false,
	            bodyHeight: 200, // ê³ ì • ë†’ì´ ì„¤ì •
	            columns: [
	                { header: 'ìˆ˜ì£¼ë²ˆí˜¸', name: 'contract_cd', align: 'center', sortable: true },
	                { header: 'ì œí’ˆì½”ë“œ', name: 'product_cd', align: 'center', sortable: true },
	                { header: 'ì‚¬ì´ì¦ˆ', name: 'product_sz', align: 'center', sortable: true },
	                { header: 'ìƒ‰ìƒ', name: 'product_cr', align: 'center', sortable: true },
	                { header: 'ì œí’ˆìˆ˜ëŸ‰', name: 'product_am', align: 'center', sortable: true },
	                { header: 'ë‹¨ê°€', name: 'product_ct', align: 'center', sortable: true },
	                { header: 'ê¸°ì¤€ë‹¨ìœ„', name: 'product_un', align: 'center', sortable: true },
	                { header: 'ë‚©ê¸°ì¼', name: 'contract_ed', align: 'center', sortable: true },
	            ]
	        });
			
			// ìˆ˜ì • ëª¨ë‹¬ í˜¸ì¶œì„ ìœ„í•œ í´ë¦­ ì´ë²¤íŠ¸
			detail_grid.on('click', (ev) => {
			    const rowKey = ev.rowKey;
				const clickedRowData = detail_grid.getRow(rowKey);

				if (!clickedRowData || !clickedRowData.contract_cd) {
				    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ rowDataì…ë‹ˆë‹¤:", clickedRowData);
				    Swal.fire({
				        icon: 'error',
				        title: 'ì˜¤ë¥˜ ë°œìƒ!',
				        text: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.',
				        confirmButtonText: 'í™•ì¸'
				    });
				    return;
				}
				
				console.log("ìˆ˜ì£¼ ìƒì„¸ í´ë¦­ë¨, contract_cd:", clickedRowData.contract_cd);

				fetchContractDetails(clickedRowData.contract_cd);
			});
			
	    }
	
		// ì´ˆê¸° ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì¼ ê²½ìš° ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
		if (!rowData || !rowData.contract_cd) {
		    console.warn("rowDataê°€ ìœ íš¨í•˜ì§€ ì•Šì•„ ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
		    detail_grid.resetData([]); // ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
		    return;
		}
		
	    console.log("ì„ íƒëœ ìˆ˜ì£¼ ë°ì´í„°:", rowData); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
	
	    // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” í›„ AJAX ìš”ì²­
	    detail_grid.resetData([]);
	
	    $.ajax({
	        url: '/select_CONTRACTDETAIL',
	        method: 'GET',
	        data: { contract_cd: rowData.contract_cd }, // ìˆ˜ì£¼ë²ˆí˜¸ ì „ë‹¬
	        success: function (response) {
	            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
	
			    if (Array.isArray(response) && response.length > 0) {
			        detail_grid.resetData(response);
			        console.log("í•˜ë‹¨ ê·¸ë¦¬ë“œ ê°±ì‹  ì™„ë£Œ");
			    } else {
			        console.warn("ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
			        Swal.fire({
			            icon: 'warning',
			            title: 'ë°ì´í„° ì—†ìŒ',
			            text: 'ìˆ˜ì£¼ ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
			            confirmButtonText: 'í™•ì¸'
			        });
			        detail_grid.resetData([]); // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ì´ˆê¸°í™”
			    }
			},
			error: function (error) {
			    console.error("ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
			    Swal.fire({
			        icon: 'error',
			        title: 'ì˜¤ë¥˜ ë°œìƒ!',
			        text: 'ìˆ˜ì£¼ ìƒì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
			        confirmButtonText: 'í™•ì¸'
			    });
			    detail_grid.resetData([]); // ì˜¤ë¥˜ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
	        }
	    });

    }
</script>

</html>
