<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<style>
.col1 {
	width: 160px !important;
	position: relative;
	z-index: 9998;
	margin-right: 5px;
}

.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-timepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-grid-cell-summary {
    background-color: #ddd;
    border-color: #fff;
    border-left-width: 1px;
    border-right-width: 1px;
    color: #333;
}
</style>
<body>
	<main id="main" class="main">
	    <div class="pagetitle"></div>
	    <section class="section">
			<!-- 상단 필터 영역 -->
			<div class="row mb-3">
			    <div class="col-12">
			        <div class="card">
			            <div class="card-body">
			                <h5 class="card-title">필터</h5>
			                <div id="filterModule"></div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">수주 등록</h5>
	                            <div>
	                                <input type="button" id="btn_open_modal" class="btn btn-primary" value="등록">
	                                <input type="button" id="btn_group_remove" class="btn btn-primary" value="삭제">
	                            </div>
	                        </div>
							<div class="col-sm-12">
		                        <!-- 수주 등록 그리드 -->
		                        <div id="contract_grid"></div>
							</div>
	                        <div class="d-flex align-items-center justify-content-between">
	                            <h5 class="card-title">수주 상세</h5>
	                        </div>
	                        <!-- 수주 상세 그리드 -->
	                        <div id="detail_grid"></div>
			            </div>
			        </div>
			    </div>
			</div>
	    </section>
	</main>
</body>

<script>
    $(document).ready(function () {
        // 수주 등록 모달 트리거
		$('#btn_open_modal').on('click', function () {
		    openModal();
		});

        
		// 동적 모달 생성 및 표시
		function openModal() {
		    // 기존 모달 제거
		    $('#contractInsertModal').remove();

		    // 모달 HTML 생성
		    const modalHTML = `
		        <div class="modal" id="contractInsertModal" tabindex="-1" aria-labelledby="contractInsertModalLabel" aria-hidden="true">
		            <div class="modal-dialog modal-dialog-centered modal-xl">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title" id="dynamicModalLabel">수주 등록</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		                    </div>
		                    <div class="modal-body">
		                        <form id="appointment_form" method="post" enctype="multipart/form-data">
		                            <input type="hidden" id="contract_cd" name="contract_cd">
		                            <div class="row mb-3">
		                                <div class="col-md-4">
		                                    <label for="contract_ps" class="form-label">담당자명</label>
		                                    <input type="text" class="form-control" id="contract_ps" name="contract_ps">
		                                </div>
		                                <div class="col-md-4">
		                                    <label for="account_sd" class="form-label">수주일</label>
		                                    <input type="text" class="form-control" id="contract_sd" name="account_sd" readonly>
		                                    <div id="modal_startpicker-container"></div>
		                                </div>
		                                <div class="col-md-4">
		                                    <label for="account_ed" class="form-label">납기일</label>
		                                    <input type="text" class="form-control" id="contract_ed" name="account_ed" readonly>
		                                    <div id="modal_endpicker-container"></div>
		                                </div>
		                            </div>
		                            <div class="row mb-3">
		                                <div class="col-md-3">
		                                    <label for="account_cp" class="form-label">거래처코드</label>
		                                    <input type="text" class="form-control" id="account_cd" name="account_cd" readonly>
		                                </div>
										<div class="col-md-3">
		                                    <label for="contract_st" class="form-label">수주상태</label>
		                                    <select class="form-select" id="contract_st" name="contract_st">
		                                        <option value="">선택</option>
		                                    </select>
										</div>
										<div class="col-md-3">
										    <label for="contract_am" class="form-label">수주수량</label>
										    <input type="text" class="form-control" id="contract_am" name="contract_am" readonly>
										</div>
										<div class="col-md-3">
										    <label for="contract_mn" class="form-label">수주금액</label>
										    <input type="text" class="form-control" id="contract_mn" name="contract_mn" readonly>
										</div>
										<div class="col-sm-12">
										    <label for="contract_rm" class="form-label">비고</label>
											<textarea class="form-control" id="contract_rm" name="contract_rm" style="height: 200px"></textarea>
										</div>
		                            </div>
		                            <div class="row mb-3">
		                                <div class="col-sm-12 text-end">
		                                    <button type="button" id="addProductBtn" class="btn btn-primary">추가</button>
											<button type="button" id="deleteProductBtn" class="btn btn-danger">행 삭제</button>
		                                </div>
		                            </div>
		                            <div class="row">
		                                <div id="productGrid"></div>
		                            </div>
		                        </form>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="submit" class="btn btn-primary" form="appointment_form">등록</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    // 모달을 body에 추가
		    $('body').append(modalHTML);

		    var status_list = window.status_list || [];
		    
			// 셀렉트 박스 관련 함수
			function populateSelectOptions(selectId, dataList) {
			    const selectElement = document.getElementById(selectId);
			    if (Array.isArray(dataList) && dataList.length > 0) {
			        dataList.forEach(item => {
			            const option = document.createElement('option');
			            option.value = item.common_cc;
			            option.textContent = item.common_nm;
			            selectElement.appendChild(option);
			        });
			    }
			}

			// 거래처 구분 (contract_st) 옵션 추가
			populateSelectOptions('contract_st', window.status_list);
		    
		    
		    // Toast UI Grid 초기화
		    const productGrid = new tui.Grid({
		        el: document.getElementById('productGrid'),
		        data: [],
		        columns: [
		            { header: '제품코드', name: 'product_cd', align: 'center' },
		            { header: '제품명', name: 'product_nm', align: 'center' },
		            { header: '색상', name: 'product_cr', align: 'center' },
		            { header: '사이즈', name: 'product_sz', align: 'center' },
		            { header: '기준단위', name: 'product_un', align: 'center' },
		            { header: '수량', name: 'product_am', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
		            { header: '단가', name: 'contract_ct', align: 'center', editor: {type: 'text', options: { type: 'number', min: 1 }}},
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false
		    });

		    // DatePicker 초기화
		    initializeDatePickers();

		    // Bootstrap 모달 표시
		    const modalInstance = new bootstrap.Modal(document.getElementById('contractInsertModal'));
		    modalInstance.show();

			// 행 삭제 버튼 클릭 이벤트
			$('#deleteProductBtn').on('click', function () {
			    const checkedRowKeys = productGrid.getCheckedRowKeys(); // 체크된 행의 rowKey 가져오기
			    if (checkedRowKeys.length > 0) {
			        productGrid.removeRows(checkedRowKeys); // 체크된 행 삭제
			        updateContractSummary(productGrid); // 수주수량 및 수주금액 업데이트
			    } else {
			        showAlert(null, "error", "삭제 실패 알림", "삭제할 행을 선택해주세요");
			    }
			});
			
			
			// Toast UI Grid 데이터 변경 시 수주수량 및 수주금액 업데이트
			productGrid.on('afterChange', function (ev) {
			    updateContractSummary(productGrid);
			});

			// 수주수량 및 수주금액 업데이트 함수
			function updateContractSummary(grid) {
			    const data = grid.getData();
			    let totalQty = 0;
			    let totalAmount = 0;

			    data.forEach(row => {
			        const qty = parseFloat(row.product_am) || 0;
			        const money = parseFloat(row.contract_ct) || 0;

			        totalQty += qty;
			        totalAmount += qty * money;
			    });

			    $('#contract_am').val(totalQty);
			    $('#contract_mn').val(totalAmount.toLocaleString()); // 천 단위 구분
			}
			
			
			
		    // "추가" 버튼 클릭 시 제품 선택 모달 열기
		    $('#addProductBtn').on('click', function () {
		        openProductModal(productGrid);
		    });

		    // 폼 submit 이벤트 처리
		    $('#appointment_form').on('submit', function (event) {
		        event.preventDefault();
		        
			    const contractDTO = {
			    		contract_cd: $('#contract_cd').val(),
				        account_cd: $('#account_cd').val(),
				        contract_ps: $('#contract_ps').val(),
				        contract_sd: $('#contract_sd').val(),
				        contract_ed: $('#contract_ed').val(),
				        contract_am: parseInt($('#contract_am').val().replace(/,/g, '')) || 0, // 쉼표 제거 후 정수 변환
				        contract_mn: parseInt($('#contract_mn').val().replace(/,/g, '')) || 0, // 쉼표 제거 후 정수 변환
				        contract_st: $('#contract_st').val(),
				        contract_rm: $('#contract_rm').val(),
				        contract_wr: $('#contract_wr').val(),
				        contract_wd: $('#contract_wd').val(),
				        contract_mf: $('#contract_mf').val(),
				        contract_md: $('#contract_md').val()
				    };
			    
			    const details = productGrid.getData().map(row => ({
			        product_cd: row.product_cd,
			        product_sz: row.product_sz,
			        product_cr: row.product_cr,
			        product_am: parseInt(row.product_am), // 정수형으로 변환
			        contract_ct: parseInt(row.contract_ct), // 정수형으로 변환
			        contract_ed: row.contract_ed,
			        product_un: row.product_un
			    }));
			    
			    
		        // AJAX 요청으로 데이터 전송
		        $.ajax({
		            url: '/insert_CONTRACT',
		            method: 'POST',
		            contentType: "application/json",  // JSON 형식 지정
		            data: JSON.stringify({ contract: contractDTO, details: details }),
		            headers: { 'X-CSRF-TOKEN': csrfToken },
		            success: function () {
		            	Swal.fire({ icon: 'success', title: '등록 완료', text: '등록이 완료되었습니다.', confirmButtonText: '확인' });
		            	modalInstance.hide();
		            	make_contract_grid();
		            },
		            error: function () {
		            	Swal.fire({ icon: 'error', title: '오류 발생!', text: '작업 중 오류가 발생했습니다.', confirmButtonText: '확인' });
		            }
		        });
		    });
		}

		// DatePicker 초기화 함수
		function initializeDatePickers() {
		    const today = new Date(); // 오늘 날짜

		    // 시작일과 종료일 DatePicker 초기화
		    const startPicker = tui.DatePicker.createRangePicker({
		        startpicker: {
		            date: today,
		            input: '#contract_sd',
		            container: '#modal_startpicker-container',
		        },
		        endpicker: {
		            date: null,
		            input: '#contract_ed',
		            container: '#modal_endpicker-container',
		            disabled: true,
		        },
		        format: 'YYYY-MM-dd',
		        timePicker: false,
		    });

		    // 종료일 필드 초기화 및 비활성화
		    $('#contract_ed').val('').prop('disabled', true);

		    // 시작일 선택 이벤트 처리
		    startPicker.on('change:start', function (event) {
		        if (event && event.date) {
		            console.log('선택된 시작일: ', event.date);

		            const minEndDate = new Date(event.date);
		            minEndDate.setDate(minEndDate.getDate() + 1);

		            startPicker.getEndpicker().setOptions({
		                date: minEndDate,
		                disabled: false,
		            });

		            $('#contract_ed').prop('disabled', false);
		        }
		    });

		    // 종료일 선택 이벤트 처리
		    startPicker.on('change:end', function (event) {
		        if (event && event.date) {
		            console.log('선택된 종료일: ', event.date);
		        }
		    });
		}


        // 제품 선택 모달 생성
		function openProductModal(productGrid) {
		    $('#productSelectModal').remove();
		    const productModalHTML = `
		        <div class="modal" id="productSelectModal" tabindex="-1">
		            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title">제품 선택</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		                    </div>
		                    <div class="modal-body">
		                        <div id="productSelectGrid"></div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="button" class="btn btn-primary" id="selectProductBtn">추가</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    $('body').append(productModalHTML);

		    const productSelectGrid = new tui.Grid({
		        el: document.getElementById('productSelectGrid'),
		        data: [],
		        columns: [
		            { header: '제품코드', name: 'product_cd', align: 'center' },
		            { header: '제품명', name: 'product_nm', align: 'center' },
		            { header: '색상', name: 'product_cr', align: 'center' },
		            { header: '사이즈', name: 'product_sz', align: 'center' },
		            { header: '기준단위', name: 'product_un', align: 'center' }
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false,
		        bodyHeight: 300, // 고정 높이 설정
				summary: {
				    height: 40,
				    position: 'bottom', // or 'top'
				    columnContent: {
				    	product_sz: {
				            template: (valueMap) => {
				                return `총  ${valueMap.cnt} 건`
				            }
				        }
				    }
				}
		    });

		    // 서버에서 데이터 가져오기
		    $.ajax({
		        url: '/select_RPODUCT', // 서버 API 엔드포인트
		        method: 'GET',
		        success: function (response) {
		            // 서버 응답 데이터를 Toast UI Grid에 설정
		            productSelectGrid.resetData(response);
		        },
		        error: function () {
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생!',
		                text: '제품 데이터를 가져오는 데 실패했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });
		    
		    
			const productModal = new bootstrap.Modal(document.getElementById('productSelectModal'), {
			    backdrop: false,    // 추가적인 배경 방지
			    keyboard: false     // ESC 키로 닫기 방지 (옵션)
			});

		    productModal.show();

		    // "추가" 버튼 클릭 시 선택 데이터 처리
			$('#selectProductBtn').on('click', function () {
			    const selectedRows = productSelectGrid.getCheckedRows();

			    if (selectedRows.length > 0) {
			        // 기존 데이터와 중복 체크
			        const existingData = productGrid.getData();
			        const newRows = [];

			        selectedRows.forEach(row => {
			            const isDuplicate = existingData.some(existingRow => existingRow.product_cd === row.product_cd);
			            if (!isDuplicate) {
			                newRows.push(row); // 중복이 아닐 경우만 추가
			            } else {
				            showAlert(null, "error", "오류 발생", `이미 등록된 제품입니다: ${row.product_cd}`);
			            }
			        });

			        // 중복이 아닌 데이터만 추가
			        if (newRows.length > 0) {
			            productGrid.resetData([...existingData, ...newRows]);

			            // 첫 번째 새로 추가된 행의 수량 셀에 포커스 이동
			            const rowIndex = existingData.length; // 새로 추가된 첫 번째 행의 인덱스
			            productGrid.focus(rowIndex, 'product_am'); // 'qty' 필드에 포커스 이동
			            productGrid.startEditing(rowIndex, 'product_am'); // 수량 필드를 바로 편집 상태로 설정
			        }
			    } else {
		            showAlert(null, "error", "오류 발생", "추가할 제품을 선택하세요.");
		            return
			    }

			    productModal.hide();
			});
		}
		
        
	    // 거래처코드 클릭 시 거래처 선택 모달 열기
		$(document).on('click', '#account_cd', function () {
		    console.log('거래처 선택 input 클릭됨!'); // 클릭 이벤트 확인
		    openAccountModal();
		});

        
        
        // 거래처 선택 모달
		function openAccountModal() {
		    $('#accountSelectModal').remove();
		    const accountModalHTML = `
		        <div class="modal" id="accountSelectModal" tabindex="-1">
		            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title">거래처 선택</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		                    </div>
		                    <div class="modal-body">
		                        <div id="accountSelectGrid"></div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="button" class="btn btn-primary" id="selectAccountBtn">추가</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    $('body').append(accountModalHTML);

		    const accountSelectGrid = new tui.Grid({
		        el: document.getElementById('accountSelectGrid'),
		        data: [],
		        columns: [
		            { header: '거래처코드', name: 'account_cd', align: 'center' },
		            { header: '거래처명', name: 'account_nm', align: 'center' }
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false,
		        bodyHeight: 300, // 고정 높이 설정
		        summary: {
		            height: 40,
		            position: 'bottom',
		            columnContent: {
		                account_nm: {
		                    template: (valueMap) => {
		                    	return `총  ${valueMap.cnt} 건`
		                    }
		                }
		            }
		        }
		    });

		    // 서버에서 데이터 가져오기
		    $.ajax({
		        url: '/select_ACCOUNT_CONTRACT',
		        method: 'GET',
		        success: function (response) {
		            // 서버 응답 데이터를 Toast UI Grid에 설정
		            accountSelectGrid.resetData(response);
		        },
		        error: function () {
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생!',
		                text: '거래처 데이터를 가져오는 데 실패했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });

		    const accountModal = new bootstrap.Modal(document.getElementById('accountSelectModal'), {
		        backdrop: false, // 추가적인 배경 방지
		        keyboard: false // ESC 키로 닫기 방지 (옵션)
		    });

		    accountModal.show();

		    // 체크박스 단일 선택 제한
		    accountSelectGrid.on('check', (ev) => {
		        const checkedRows = accountSelectGrid.getCheckedRows();
		        if (checkedRows.length > 1) {
		            // 마지막으로 체크된 항목 제외
		            accountSelectGrid.uncheck(ev.rowKey);
		            Swal.fire({
		                icon: 'warning',
		                title: '알림',
		                text: '하나의 거래처만 선택할 수 있습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });

		    // "추가" 버튼 클릭 시 선택 데이터 처리
		    $('#selectAccountBtn').off('click').on('click', function () {
		        const selectedRow = accountSelectGrid.getCheckedRows()[0]; // 선택된 한 행만 가져옴
		        console.log('선택된 행:', selectedRow);
		        
		        if (selectedRow) {
		            // 선택된 거래처 데이터를 input에 설정
		            $('#account_cd').val(selectedRow.account_cd);
		            accountModal.hide(); // 모달 닫기
		        } else {
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생',
		                text: '추가할 거래처를 선택하세요.',
		                confirmButtonText: '확인'
		            });
		        }
		    });
		} // 거래처 관련 끝
        
	    // 담당자 클릭 시 담당자 선택 모달 열기
		$(document).on('click', '#contract_ps', function () {
		    console.log('담당자 선택 input 클릭됨!'); // 클릭 이벤트 확인
		    openPersonModal();
		});

        
        
        // 거래처 선택 모달
		function openPersonModal() {
		    $('#personSelectModal').remove();
		    const personModalHTML = `
		        <div class="modal" id="personSelectModal" tabindex="-1">
		            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title">담당자 선택</h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		                    </div>
		                    <div class="modal-body">
		                        <div id="personSelectGrid"></div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		                        <button type="button" class="btn btn-primary" id="selectPersonBtn">추가</button>
		                    </div>
		                </div>
		            </div>
		        </div>`;

		    $('body').append(personModalHTML);

		    const personSelectGrid = new tui.Grid({
		        el: document.getElementById('personSelectGrid'),
		        data: [],
		        columns: [
		            { header: '사원코드', name: 'employee_cd', align: 'center' },
		            { header: '사원명', name: 'employee_nm', align: 'center' },
		            { header: '부서', name: 'employee_dp', align: 'center' },
		            { header: '직위', name: 'employee_gd', align: 'center' }
		        ],
		        rowHeaders: ['checkbox'],
		        scrollX: false,
		        scrollY: false,
		        bodyHeight: 300, // 고정 높이 설정
		        summary: {
		            height: 40,
		            position: 'bottom',
		            columnContent: {
		                account_nm: {
		                    template: (valueMap) => {
		                        return `총 ${valueMap.cnt} 건`;
		                    }
		                }
		            }
		        }
		    });

		    // 서버에서 데이터 가져오기
		    $.ajax({
		        url: '/select_CONTRACT_PS',
		        method: 'GET',
		        success: function (response) {
		            // 서버 응답 데이터를 Toast UI Grid에 설정
		            personSelectGrid.resetData(response);
		        },
		        error: function () {
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생!',
		                text: '담당자 정보를 가져오는 데 실패했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });

		    const personModal = new bootstrap.Modal(document.getElementById('personSelectModal'), {
		        backdrop: false, // 추가적인 배경 방지
		        keyboard: false // ESC 키로 닫기 방지 (옵션)
		    });

		    personModal.show();

		    // 체크박스 단일 선택 제한
		    personSelectGrid.on('check', (ev) => {
		        const checkedRows = personSelectGrid.getCheckedRows();
		        if (checkedRows.length > 1) {
		            // 마지막으로 체크된 항목 제외
		            personSelectGrid.uncheck(ev.rowKey);
		            Swal.fire({
		                icon: 'warning',
		                title: '알림',
		                text: '한명의 사원만 선택할 수 있습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });

		    // "추가" 버튼 클릭 시 선택 데이터 처리
		    $('#selectPersonBtn').off('click').on('click', function () {
		        const selectedRow = personSelectGrid.getCheckedRows()[0]; // 선택된 한 행만 가져옴
		        console.log('선택된 행:', selectedRow);
		        
		        if (selectedRow) {
		            // 선택된 담당자 데이터를 input에 설정
		            $('#contract_ps').val(selectedRow.employee_nm);
		            personModal.hide(); // 모달 닫기
		        } else {
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생',
		                text: '추가할 사원 선택하세요.',
		                confirmButtonText: '확인'
		            });
		        }
		    });
		} // 담당자 정보 끝
    });
</script>


<script th:inline="javascript">
	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    // 변수 지정
    let contract_grid;
    let detail_grid;
    
    setGridTheme();
    
	window.status_list = /*[[${status_list != null ? status_list : '[]'}]]*/ [];

	["status_list"].forEach(key => {
	    window[key] = typeof window[key] === "string" ? JSON.parse(window[key]) : window[key];
	});
    
    
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    $(function () {
    	
        // 필터 설정
        const filterConfig = [
            { key: 'startDate', label: '조회기간 시작일', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'endDate', label: '조회기간 종료일', type: 'daterangepicker', format: 'YYYY-MM-dd'},
            { key: 'contractCd', label: '수주번호', type: 'text', placeholder: '수주번호 입력', col: 'col-2' },
            { key: 'accountCd', label: '거래처코드', type: 'text', placeholder: '거래처코드 입력', col: 'col-2' },
            { key: 'contractPs', label: '담당자명', type: 'text', placeholder: '담당자명 입력', col: 'col-2' },
        ];

        // 필터 모듈 초기화
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            console.log('적용된 필터:', filterValues);

            // 서버 요청 및 그리드 갱신
            fetch('/select_FILTERED_CONTRACT', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token, // CSRF 토큰
                },
                body: JSON.stringify(filterValues)
            })
            .then(response => response.json())
            .then(filteredData => {
                console.log('필터링된 데이터:', filteredData);
                contract_grid.resetData(filteredData); // 그리드 데이터 갱신
            })
            .catch(error => console.error('필터 적용 오류:', error));
        });

        // 상단(Contract Grid) 생성
        make_contract_grid();
        // 하단(Detail Grid) 생성
        make_detail_grid();
    });

	
    // 상단(Contract Grid) 생성 함수
    function make_contract_grid() {
		
        $.ajax({
            url: '/select_CONTRACT',
            method: 'GET',
            success: function (response) {
                const contractList = response;

                if (contract_grid) {
                    // 기존 그리드가 있으면 데이터만 갱신
                    contract_grid.resetData(contractList.map(row => ({
                        contract_cd: row.contract_cd,
                        account_cd: row.account_cd,
                        contract_ps: row.contract_ps,
                        contract_sd: row.contract_sd,
                        contract_ed: row.contract_ed,
                        contract_am: row.contract_am,
                        contract_mn: row.contract_mn,
                        contract_st: row.contract_st,
                        contract_rm: row.contract_rm,
                        contract_wr: row.contract_wr,
                        contract_wd: row.contract_wd,
                        contract_mf: row.contract_mf,
                        contract_md: row.contract_md
                    })));
                } else {
                    // 처음 로드 시 새로운 그리드 생성
                    contract_grid = new tui.Grid({
                        el: document.getElementById('contract_grid'),
                        data: contractList.map(row => ({
                            contract_cd: row.contract_cd,
                            account_cd: row.account_cd,
                            contract_ps: row.contract_ps,
                            contract_sd: row.contract_sd,
                            contract_ed: row.contract_ed,
                            contract_am: row.contract_am,
                            contract_mn: row.contract_mn,
                            contract_st: row.contract_st,
                            contract_rm: row.contract_rm,
                            contract_wr: row.contract_wr,
                            contract_wd: row.contract_wd,
                            contract_mf: row.contract_mf,
                            contract_md: row.contract_md
                        })),
                        scrollX: true,
                        scrollY: true,
                        autoWidth: true,
                        rowHeight: 'auto',
                        bodyHeight: 'fitToParent',
                        rowHeaders: ['checkbox'],
                        zIndex: 100,
                        columns: [
                            { header: '수주번호', name: 'contract_cd', align: 'center', sortable: true },
                            { header: '거래처코드', name: 'account_cd', align: 'center', sortable: true },
                            { header: '담당자명', name: 'contract_ps', align: 'center', sortable: true },
                            { header: '수주일자', name: 'contract_sd', align: 'center', sortable: true },
                            { header: '납기일자', name: 'contract_ed', align: 'center', sortable: true },
                            { header: '수주수량', name: 'contract_am', align: 'center', sortable: true },
                            { header: '수주금액', name: 'contract_mn', align: 'center', sortable: true },
                            { header: '수주상태', name: 'contract_st', align: 'center', sortable: true },
                            
                            // 숨김 컬럼
                            { header: '비고', name: 'contract_rm', hidden: true },
                            { header: '작성자', name: 'contract_wr', hidden: true },
                            { header: '작성일', name: 'contract_wd', hidden: true },
                            { header: '수정자', name: 'contract_mf', hidden: true },
                            { header: '수정일', name: 'contract_md', hidden: true }
                        ],
        				summary: {
        				    height: 40,
        				    position: 'bottom', // or 'top'
        				    columnContent: {
        				    	contract_st: {
        				            template: (valueMap) => {
        				                return `총  ${valueMap.cnt} 건`
        				            }
        				        }
        				    }
        				}
                    });

                	 // 단일 클릭 이벤트: 상세 정보 표시
                    contract_grid.on('click', (ev) => {
                        const rowKey = ev.rowKey;
                        const rowData = contract_grid.getRow(rowKey);

                        if (rowKey === null || rowKey === undefined) {
                            console.warn("헤더 클릭은 무시됩니다.");
                            return;
                        }

                        console.log("클릭된 행 데이터:", rowData); // 디버깅용
                        if (!rowData) {
                            console.error("rowData가 없습니다!");
                            return;
                        }
                        if (!rowData.contract_cd) {
                            console.error("contract_cd가 없습니다!", rowData);
                            return;
                        }
                        
                        make_detail_grid(rowData); // 하단 그리드 갱신 함수 호출
                    });

                    // 더블클릭 이벤트: 수정 모달 열기
                    contract_grid.on('dblclick', (ev) => {
                        const columnName = ev.columnName;
                        const rowKey = ev.rowKey;
                        const rowData = contract_grid.getRow(rowKey);

                        if (rowKey === null || rowKey === undefined) {
                            console.warn("헤더 클릭은 무시됩니다.");
                            return;
                        }

                        if (columnName === 'contract_cd' || columnName === 'account_cd' || columnName === 'contract_ps') {
                            console.log("모달에 표시할 데이터:", rowData);
                            openContractModal('edit', rowData); // 수정 모달 실행
                        }
                    });

                    
                }
            },
            error: function (error) {
                console.error('수주 데이터 로드 실패:', error);
            }
        });
    }

    // 하단(Detail Grid) 생성 함수
	function make_detail_grid(rowData = null) {
	    // 상세 그리드가 없으면 먼저 빈 데이터로 초기화
	    if (!detail_grid) {
	        detail_grid = new tui.Grid({
	            el: document.getElementById('detail_grid'),
	            data: [], // 초기 데이터는 비어있음
	            scrollX: false,
	            scrollY: false,
	            bodyHeight: 200, // 고정 높이 설정
	            columns: [
	                { header: '수주번호', name: 'contract_cd', align: 'center', sortable: true },
	                { header: '제품코드', name: 'product_cd', align: 'center', sortable: true },
	                { header: '사이즈', name: 'product_sz', align: 'center', sortable: true },
	                { header: '색상', name: 'product_cr', align: 'center', sortable: true },
	                { header: '제품수량', name: 'product_am', align: 'center', sortable: true },
	                { header: '단가', name: 'product_ct', align: 'center', sortable: true },
	                { header: '기준단위', name: 'product_un', align: 'center', sortable: true },
	                { header: '납기일', name: 'contract_ed', align: 'center', sortable: true },
	            ]
	        });
	    }
	
	    // rowData가 없으면 빈 데이터 유지 (초기 상태)
	    if (!rowData || !rowData.contract_cd) {
	        console.warn("초기화 상태이거나, 갱신할 데이터가 없습니다.");
	        detail_grid.resetData([]); // 빈 데이터 유지
	        return;
	    }
	
	    console.log("선택된 계약 데이터:", rowData); // 디버깅 로그 추가
	
	    // 기존 데이터 초기화 후 AJAX 요청
	    detail_grid.resetData([]);
	
	    $.ajax({
	        url: '/select_CONTRACTDETAIL',
	        method: 'GET',
	        data: { contract_cd: rowData.contract_cd }, // 수주번호 전달
	        success: function (response) {
	            console.log("서버 응답 데이터:", response); // 디버깅 로그 추가
	
	            if (Array.isArray(response) && response.length > 0) {
	                detail_grid.resetData(response);
	                console.log("하단 그리드 갱신 완료");
	            } else {
	                console.warn("서버에서 데이터를 가져오지 못했습니다.");
	                detail_grid.resetData([]); // 데이터가 없을 경우 초기화
	            }
	        },
	        error: function (error) {
	            console.error("상세 데이터를 가져오는 중 오류 발생:", error);
	            console.error("오류 응답:", error.responseText || error.statusText); // 추가 로그
	            detail_grid.resetData([]); // 오류 시 데이터 초기화
	        }
	    });

    }
</script>

</html>
