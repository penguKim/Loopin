<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<body>
	<main id="main" class="main">
	<div class="pagetitle">
	
		<!-- Page Title -->
			<h1>공통코드</h1>
		<!-- Start Page Title -->
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/log">TEST</a></li>
					<li class="breadcrumb-item">test1</li>
					<li class="breadcrumb-item active">test2</li>
				</ol>
			</nav>
		</div>
		<!-- End Page Title -->



		<section class="section">
			<div class="row">
				<div class="col-lg-6">
					<div class="card">
						<div class="card-body ">
							<div class="d-flex align-items-center justify-content-between">
								<h5 class="card-title">코드 분류</h5>
								<div>
									<input type="button" id="btn_group_remove" class="btn btn-primary" value="삭제">
									<input type="button" id="btn_group_add" class="btn btn-primary" value="행추가">
									<input type="button" id="btn_group_insert" class="btn btn-primary" value="등록">
								</div>
							</div>
							<!-- 대분류 그리드 -->
							<div id="group_grid"></div>
						</div>
					</div>
				</div>
				<div class="col-lg-6">

					<div class="card">
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between">
								<h5 class="card-title">상세 코드</h5>
								<div>
									<input type="button" id="btn_code_remove" class="btn btn-primary" value="삭제">
									<input type="button" id="btn_code_add" class="btn btn-primary" value="행추가">
									<input type="button" id="btn_code_insert" class="btn btn-primary" value="등록">
								</div>
							</div>
							<!-- 소분류 그리드 -->
							<div id="grid"></div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>
<script th:inline="javascript">
	// 변수 지정
	let group_grid;
	let grid;
	let select_group_code;
	
	const btn_group_remove = $('#btn_group_remove');
	const btn_group_add = $('#btn_group_add');
	const btn_group_insert = $('#btn_group_insert');
	const btn_code_remove = $('#btn_code_remove');
	const btn_code_add = $('#btn_code_add');
	const btn_code_insert = $('#btn_code_insert');
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	
	
	// ------------------------------
	
	$(function() {
		
		make_group_grid();
		make_grid();
		
		
		console.log(group_grid.getData());
		
		// 코드분류 그리드 ----------------------
		group_grid.on('click', function(ev) {
		    let rowdata = group_grid.getRow(ev.rowKey);
			
			if(!rowdata || rowdata['common_cc'] == '') {
				return;
			}
			
			select_code(rowdata);
			
		});
		
		// 행 추가
		btn_group_add.on('click', function() {
			group_grid.appendRow({
			        "common_cc": '',
			        "common_nm": '',
			        "common_us": '',
			    },
			    {focus: true}
			);
		});
		
		// 행 등록
		btn_group_insert.on('click', function(ev) {
			const modifiedData = group_grid.getModifiedRows();
			const createdRows = modifiedData.createdRows;
			const updatedRows = modifiedData.updatedRows;
			
			
		    // 빈 값이 있는지 확인하는 함수
			function hasEmptyValues(rows) {
			    return rows.some(function(row) {
			        return Object.values(row).some(function(value) {
			            return value === null || value === undefined || value === '';
			        });
			    });
			}
		
		    // 생성된 행 또는 수정된 행 중 빈 값이 있는지 확인
		    if (hasEmptyValues(createdRows) || hasEmptyValues(updatedRows)) {
		        alert('입력되지 않은 항목이 있습니다.');
		        return;
		    }
			
			const json = {
				createdRows: createdRows,
				updatedRows: updatedRows
			}

			const jsonData = JSON.stringify(json);
			
			$.ajax({
				type: 'post',
				url: '/insert_group_code',
				data: jsonData,
				contentType: 'application/json',
				beforeSend : function(xhr) {
				    xhr.setRequestHeader(header, token);
				},
				success: function(data) {
					let row = data.data.contents;
					console.log(row);
					group_grid.focus(-1);
					group_grid.uncheckAll();
					group_grid.resetData(row);
				},
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패');
				}
			});

		});
		
		// 행 데이터 삭제
		btn_group_remove.on('click', function() {
			let checkedRows = group_grid.getCheckedRows();
			
			
			if (checkedRows.length == 0) {
			    alert('삭제할 항목을 선택하세요.');
			    return;
			}
			
			if (!confirm('선택한 항목을 삭제하시겠습니까?')) {
			    return;
			}
			
			const json = {
					deletedRows: checkedRows,
					code: select_group_code
				}
				
			const jsonData = JSON.stringify(json);	
			
			if(group_grid.removeCheckedRows(showConfirm)) {
				$.ajax({
					type: 'post',
					url: '/delete_group_code',
					data: jsonData,
					contentType: 'application/json',
					beforeSend : function(xhr) {
					    xhr.setRequestHeader(header, token);
					},
					success: function(data) {
					},
					error : function(xhr, textStatus, errorThrown) {
						console.log('조회 실패');
					}
				});
			}
			
		});
		
		
		
		// 상세코드 그리드 ------------------------
		grid.on('click', function(ev) {
			let rowdata = grid.getRow(ev.rowKey);
			
			if(rowdata == null) {
				return;
			}
			
		});


		
		
		// 상세코드 행 추가
		btn_code_add.on('click', () => {
            grid.appendRow({
                    "common_cc": '',
                    "common_nm": '',
                    "common_ct": '',
                    "common_in": '',
                    "common_us": '',
                },
                {focus: true}
            );
        });
		
		// 상세코드 등록
		btn_code_insert.on('click', function(ev) {
			const modifiedData = grid.getModifiedRows();
			const createdRows = modifiedData.createdRows;
			const updatedRows = modifiedData.updatedRows;
			const json = {
				createdRows: createdRows,
				updatedRows: updatedRows,
				code: select_group_code
			}
			
			const jsonData = JSON.stringify(json);			
 			$.ajax({
				type: 'post',
				url: '/insert_group_code',
				data: jsonData,
				contentType: 'application/json',
				beforeSend : function(xhr) {
				    xhr.setRequestHeader(header, token);
				},
				success: function(data) {
					let row = data.data.contents;
					console.log(data);
					console.log('데이터', row);
					grid.uncheckAll();
					grid.resetData(row);
				},
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패');
				}
			});

		});
		

	});
	

	// ----------- 초기화 -------------

	
	
	
	// 함수 영역 -------------------
	
	
	
	function select_code(rowdata) {
		select_group_code = rowdata['common_cc'];
		$.ajax({
			type: 'get',
			url: '/select_common_code',
			data: {
				code : select_group_code
			},
			success: function(data) {
				let row = data.data.contents;
				grid.resetData(row);
			},
			error : function(xhr, textStatus, errorThrown) {
				console.log('조회 실패');
			}
		});
	}

	function make_group_grid(gridData) {
		const dataSource = {
				  api: {
					    readData: {url: '/select_common_code', method: 'GET' },
					    createData: {url: '/insert_group_code', method: 'POST' },
					    updateData: {url: '/update_group_code', method: 'POST' },
					    modifyData: {url: '/modify_group_code', method: 'POST' },
						deleteData: {url: '/delete_group_code', method: 'POST' }
				  	}
				}
		
		group_grid = new tui.Grid({
			el : document.getElementById('group_grid'),
			data : dataSource,
			scrollX : false,
			scrollY : false,
			rowHeaders : [ // 헤더 추가
				{type : 'rowNum',}, 
				{type : 'checkbox',}, 
			],
			selectionUnit : 'row', // 행 선택
			bodyHeight : 600,
			columns : [ 
				{header : '코드명', name : 'common_gc', hidden: true},
				{header : '코드명', name : 'common_cc', sortable : true, editor: 'text', 
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				},
				{header : '항목명', name : 'common_nm', sortable : true, editor: 'text', 
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '설명', name : 'common_ct', sortable : true, editor: 'text', 
					filter: {
						type: 'text',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '사용여부', name : 'common_us', hidden: true }
			]
		});
		
	}

	function make_grid() {
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : [],
			scrollX : false,
			scrollY : false,
			rowHeaders : [
				{type : 'rowNum',}, 
				{type : 'checkbox',}, 
			],
			selectionUnit : 'row', // 행 선택
			bodyHeight : 600,
			columns : [ 
				{header : '코드명', name : 'common_cc', sortable : true, editor: 'text'},
				{header : '항목명', name : 'common_nm', sortable : true, editor: 'text'}, 
				{header : '설명', name : 'common_ct', sortable : true, editor: 'text'}, 
				{header : '정렬순서', name : 'common_in', sortable : true, editor: 'text'}, 
				{header : '사용여부', name : 'common_us', sortable : true, 
					editor: {
						type: 'select',
						options: {
							listItems : [
								{text : '사용', value : 'true'},
								{text : '미사용', value : 'false'}
							]
						}
					},
					formatter: function({value}) {
						return value == 'true' ? '사용' : value == 'false' ? '미사용' : '';
					}
				}, 
			]
		});
	}
</script>
</html>