<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<body>
		<main id="main" class="main">
			<div class="card">
				<div class="card-body">
					<h5 class="card-title">근태현황</h5>
					<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home"
								type="button" role="tab" aria-controls="pills-home" aria-selected="true">달력</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile"
								type="button" role="tab" aria-controls="pills-profile" aria-selected="false" onclick="grid_function()">그리드</button>
						</li>
					</ul>
					
					<!-- 본문 -->
					<div class="tab-content pt-2" id="myTabContent"> 
						<!-- 달력 -->
						<div class="text-center" id='btn_calendar'>
							<button type='button' class='btn btn-outline-secondary' id='btn_calendar_prev'>이전</button>
							<span id="title_calendar" class="d-inline-block text-center mx-4 fs-4 fw-bold" style="min-width: 140px;"></span>
							<button type='button' class='btn btn-outline-secondary' id='btn_calendar_next'>다음</button>
						</div>
						<div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="home-tab" style="height: 600px;">
						</div>
						
						<!-- 그리드 -->
						<div id='btn_grid'>
							<button type="button" class="btn btn-primary" id='btn_grid_filter' style="display: none;" data-bs-toggle="modal" data-bs-target="#modal_appointment_save">필터</button>
							<!-- 상세필터 모달 -->
							<div class="modal fade" id="modal_appointment_save" tabindex="-1" aria-labelledby="modal_appointment_save_label" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false" >
								<div class="modal-dialog modal-dialog-centered modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="modal_appointment_save_label">상세 필터</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<form id="modal_appointment_save" method="post" th:action="@{/select_ANNUAL}">
												<input type='hidden' id='employee_cd' name='employee_cd'>
												<div class="row mb-3">
													<div class="col">
														<label for="employee_nm" class="form-label">이름</label>
														<div class="input-group">
															<input type="text" id="employee_nm" class="form-control">
															<button type="button" title="Search" id="btn_employee_nm"><i class="ri-search-2-line"></i></button>
														</div>
													</div>
													<div class="col">
														<label for="employee_dp" class="form-label">부서</label> 
														<select id="employee_dp" class="form-select"></select>
													</div>
												</div>
												<div class="row mb-3">
													<label for="employee_hd" class="form-label">입사일</label> 
													<div class="col">
														<i class="ri-calendar-event-fill"></i><input type="text" id="employee_hd1" class="form-control" placeholder="YYYY-MM-DD">
													</div>
													<div class="col">
														<i class="ri-calendar-event-fill"></i><input type="text" id="employee_hd2" class="form-control" placeholder="YYYY-MM-DD">
													</div>
													<div id="wrapper1"></div>
													<div id="wrapper2"></div>
												</div>
												<div class="row mb-3">
													<div class="col">
														<label for="inputNumber" class="form-label">잔여연차</label>
														<input type="number" class="form-control" id="annual_ra" min="0" step="0.5" placeholder="0.5씩 증가">
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
													<button type="submit" class="btn btn-primary" id="btn_filter_annual">검색</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
							<!-- 이름 input 클릭 시 모달 -->
							<div class="modal fade" id="modal_employee_list" tabindex="-1"
								aria-labelledby="modal_employee_list_label" aria-hidden="true">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="modal_employee_list_label">사원 선택</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal"
												aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<table id="empTable" class="table table-striped">
												<thead>
													<tr>
														<th>사원코드</th>
														<th>이름</th>
														<th>부서</th>
														<th>직급</th>
														<th>선택</th>
													</tr>
												</thead>
												<tbody id="td_select_employee"></tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- 그리드 컨테이너 -->
						<div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="profile-tab"></div>
					</div>
				</div>
			</div>
			
		</main>
	</body>
	
	<script th:inline="javascript">
		const token = $("meta[name='_csrf']").attr("content");
		const header = $("meta[name='_csrf_header']").attr("content");
		let grid = null;
		const calendar_container = document.getElementById('pills-home');
		const btn_calendar = document.getElementById('btn_calendar');
		const btn_calendar_prev = document.getElementById('btn_calendar_prev');
		const btn_calendar_next = document.getElementById('btn_calendar_next');
		const btn_calendar_container = document.getElementById('pills-home-tab');
		const grid_container = document.getElementById('pills-profile');
		const btn_grid_filter = document.getElementById('btn_grid_filter');
		const isAdmin = /*[[${#authorization.expression('hasAnyRole("SYS_ADMIN", "AT_ADMIN")')}]]*/ false;
		
		
		
		// 첫 로딩
		window.onload = function(){
			make_calendar();
			
		}
		
		// 그리드
		
		// 상세필터 입사일 설정
		document.getElementById('modal_appointment_save').addEventListener('shown.bs.modal', function () {
			// Date Picker 초기화
			new tui.DatePicker('#wrapper1', {
				input: {
					element: '#employee_hd1',
					format: 'yyyy-MM-dd'
				},
			});
			new tui.DatePicker('#wrapper2', {
				input: {
					element: '#employee_hd2',
					format: 'yyyy-MM-dd'
				},
			});
		});
		
		function createSelectBox(el, list, title) {
		    const selectBox = $(el);

		    selectBox.empty();
			
			if(title) {
			    selectBox.append(`<option value="">${title}</option>`);		
			}

		    list.forEach(data => {
		        selectBox.append(`<option value="${data.common_cc}">${data.common_nm}</option>`);
		    });
		}
		
		// 이름 입력 검색
		document.getElementById('btn_employee_nm').addEventListener('click', function () {
		    const employee_nm = document.getElementById('employee_nm').value; // 입력된 이름 값

		    if (employee_nm) {
			    // Ajax 요청으로 사원 정보 가져오기
				$.ajax({
					type: "get",
					url: "/select_EMPLOYEE_ANNUAL",
					data: {"employee_nm" : employee_nm},
					success: function(result) {
						const modal_employee_list = new bootstrap.Modal(document.getElementById('modal_employee_list'));
						$("#td_select_employee").empty();
						result.forEach( employee =>{
							$("#td_select_employee").append( 
								"<tr><td>" +employee.employee_cd+"</td>"+
								"<td>" +employee.employee_nm+"</td>"+
								"<td>" +employee.employee_dp+"</td>"+
								"<td>" +employee.employee_gd+"</td>"+
								"<td><button class='btn btn-primary' id='select_emp_btn'>선택</button></td></tr>"
							)
						});
						modal_employee_list.show();
					},
					error : function(xhr, textStatus, errorThrown) {
						console.log('조회 실패', xhr.responseText);
					}
				});
		    }
			document.getElementById('employee_nm').focus();
		});
		
		$(document).on('click', '#select_emp_btn', function() {
		    // 클릭된 버튼의 부모 <tr>에서 데이터 가져오기
		    const row = $(this).closest('tr');
		    const employeeCd = row.find('td:nth-child(1)').text();
		    const employeeNm = row.find('td:nth-child(2)').text();
		    const employeeDp = row.find('td:nth-child(3)').text();
		    const employeeGd = row.find('td:nth-child(4)').text();
			
			$("#employee_cd").val(employeeCd);

		    // 부모창의 필드에 값 설정
		    $('#employee_nm').val(row.find('td:nth-child(2)').text());
			
		    // 모달 닫기
		    const modal_employee_list = bootstrap.Modal.getInstance(document.getElementById('modal_employee_list'));
		    modal_employee_list.hide();
		    
		});
		
		

		// btn_filter_annual 버튼 이벤트
		document.getElementById('btn_filter_annual').addEventListener('click', function (event) {
		    event.preventDefault(); // 기본 폼 제출 방지

		    const employee_cd = $("#employee_cd").val();
		    const employee_dp = $("#employee_dp").val();
		    const employee_hd1 = $("#employee_hd1").val();
		    const employee_hd2 = $("#employee_hd2").val();
		    const annual_ra = document.querySelector('input[type="number"]').value;

		    if (!employee_cd && !employee_dp && !employee_hd1 && !employee_hd2 && !annual_ra) {
		        alert("하나 이상 선택해주세요."); // 사용자에게 알림
		        return; // 요청 중단
		    }

		    // Ajax 요청
		    $.ajax({
		        type: "get",
		        url: "/select_ANNUAL",
		        data: {
		            "employee_cd": employee_cd,
		            "employee_dp": employee_dp,
		            "employee_hd1": employee_hd1,
		            "employee_hd2": employee_hd2,
		            "annual_ra": annual_ra,
		        },
		        success: function (result) {
		            if (grid) {
		                grid.resetData(result); // 기존 grid가 존재하면 데이터 리셋
						console.log(result);
						const modal_appointment_save = bootstrap.Modal.getInstance(document.getElementById('modal_appointment_save'));
						modal_appointment_save.hide();
		            } else {
		                console.error("그리드 객체가 정의되지 않았습니다.");
		            }
		        },
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패', xhr.responseText);
				}
		    });
		});

		// grid_function에서 grid 초기화 및 설정
		function grid_function() {
		    grid_container.innerHTML = '';
		    btn_calendar.style.display = "none";
		    btn_grid_filter.style.display = "block";

		    // 처음 불러오는 데이터
		    $.ajax({
		        type: "get",
		        url: "/select_APPROVAL_ANNUAL",
		        success: function (result) {
		            grid.resetData(result['data']);
		        },
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패', xhr.responseText);
				}
		    });

		    // 그리드 객체 생성 + 초기 세팅
		    grid = new tui.Grid({
		        el: grid_container,
		        scrollX: true,
		        scrollY: true,
		        columns: [
		            { header: '이름', name: 'EMPLOYEE_NM', align: 'center', sortable: true },
		            { header: '부서명', name: 'DEPARTMENT_NAME', align: 'center', sortable: true },
		            { header: '근속연수', name: 'SERVICE_YEARS', align: 'center', sortable: true },
		            { header: '사용연차', name: 'TOTAL_APPROVALS', align: 'center', sortable: true }, 
		            // { header: '잔여연차', name: 'ANNUAL_RA', align: 'center', sortable: true }, 아직 쿼리 추가 못함
		            { header: '총연차', name: 'ANNUAL_AA', align: 'center', sortable: true },
		        ],
		    });
		}
		
		// 캘린더
		// 달력 만들기
		function make_calendar(){ 
			btn_grid_filter.style.display = "none";
			calendar = new tui.Calendar(calendar_container, {
				usageStatistics: false,
				defaultView: 'month',
				isReadOnly: true,
				month: {
					isAlways6Weeks: false, // 해당 달만 표시 (6주 고정 아님)
				},
				theme: {
					common: {
						holiday: {
						    color: 'rgba(255, 64, 64)', // 공휴일 텍스트 색상
						},
						saturday: {
						    color: 'rgba(64, 64, 255)', // 토요일 텍스트 색상
						},
					},
				},
				calendars: [
					{
						id: 'cal1',
						name: '총결원',
						backgroundColor: '#03bd9e',
					},
					{
						id: 'cal2',
						name: '휴가자',
						backgroundColor: '#ffffff',
						borderLeft: '#ffffff',
					},
					{
						id: 'cal3',
						name: '출장',
						backgroundColor: '#ffffff',
					},
				]
			});
			
			updateCalendarTitle(); // 년월 타이틀
			getCalendarList(); // 출퇴근 목록 조회
			
			calendar.on('clickDayname', function(event) {
			    const clickedDate = event.date; // 클릭된 날짜 정보
			    console.log('클릭된 날짜:', clickedDate);
			});
		    
		    calendar.on('clickEvent', ({ event }) => {
					modal_detail(event);
			});

		};
		
		function modal_detail(data) {
			let date = getDate(data.start);
			let title = `${date} 기록부`;

			const div_modal = 'div_COMMUTE_modal';
			let modalElement = document.getElementById('#${div_modal}');
			
			if(!modalElement) {
				let modalHtml = `
				<div class="modal" id="${div_modal}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
					<div class="modal-dialog modal-dialog-centered modal-xl">
			            <div class="modal-content">
							<div class="modal-header">
			            		<h5 class="modal-title">${title}</h5>
			                	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<div id="modal_grid"></div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
								<button type="button" class="btn btn-primary" id="btn_COMMUTE_show">등록</button>
							</div>
						</div>
					</div>
				</div>
				`;
				
				document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
				
				modalElement = document.getElementById(div_modal); // 새로 추가된 모달 참조
			}
			const modal = new bootstrap.Modal(modalElement);  // 모달 초기화
			

			
	        modalElement.addEventListener('shown.bs.modal', function () {
	        	make_modal_grid(date);
				
				$('#btn_COMMUTE_show').on('click', function() {
					make_insert_COMMUTE_modal(date, '', 'insert');
				});
	        });
			
			modalElement.addEventListener('hidden.bs.modal', function () {
	/* 			$('button, input, select, textarea').each(function () {
	                $(this).blur();
	            }); */
				modalElement.remove();
			});
			
			modal.show();
		}
		
		// 달력 제목 업데이트
		function updateCalendarTitle() {
		    const currentDate = calendar.getDate();
		    const year = currentDate.getFullYear();
		    const month = currentDate.getMonth() + 1;
		    const formattedDate = `${year}년 ${month}월`;
		    $("#title_calendar").empty().text(formattedDate);
		}
		
		// 년월일 -> 문자열 리턴
		function getDate(date) {
	        const year = date.getFullYear();
	        const month = String(date.getMonth() + 1).padStart(2, '0');
	        const day = String(date.getDate()).padStart(2, '0');
	        return `${year}-${month}-${day}`;
		}
		
		// 시분초 -> 문자열 리턴
		function getTime(date) {
		    const hours = String(date.getHours()).padStart(2, '0');
		    const minutes = String(date.getMinutes()).padStart(2, '0');
		    const seconds = String(date.getSeconds()).padStart(2, '0');
		    return `${hours}:${minutes}:${seconds}`;
		}
		
		// 년월일 시분초 -> 문자열 리턴
		function getDateTime(date) {
		    // 날짜 포맷팅
		    const year = date.getFullYear();
		    const month = String(date.getMonth() + 1).padStart(2, '0');
		    const day = String(date.getDate()).padStart(2, '0');
		    // 시간 포맷팅
		    const hours = String(date.getHours()).padStart(2, '0');
		    const minutes = String(date.getMinutes()).padStart(2, '0');
		    const seconds = String(date.getSeconds()).padStart(2, '0');
		    
		    return `${year}년 ${month}월 ${day}일 ${hours}:${minutes}:${seconds}`;
		}
		
		// 달력 데이터 조회
		function getCalendarList() {
			calendarStartDate = getDate(calendar.getDateRangeStart().toDate());
			calendarEndDate = getDate(calendar.getDateRangeEnd().toDate());
			$.ajax({
				type: 'post',
				url: '/select_COMMUTE_calendar',
				contentType: 'application/json',
				beforeSend : function(xhr) {
				    xhr.setRequestHeader(header, token);
				},
				data: JSON.stringify({
				    calendarStartDate: calendarStartDate,
				    calendarEndDate: calendarEndDate
				}),
				success: function(data) {
					if(!data['result']) {
						showAlert('', 'error', '기록부 조회 실패', '기록부 조회에 실패하였습니다.<br>다시 접속해주세요.');
					} else {
						// 캘린더 템플릿 업데이트
						calendar.setOptions({
							template: {
								monthGridHeader: function(model) {
									const date = model.date;
									const dayNum = date.split('-')[2];
									const holiday = data.holidayList.find(h => h.holiday_dt == date);
									const isToday = date == getDate(new Date());
									if(holiday) {
										return `
										<span class="tui-full-calendar-weekday-grid-date ms-1" style="color: #ff4040">
											${dayNum}
											<span class="holiday-name" style="font-size: 12px;">
												${holiday.holiday_nm}
											</span>
										</span>`;
									}
									if(isToday) {
						                return `<span class="toastui-calendar-weekday-grid-date 
										toastui-calendar-weekday-grid-date-decorator 
										toastui-calendar-template-monthGridHeader" style="color: #fff">${dayNum}</span>`;
						            }
						            return `<span class="tui-full-calendar-weekday-grid-date">${dayNum}</span>`;
								},
								time: function(schedule) {
								    return `<span class="calendar-event" 
								        data-bs-toggle="tooltip" 
								        data-bs-placement="top" 
								        title="${schedule.title}">
								        ${schedule.title}
								    </span>`;
								}
							}
						});
						   
						// calendar.render();
						calendar.clear();
										
						let list = data['list'];
						const event = list.map(commute => {
						    if (isAdmin) {
						        return {
						            id: `${commute.commute_wd}`,
						            title: `${commute.total} ()`,
						            start: commute.commute_wd,
						            end: commute.commute_wd,
						            isAllday: true,
						            category: 'allday',
						            backgroundColor: '#fff'
						        };
						    } else {
						        let title = '';
						        if (commute.commute_wt) {
						            // 출근 시간 포맷팅 (02:01:39 -> 02:01)
						            const startTime = commute.commute_wt;
						            title = commute.commute_lt 
						                ? `${startTime} ~ ${commute.commute_lt}` 
						                : `${startTime} ~`;
						        }
						        
						        return {
						            id: `${commute.commute_wd}`,
						            title: title,
						            start: commute.commute_wd,
						            end: commute.commute_wd,
						            isAllday: true,
						            category: 'allday',
						            backgroundColor: '#fff'
						        };
						    }
						});
						calendar.createEvents(event);
					}
				},
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패');
				}
			});
		}
		
		btn_calendar_container.addEventListener('click',function(){
			btn_grid_filter.style.display = "none";
		});
		
	</script>
</html>