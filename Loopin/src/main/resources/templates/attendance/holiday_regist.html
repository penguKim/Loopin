<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<body>
		<main id="main" class="main">
			<div class="card">
				<div class="card-body">
					<div class="d-flex align-items-center justify-content-between">
						<h5 class="card-title">휴일 등록</h5>
						<div>
							<input type="button" id="btn_group_remove" class="btn btn-primary" value="삭제">
							<input type="button" id="btn_group_add" class="btn btn-primary" value="행추가">
							<input type="button" id="btn_group_insert" class="btn btn-primary" value="등록" data-bs-toggle="modal" data-bs-target="#verticalycentered">
						</div>
					</div>
					<!-- 그리드 컨테이너 -->
					<div id="grid"></div>
				</div>
			</div>
		</main>
	</body>
<script th:inline="javascript">
	// 변수 지정
	let grid;
	let sub_grid;
	let group_code = '';
	let changeFlag = false; // 그리드 변경 전 이벤트 판별 플래그
	let group_row = {};
	const btn_group_remove = $('#btn_group_remove');
	const btn_group_add = $('#btn_group_add');
	const btn_group_insert = $('#btn_group_insert');
	const btn_code_remove = $('#btn_code_remove');
	const btn_code_add = $('#btn_code_add');
	const btn_code_insert = $('#btn_code_insert');
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	
	
	// ------------------------------
	
	$(function() {
		make_grid();
		
		// 행 추가
		btn_group_add.on('click', function() {
		   const newRowKey = grid.appendRow(
			        {
			            "holiday_dt": '',
			            "holiday_nm": '',
			        },
			        { focus: true }
			    );
		});
		
		// 행 등록
		btn_group_insert.on('click', function(ev) {
			insert_code(grid);
		});
		
		// 행 데이터 삭제
		btn_group_remove.on('click', function() {
			let checkedRows = grid.getCheckedRows();
			if (checkedRows.length == 0) {
				Swal.fire({
				    icon: "warning",
				    title: "삭제 항목 체크",
				    text: "삭제할 항목을 체크해주세요.",
				});
			    return;
			}
			let newRows = checkedRows.filter(row => row['common_gc'] == null);
			checkedRows = checkedRows.filter(row => row['common_gc'] != null);
			
			if(checkedRows.length > 0) {
				delete_code(grid, checkedRows);				
			}
		    if (newRows.length > 0) {
		    	newRows.forEach(row => {
		    		grid.removeRow(row.rowKey);
		    	});
		    }
		});
		

	});
	
	
	// 함수 영역 -------------------
	function insert_company_HOLIDAY(grid) {
		let validationResult = grid.validate();
		const valChecked = validationResult.some(row => {
		    const rowKey = row['rowKey'];

		    return row.errors.some(cell => {
		        const columnName = cell['columnName'];

		        const column = grid.getColumns().find(col => col['name'] === columnName);
		        const header = column['header'];
				const errorType = cell.errorCode[0];
				
				let msg = '';
				if (errorType == 'REGEXP') {
				    msg = `${rowKey + 1}행의 ${header}은(는) 올바른 형식이 아닙니다.`;
				} else if (errorType == 'REQUIRED') {
				    msg = `${rowKey + 1}행의 ${header}을(를) 입력해주세요.`;
				}
				Swal.fire({
				    icon: "error",
				    title: "입력 체크",
				    text: `${rowKey + 1}행의 ${header}은(는) 올바른 형식이 아닙니다.`,
				});

				grid.focus(rowKey, columnName);
		        
		        return true;	
		    });
		});

		if (valChecked) {
		    return;
		}

		const modifiedData = grid.getModifiedRows();
		const createdRows = modifiedData.createdRows;
		const updatedRows = modifiedData.updatedRows;

		if(grid != grid && group_code == '') {
			Swal.fire({
			    icon: "warning",
			    title: "공통 코드 선택",
			    text: "공통 코드를 선택해주세요.",
			});
			return;
		}
		
		if(createdRows.length == 0 && updatedRows.length == 0) {
			Swal.fire({
			    icon: "warning",
			    title: "등록 항목 체크",
			    text: "등록할 항목이 없습니다.",
			});
			return;
		}

		const json = {
			createdRows: createdRows,
			updatedRows: updatedRows,
			code: grid == grid ? '' : group_code
		}
		
		let icon = 'success';
		let title = '등록 성공';
		let text = '등록하였습니다.';
		
		const jsonData = JSON.stringify(json);			
		$.ajax({
			type: 'post',
			url: '/insert_company_HOLIDAY',
			data: jsonData,
			contentType: 'application/json',
			beforeSend : function(xhr) {
			    xhr.setRequestHeader(header, token);
			},
			success: function(data) {
				if(!data['result']) {
					let icon = 'error';
					let title = '등록 실패';
					let text = '등록에 실패하였습니다.';
				} else {
					const row = data.data.contents;
					grid.uncheckAll();
					// grid.focus(-1);
					grid.resetData(row);
				}
				
				Swal.fire({
				    icon: icon,
				    title: title,
				    text: text,
				});
			},
			error : function(xhr, textStatus, errorThrown) {
				console.log('조회 실패');
			}
		});
	}

	// 코드 삭제
	function delete_company_HOLIDAY(grid, rows) {
		let msg = '선택한 항목을 삭제하시겠습니까?';
		
		const json = {
				deletedRows: rows,
				code: group_code
			}
			
		const jsonData = JSON.stringify(json);	
		
		Swal.fire({
		   icon: 'warning',
		   title: '선택 항목 삭제',
		   html: msg,
		   
		   showCancelButton: true,
		   confirmButtonColor: '#0d6efd',
		   cancelButtonColor: '#6c757d',
		   confirmButtonText: '승인',
		   cancelButtonText: '취소',
		   
		   reverseButtons: true, // 버튼 순서 거꾸로
		   
		}).then(result => {
			if (result.isConfirmed) { 
				$.ajax({
					type: 'post',
					url: '/delete_company_HOLIDAY',
					data: jsonData,
					contentType: 'application/json',
					beforeSend : function(xhr) {
					    xhr.setRequestHeader(header, token);
					},
					success: function(data) {
						let row = data.data.contents;
						grid.resetData(row);
					},
					error : function(xhr, textStatus, errorThrown) {
						console.log('조회 실패');
					}
				});
			}
		});
	}
	
	function make_grid(gridData) {
		const dataSource = {
		  api: {
			    readData: {url: '/select_HOLIDAY', method: 'GET' },
		  	}
		}
		
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : dataSource,
			scrollX : false,
			scrollY : false,
			rowHeaders : [ // 헤더 추가
				{type : 'rowNum',}, 
				{type : 'checkbox',}, 
			],
			selectionUnit : 'row', // 행 선택
			bodyHeight : 590,
			columns : [ 
				{header : '기존 코드명', name : 'before_holiday_dt', hidden: true},
				{header : '날짜', name : 'holiday_dt', sortable : true, editor: 'text',
					validation: {
						required: true,
						regExp: /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/
					},
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				},
				{header : '휴일 이름', name : 'holiday_nm', sortable : true, editor: 'text',
					validation: {
						required: true,
						regExp: /^[^ㄱ-ㅎㅏ-ㅣ가-힣]*$/
					},
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '설명', name : 'common_ct', sortable : true, editor: 'text',
					filter: {
						type: 'text',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '사용여부', name : 'common_us', hidden: true }
			]
		});
		
		grid.on('beforeChange', ev => {
			if (changeFlag) {
			    return;
			}
			const row = ev['changes'][0];
			
			if(row['columnName'] == 'holiday_dt') {
				changeFlag = true;
				sub_grid.setValue(row['rowKey'], 'beforeholiday_dt', row['value']);
				changeFlag = false;
			}
		  
		});
	}
	
		
	// 모달 초기화
	$('.modal').on('hidden.bs.modal', function (e) {
	    $(this).find('form')[0].reset();
	}); 
	
	
	

</script>
</html>