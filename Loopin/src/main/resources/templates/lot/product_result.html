<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="card">
					<div class="card-body">
						<h1 class="card-title">로트 추적</h1>
						<ul class="nav nav-pills mb-3" id="lot-tab" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active" id="btn_grid_tab" data-bs-toggle="pill" data-bs-target="#tab_grid" 
								type="button" role="tab" aria-controls="tab_grid" aria-selected="true">그리드</button>
							</li>
							<li class="nav-item" role="presentation">
								<button class="nav-link" id="btn_chart_tab" data-bs-toggle="pill" data-bs-target="#tab_chart" 
								type="button" role="tab" aria-controls="tab_chart" aria-selected="false">차트</button>
							</li>
						</ul>
						<div class="tab-content pt-2" id="myTabContent">
							<!-- 달력 탭 -->
							<div class="tab-pane fade show active" id="tab_grid" role="tabpanel" aria-labelledby="chart-tab">
								<div id="filterModule" class="mb-3"></div>
								<div id="grid"></div>
							</div>
							<!-- 그리드 탭 -->
							<div class="tab-pane fade" id="tab_chart" role="tabpanel" aria-labelledby="grid-tab">
								<div class="row mb-3">
									<div class="col-sm-6">
										<div id="dayCommute_line"></div>
									</div>
									<div class="col-sm-6">
										<div id="commute_column"></div>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6">
										<div id="grade_bar"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>																																																																																																																																																																																																																											
<script th:inline="javascript">
	let grid, modal_grid;
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	const filterConfig = [
	    { key: 'product_cd', label: '품목코드', type: 'text', placeholder: '품목코드 입력', col: 'col' },
	    { key: 'product_nm', label: '품목명', type: 'text', placeholder: '품목명 입력', col: 'col' },
	    { key: 'product_cc', label: '품목분류', type: 'select', list: [], col: 'col' },
	    { key: 'product_wh', label: '보관창고', type: 'select', list: [], col: 'col' },
	    { key: 'product_us', label: '사용여부', type: 'radio', list: ['계획중', '진행중', '최종완료'], col: 'col' },
	];
	
	// 로딩
	$(function() {
		tui.Grid.setLanguage('ko');
		tui.Grid.applyTheme('striped');
		make_grid();
		setElementHeight('.card', -105);
		setGridHeight(grid, -380);
		
		$(window).resize(function() {
			setTimeout(() => {
				setElementHeight('.card', -105);
				setGridHeight(grid, -380);
				setGridWidth(grid, 0);
			}, 300);
		});
		
		// 검색필터
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
        	get_PRODUCT_list(filterValues, groupValue);
        });
		
        $(document).on('filterToggled', function(e) {
		    if(e.detail.isVisible) {
		        setGridHeight(grid, -450);
		    } else {
		        setGridHeight(grid, -380);
		    }
		});
		
		// 필터 엔터키 검색 이벤트
		$('#filterModule').on('keypress', function(e) {
		    if (e.keyCode !== 13) return;
		    
		    const filterValues = {};
		    
		    for (const config of filterConfig) {
		        const input = $(`#${config.key}`);
		        const value = input.val();
		        filterValues[config.key] = value;
		    }
		});
		
	});
	
	// ------------함수------------
	// 그리드 생성 함수
	function make_grid() {
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : [
				{
					lot_cd: '10012',
					contract_cd: 'Seoul',
					product_cd: 'South Korea',
					product_cr: 'South Korea',
					product_sz: 'South Korea',
					lot_st: 'South Korea',
					workorder_st: false,
				},
				{
					lot_cd: '10013',
					contract_cd: 'Seoul',
					product_cd: 'South Korea',
					product_cr: 'South Korea',
					product_sz: 'South Korea',
					lot_st: 'South Korea',
					workorder_st: true,
				},
				{
					lot_cd: '10014',
					contract_cd: 'Seoul',
					product_cd: 'South Korea',
					product_cr: 'South Korea',
					product_sz: 'South Korea',
					lot_st: 'South Korea',
					workorder_st: true,
				},
			  ],
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
				{type : 'checkbox',}, 
			],
			bodyHeight : 400,
			columns : [
				{header : '로트번호', name : 'lot_cd', sortable : true, filter: 'text'},
				{header : '수주번호', name : 'contract_cd', sortable : true, filter: 'text'},
				{header : '공정명', name : 'product_cd', sortable : true, filter: 'text'},
				{header : '색상', name : 'product_cr', sortable : true, filter: 'text'}, 
				{header : '사이즈', name : 'product_sz', sortable : true, filter: 'text'}, 
				{header : '생성일자', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '완료여부', name : 'workorder_st', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? '최종완료' : value == false ? '진행중' : '';
					}
				}, 
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `총 ${valueMap.cnt} 건`
						}
					}
				}
			},

		});
		
		
		grid.on('dblclick', function(ev) {
			let row = grid.getRow(ev.rowKey);
			if(row == null) {
				return;
			}
			modal_detail(row);
		});
	}
	
	
	// 모달 생성
	function modal_detail(data) {
		const div_modal = 'div_modal';
		let modalElement = document.getElementById('#${div_modal}');
		
		if(!modalElement) {
			let modalHtml = `
			<div class="modal" id="${div_modal}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
				<div class="modal-dialog modal-dialog-centered modal-xl">
		            <div class="modal-content">
						<div class="modal-header">
		            		<h5 class="modal-title">실적 상세조회</h5>
		                	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div id="modal_grid"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
						</div>
					</div>
				</div>
			</div>
			`;
			
			document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
			
			modalElement = document.getElementById(div_modal); // 새로 추가된 모달 참조
		}
		const modal = new bootstrap.Modal(modalElement);  // 모달 초기화
		

		
        modalElement.addEventListener('shown.bs.modal', function () {
			console.log(data);
        	make_modal_grid(data);
			
        });
		
		modalElement.addEventListener('hidden.bs.modal', function () {
/* 			$('button, input, select, textarea').each(function () {
                $(this).blur();
            }); */
			modalElement.remove();
		});
		
		modal.show();
		
		$(window).resize(function() {
			setGridHeight(modal_grid, -600);
		});
	}
	
	// 모달 그리드 생성
	function make_modal_grid(data) {
		modal_grid = new tui.Grid({
			el : document.getElementById('modal_grid'),
			data : [
			  ],
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
				{type : 'checkbox',}, 
			],
			bodyHeight : 200,
			columns : [
				{header : '로트번호', name : 'lot_cd', sortable : true, filter: 'text'},
				{header : '수주번호', name : 'contract_cd', sortable : true, filter: 'text'},
				{header : '공정명', name : 'product_cd', sortable : true, filter: 'text'},
				{header : '색상', name : 'product_cr', sortable : true, filter: 'text'}, 
				{header : '사이즈', name : 'product_sz', sortable : true, filter: 'text'}, 
				{header : '작업시작일', name : 'lothistory_st', sortable : true, filter: 'text'}, 
				{header : '작업종료일', name : 'lothistory_en', sortable : true, filter: 'text'}, 
				{header : '작업수량', name : 'lothistory_wq', sortable : true, filter: 'text'}, 
				{header : '불량수량', name : 'lothistory_bq', sortable : true, filter: 'text'}, 
				{header : '완료여부', name : 'workorder_st', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? '사용' : value == false ? '미사용' : '';
					}
				}, 
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `총 ${valueMap.cnt} 건`
						}
					}
				}
			},

		});
		
	}
	
</script>
</html>