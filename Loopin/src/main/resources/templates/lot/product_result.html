<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="card">
					<div class="card-body">
						<h1 class="card-title">생산 실적</h1>
						<ul class="nav nav-pills mb-3" id="lot-tab" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active" id="btn_grid_tab" data-bs-toggle="pill" data-bs-target="#tab_grid" 
								type="button" role="tab" aria-controls="tab_grid" aria-selected="true">그리드</button>
							</li>
							<li class="nav-item" role="presentation">
								<button class="nav-link" id="btn_chart_tab" data-bs-toggle="pill" data-bs-target="#tab_chart" 
								type="button" role="tab" aria-controls="tab_chart" aria-selected="false">차트</button>
							</li>
						</ul>
						<div class="tab-content pt-2" id="myTabContent">
							<div id="filterModule" class="mb-3"></div>
							<!-- 달력 탭 -->
							<div class="tab-pane fade show active" id="tab_grid" role="tabpanel" aria-labelledby="grid-tab">
								<div id="grid"></div>
							</div>
							<!-- 그리드 탭 -->
							<div class="tab-pane fade" id="tab_chart" role="tabpanel" aria-labelledby="chart-tab">
								<div class="row mb-3">
									<div class="col-sm-6">
										<div id="dayCommute_line"></div>
									</div>
									<div class="col-sm-6">
										<div id="commute_column"></div>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6">
										<div id="grade_bar"></div>
									</div>
									<div class="col-sm-6">
										<div id="dept_bar"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>																																																																																																																																																																																																																											
<script th:inline="javascript">
	let grid, modal_grid, rangePicker;
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	let date = new Date();
	let useList = /*[[${commonList['USE']}]]*/[];
	let productList = /*[[${commonList['PRDTYPE']}]]*/[];
	const today = new Date();
	const oneMonthAgo = new Date();
	oneMonthAgo.setMonth(date.getMonth() - 1);
	const filterConfig = [
		{ key: 'startDate', label: '조회기간 시작일', type: 'daterangepicker', format: 'YYYY-MM-dd', value:oneMonthAgo },
		{ key: 'endDate', label: '조회기간 종료일', type: 'daterangepicker', format: 'YYYY-MM-dd', value: getDate(today) },
	    { key: 'product_nm', label: '수주번호', type: 'text', placeholder: '품목명 입력', col: 'col-4' },
	    { key: 'product_cd', label: '제품명', type: 'select', list: [], col: 'col-4' },
	    { key: 'product_cd', label: '품목명', type: 'text', placeholder: '품목코드 입력', col: 'col-4' },
	    { key: 'product_wh', label: '품목명', type: 'select', list: setFilterList(productList), col: 'col-4' },
	    { key: 'product_wh', label: '보관창고', type: 'select', list: setFilterList(productList), col: 'col-4' },
	    { key: 'product_us', label: '사용여부', type: 'radio', list: [ 
			{ value: 'ALL', text: '전체' },
			{ value: 'PENDING', text: '대기' },
			{ value: 'IN_PROGRESS', text: '진행중' },
			{ value: 'COMPLETED', text: '완료' }
		], col: 'col' },
	];
	
	// 로딩
	$(function() {
		tui.Grid.setLanguage('ko');
		tui.Grid.applyTheme('striped');
		make_grid();
		getGridList();
		setElementHeight('.card', -105);
		setGridHeight(grid, -380);
		
		$(window).resize(function() {
			setTimeout(() => {
				setElementHeight('.card', -105);
				setGridHeight(grid, -380);
				setGridWidth(grid, 0);
			}, 300);
		});
		
		// 검색필터
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            getGridList(filterValues);
        });
		
        $(document).on('filterToggled', function(e) {
		    if(e.detail.isVisible) {
		        setGridHeight(grid, -450);
		    } else {
		        setGridHeight(grid, -380);
		    }
		});
		
		// 필터 엔터키 검색 이벤트
		$('#filterModule').on('keypress', function(e) {
		    if (e.keyCode !== 13) return;
		    
		    const filterValues = {};
		    
		    for (const config of filterConfig) {
		        const input = $(`#${config.key}`);
		        const value = input.val();
		        filterValues[config.key] = value;
		    }
		});
		
		rangePicker = tui.DatePicker.createRangePicker({
		    startpicker: {
		        date: oneMonthAgo,
		        input: '#rangeStart',
		        container: '#rangeStartContainer'
		    },
		    endpicker: {
		        date: date,
		        input: '#rangeEnd',
		        container: '#rangeEndContainer',
		        disabled: false
		    },
		    format: 'yyyy-MM-dd',
		    language: 'ko',
		});
		
		rangePicker.on('change:start', function(event) {
		    if (event && event.date) {
		        rangePicker.setEndDate(event.date);
		        rangePicker.enableEndPicker();
		    }
		});
		
	});
	
	// ------------함수------------
	// 그리드 데이터 함수
	async function getGridList(filter) {
		let jsonData = JSON.stringify(filter);
		let ajaxData = await callAjaxPost('/select_RESULT_list', jsonData);
		grid.resetData(ajaxData.data);
	}
	
	// 그리드 생성 함수
	function make_grid() {
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : [],
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
				{type : 'checkbox',}, 
			],
			bodyHeight : 600,
			columns : [
				{header : '수주번호', name : 'contract_cd', sortable : true, filter: 'text'},
				{header : '제품명', name : 'product_cd', sortable : true, filter: 'text'},
				{header : '소요시간', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '소요량', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '지시수량', name : 'productplan_js', sortable : true, filter: 'text'}, 
				{header : '양품수량', name : 'inout_nn', sortable : true, filter: 'text'}, 
				{header : '불량수량', name : 'inout_fn', sortable : true, filter: 'text'}, 
				{header : '판매단가', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '실적금액', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '출하일', name : 'lot_st', sortable : true, filter: 'text'}, 
				{header : '완료여부', name : 'workorder_st', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? '최종완료' : value == false ? '진행중' : '';
					}
				},
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `총 ${valueMap.cnt} 건`
						}
					}
				}
			},

		});
		
		
		grid.on('dblclick', function(ev) {
			let row = grid.getRow(ev.rowKey);
			if(row == null) {
				return;
			}
			modal_detail(row);
		});
	}
	
	
	// 모달 생성
	function modal_detail(data) {
		const div_modal = 'div_modal';
		let modalElement = document.getElementById('#${div_modal}');
		
		if(!modalElement) {
			let modalHtml = `
			<div class="modal" id="${div_modal}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
				<div class="modal-dialog modal-dialog-centered modal-xl">
		            <div class="modal-content">
						<div class="modal-header">
		            		<h5 class="modal-title">실적 상세조회</h5>
		                	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div id="modal_grid"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
						</div>
					</div>
				</div>
			</div>
			`;
			
			document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
			
			modalElement = document.getElementById(div_modal); // 새로 추가된 모달 참조
		}
		const modal = new bootstrap.Modal(modalElement);  // 모달 초기화
		

		
        modalElement.addEventListener('shown.bs.modal', function () {
			console.log(data);
        	make_modal_grid(data);
			
        });
		
		modalElement.addEventListener('hidden.bs.modal', function () {
			modalElement.remove();
		});
		
		modal.show();
		
		$(window).resize(function() {
			setGridHeight(modal_grid, -600);
		});
	}
	
	// 모달 그리드 생성
	function make_modal_grid(data) {
		modal_grid = new tui.Grid({
			el : document.getElementById('modal_grid'),
			data : [
			  ],
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
				{type : 'checkbox',}, 
			],
			bodyHeight : 200,
			columns : [
				{header : '로트번호', name : 'lot_cd', sortable : true, filter: 'text'},
				{header : '수주번호', name : 'contract_cd', sortable : true, filter: 'text'},
				{header : '공정명', name : 'product_cd', sortable : true, filter: 'text'},
				{header : '색상', name : 'product_cr', sortable : true, filter: 'text'}, 
				{header : '사이즈', name : 'product_sz', sortable : true, filter: 'text'}, 
				{header : '작업시작일', name : 'lothistory_st', sortable : true, filter: 'text'}, 
				{header : '작업종료일', name : 'lothistory_en', sortable : true, filter: 'text'}, 
				{header : '작업수량', name : 'lothistory_wq', sortable : true, filter: 'text'}, 
				{header : '불량수량', name : 'lothistory_bq', sortable : true, filter: 'text'}, 
				{header : '완료여부', name : 'workorder_st', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? '사용' : value == false ? '미사용' : '';
					}
				}, 
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `총 ${valueMap.cnt} 건`
						}
					}
				}
			},

		});
		
	}
	
	// 차트 데이터 조회
	function getChartList(filter) {
		const data = {
					filter: filter || 
		        {
		        	startDate: rangeStart.val(),
		    	 	endDate: rangeEnd.val() 
		    	 }
		    };

		$.ajax({
			type: 'post',
			url: '/select_RESULT_list',
			contentType: 'application/json',
			data: JSON.stringify(data),
			beforeSend : function(xhr) {
			    xhr.setRequestHeader(header, token);
			},
			success: function(response) {
				commuteLineChart(response['dayCommuteChart']);
				commuteColumnChart(response['commuteChart']);
				gradeBarChart(response['gradeChart']);
				deptBarChart(response['deptChart']);
			},
			error : function(xhr, textStatus, errorThrown) {
				console.log(xhr);
				showAlert('', 'error', '차트 조회 실패' , '차트 조회에 실패하였습니다.<br>다시 접속해주세요.');
			}
		});
	}
	
</script>
</html>