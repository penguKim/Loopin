<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
	.orgchart{
		background-image: none;
		display: flex;
		justify-content: space-evenly;
		align-items: center;
		overflow: auto; /* í•„ìš”í•˜ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
	}
	.orgchart .node .title{
		background-color: none !important;
	}
	@keyframes blink {
	    0% { opacity: 1;}
	    35% { opacity: 0.2;}
	    100% { opacity: 1;}
	}
	.blinking-node {
	    animation: blink 3s infinite;
	    color: red;
	    background-color: white;
	}
	.wide-header {
	    min-width: 200px !important;  /* âœ… ì›í•˜ëŠ” ë„ˆë¹„ ì§€ì • */
	    white-space: normal !important;  /* âœ… í…ìŠ¤íŠ¸ ì¤„ ë°”ê¿ˆ */
	    text-align: center;
	}
</style>
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="col-lg-6">
					<div class="card">
						<div class="card-body">
							<h1 class="card-title">ë¡œíŠ¸ ì¶”ì </h1>
							<div class="mb-3 row d-flex align-items-center justify-content-end">
								<div class="col-auto">
									<div id="filterModule" class="mb-3"></div>
								</div>
							</div>
							<div id="grid"></div>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card">
						<div class="card-body">
							<h1 class="card-title">ì°¨íŠ¸</h1>
							<div id="chart"></div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>																																																																																																																																																																																																																											
<script th:inline="javascript">
	let grid, modal_grid;
	let chart = $("#chart");
	let useList = /*[[${commonList['USE']}]]*/[];
	let productList = /*[[${commonList['PRDTYPE']}]]*/[];
	let processList = /*[[${processList}]]*/ [];

	let transformedProcessList = processList.map(item => {
	    return {
	        common_cc: item.COMMON_CC,
	        common_nm: item.COMMON_NM
	    };
	});

	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	const filterConfig = [
		{ key: 'lot_cd', label: 'ë¡œíŠ¸ë²ˆí˜¸', type: 'text', placeholder: 'ë¡œíŠ¸ë²ˆí˜¸ ì…ë ¥', col: 'col-4' },
		{ key: 'contract_cd', label: 'ìˆ˜ì£¼ë²ˆí˜¸', type: 'text', placeholder: 'ìˆ˜ì£¼ë²ˆí˜¸ ì…ë ¥', col: 'col-4' },
		{ key: 'product_cd', label: 'ì œí’ˆëª…', type: 'text', placeholder: 'ì œí’ˆëª… ì…ë ¥', col: 'col-4' },
		{ key: 'process_cd', label: 'ê³µì •ëª…', type: 'select', list: setFilterList(transformedProcessList), col: 'col-4' },
		{ key: 'workorder_st', label: 'ì™„ë£Œì—¬ë¶€', type: 'radio', list: [ 
				{ value: 'ALL', text: 'ì „ì²´', checked: true },
				{ value: 'PENDING', text: 'ëŒ€ê¸°' },
				{ value: 'IN_PROGRESS', text: 'ì§„í–‰ì¤‘' },
				{ value: 'COMPLETED', text: 'ì™„ë£Œ' }
			], col: 'col' },
	];
	
	// ë¡œë”©
	$(function() {
		tui.Grid.setLanguage('ko');
		tui.Grid.applyTheme('striped');
		make_grid();
		getGridList();
		
		// ì°½í¬ê¸°
		setElementHeight('.card', -105);
		setGridHeight(grid, -430);
		
		$(window).resize(function() {
			setTimeout(() => {
				setElementHeight('.card', -105);
				setGridHeight(grid, -430);
				setGridWidth(grid, 0);
			}, 300);
		});

        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            getGridList(filterValues);
        });
		
		// ì—‘ì…€ ë²„íŠ¼ ì¶”ê°€
		addExcelButton(grid, 'ë¡œíŠ¸ì¶”ì ');
		
		$(document).on('filterToggled', function(e) {
		    if(e.detail.isVisible) {
		        setGridHeight(grid, -460);
		    } else {
		        setGridHeight(grid, -430);
		    }
		});
		
		// í•„í„° ì—”í„°í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
		$('#filterModule').on('keypress', function(e) {
		    if (e.keyCode !== 13) return;
		    
		    const filterValues = {};
		    
		    for (const config of filterConfig) {
		        const input = $(`#${config.key}`);
		        const value = input.val();
		        filterValues[config.key] = value;
		    }
		    getGridList(filterValues);
		});
	});
	
	// ------------í•¨ìˆ˜------------
	// ê·¸ë¦¬ë“œ ë°ì´í„° í•¨ìˆ˜
	async function getGridList(filter) {
		let jsonData = JSON.stringify(filter);
		let ajaxData = await callAjaxPost('/select_LOT_list', jsonData);
		grid.resetData(ajaxData.data);
	}
	
	// ê·¸ë¦¬ë“œ ìƒì„± í•¨ìˆ˜
	function make_grid() {
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : [],
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
			],
			bodyHeight : 400,
			columns : [
				{header : 'ë¡œíŠ¸ë²ˆí˜¸', name : 'LOT_CD', sortable : true, filter: 'text', width: 200,},
				{header : 'ìˆ˜ì£¼ë²ˆí˜¸', name : 'CONTRACT_CD', sortable : true, filter: 'text'},
				{header : 'ì œí’ˆëª…', name : 'PRODUCT_CD', sortable : true, filter: 'text'},
				{header : 'ê³µì •ëª…', name : 'PROCESS_CD', sortable : true, filter: 'text'},
				{header : 'ìƒì„±ì¼ì', name : 'LOT_CR', sortable : true, filter: 'text'}, 
				{header : 'ì™„ë£Œì—¬ë¶€', name : 'WORKORDER_ST', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? 'ìµœì¢…ì™„ë£Œ' : value == false ? 'ì§„í–‰ì¤‘' : 'ëŒ€ê¸°';
					}
				}, 
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `ì´ ${valueMap.cnt} ê±´`
						}
					}
				}
			},

		});
		
		
		grid.on('dblclick', function(ev) {
			chart.empty();
			let row = grid.getRow(ev.rowKey);
			if(row == null) {
				return;
			}
		    fetchChartData(row);
		});
	}
	
	// ì°¨íŠ¸ JSON ê°€ì ¸ì˜¤ê¸°
	function fetchChartData(row) {
	    $.ajax({
	        type: "POST",
	        url: "/select_LOT_json",
	        contentType: 'application/json',
			beforeSend : function(xhr) {
			    xhr.setRequestHeader(header, token);
			},
	        data: JSON.stringify(row),
	        success: function(data) {
                try {
                    let jsonData = JSON.parse(data.data.JSON_DATA);
                    make_chart(jsonData); // ë³€í™˜ëœ JSON ê°ì²´ ì „ë‹¬
                } catch (error) {
                    console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", error, "JSON_DATA ê°’:", data.JSON_DATA);
                }
	        },
	        error: function(error) {
	            console.error("Error fetching chart data:", error);
	        }
	    });
	}

	
	
	// íŠ¸ë¦¬ ìƒì„± í•¨ìˆ˜
	function make_chart(data){
		chart.orgchart({
			'data': data, // ë°ì´í„° ì…ë ¥
			'nodeContent': data.lot_st, // ë…¸ë“œì— í‘œì‹œí•  ì†ì„±
			//'pan': true, // íŒ¨ë‹ í™œì„±í™”
			'direction': 't2b', // ë°©í–¥ ì„¤ì • (bottom to top)
			'nodeTemplate': function(data) {
				let background = '#997af3'; // ê¸°ë³¸ ë°°ê²½ìƒ‰ (íŒŒë€ìƒ‰)
				let color = '#997af3'; // ê¸°ë³¸ ë°°ê²½ìƒ‰ (íŒŒë€ìƒ‰)
				// ì§ê¸‰(title)ì— ë”°ë¼ ë‹¤ë¥¸ ë°°ê²½ìƒ‰ ì ìš©
				if (data.title === 'ì œí’ˆ') {
					background = '#ff5733'; // ì£¼í™©ìƒ‰
				} else if (data.title === 'ë°˜ì œí’ˆ') {
					background = '#997af3'; // ì´ˆë¡ìƒ‰
				} else if (data.title === 'ì›ìì¬') {
					background = '#17a2b8'; // í•˜ëŠ˜ìƒ‰
				}
	
				return `
					<div class="node" style="background-color: ${background}; color: white;">
						<div class="title" style="background-color: ${background};">${data.title}</div>
						<div class="name">${data.lot_st}</div>
						<div class="process">${data.process}</div>
					</div>
				`;
			}
        });
		
		document.querySelectorAll('.orgchart .fa').forEach(el => {
			el.style.pointerEvents = 'none'; // í´ë¦­ ì´ë²¤íŠ¸ ë¹„í™œì„±í™”
		});
		
		document.querySelectorAll('.process').forEach(node => {
			if(node.textContent.includes("ëŒ€ê¸°ì¤‘")) {
				node.classList.add('blinking-node');
			}
		});
		
		$('.node').on('dblclick', function() {
			modal_detail(data);
		});

	}
	
	// ëª¨ë‹¬ ìƒì„±
	function modal_detail(data) {
		
	    const div_modal = "div_modal";
	    let modalElement = document.getElementById(div_modal); // ê¸°ì¡´ ëª¨ë‹¬ í™•ì¸

	    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±
	    if (modalElement) {
	        modalElement.remove();
	    }

	    // ìƒˆë¡œìš´ ëª¨ë‹¬ HTML ì¶”ê°€
	    let modalHtml = `
	    <div class="modal" id="${div_modal}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
	    	<div class="modal-dialog modal-dialog-centered modal-xl">
	        	<div class="modal-content">
	            	<div class="modal-header">
	                    <h5 class="modal-title">ë¡œíŠ¸ ìƒì„¸ì •ë³´</h5>
	                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	                </div>
	                <div class="modal-body">
	                    <div id="modal_grid"></div>
	                </div>
	                <div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >ë‹«ê¸°</button>
	                </div>
	            </div>
	        </div>
	    </div>
	    `;

	    document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal ë™ì  ì¶”ê°€
	    modalElement = document.getElementById(div_modal); // ìƒˆë¡œ ì¶”ê°€ëœ ëª¨ë‹¬ ì°¸ì¡°

	    const modal = new bootstrap.Modal(modalElement); // ëª¨ë‹¬ ì´ˆê¸°í™”

	    modalElement.addEventListener("shown.bs.modal", function () {
	        make_modal_grid(data); // ëª¨ë‹¬ ë‚´ë¶€ ê·¸ë¦¬ë“œ ìƒì„±
	    });

	    modal.show();

	    modalElement.addEventListener("hidden.bs.modal", function () {
	        modalElement.remove(); // ëª¨ë‹¬ ì‚­ì œ

	        // ğŸ”¹ ëª¨ë‹¬ ë‚´ë¶€ ëª¨ë“  ìš”ì†Œì—ì„œ í¬ì»¤ìŠ¤ ì œê±°
	        document.activeElement.blur();

	        // ğŸ”¹ ëª¨ë‹¬ ë°±ë“œë¡­ ì œê±°
	        document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());

	        // ğŸ”¹ body ìƒíƒœ ì´ˆê¸°í™” (ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ë³µêµ¬)
	        document.body.classList.remove("modal-open");
	        document.body.style.overflow = "";
	    });



	    $(window).resize(function () {
	        setGridHeight(modal_grid, -600);
	    });
	    
	}

	
	// ëª¨ë‹¬ ê·¸ë¦¬ë“œ ìƒì„±
	function make_modal_grid(data) {
		modal_grid = new tui.Grid({
			el : document.getElementById('modal_grid'),
			data : [], //{api: {readData: {url: '/select_detail_ANNUAL', method: 'GET', initParams: {lot_cd: data.lot_cd} }}}
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',},
			],
			bodyHeight : 200,
			columns : [
				{header : 'ë¡œíŠ¸ë²ˆí˜¸', name : 'lot_cd', sortable : true, filter: 'text'},
				{header : 'ìˆ˜ì£¼ë²ˆí˜¸', name : 'contract_cd', sortable : true, filter: 'text'},
				{header : 'ê³µì •ëª…', name : 'product_cd', sortable : true, filter: 'text'},
				{header : 'ìƒ‰ìƒ', name : 'product_cr', sortable : true, filter: 'text'}, 
				{header : 'ì‚¬ì´ì¦ˆ', name : 'product_sz', sortable : true, filter: 'text'}, 
				{header : 'ì‘ì—…ì‹œì‘ì¼', name : 'lothistory_st', sortable : true, filter: 'text'}, 
				{header : 'ì‘ì—…ì¢…ë£Œì¼', name : 'lothistory_en', sortable : true, filter: 'text'}, 
				{header : 'ì‘ì—…ìˆ˜ëŸ‰', name : 'lothistory_wq', sortable : true, filter: 'text'}, 
				{header : 'ë¶ˆëŸ‰ìˆ˜ëŸ‰', name : 'lothistory_bq', sortable : true, filter: 'text'}, 
				{header : 'ì™„ë£Œì—¬ë¶€', name : 'workorder_st', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? 'ì‚¬ìš©' : value == false ? 'ë¯¸ì‚¬ìš©' : '';
					}
				}, 
			],
			summary: {
				height: 40,
				position: 'bottom', // or 'top'
				columnContent: {
					workorder_st: {
						template: (valueMap) => {
							return `ì´ ${valueMap.cnt} ê±´`
						}
					}
				}
			},
		});
	}
	
</script>
</html>