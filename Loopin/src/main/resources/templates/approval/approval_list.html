<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">


<style>
/* 드롭다운 메뉴 크기 조정 */
.dropdown-menu {
	min-width: 600px; /* 너비 설정 */
	max-height: 500px; /* 최대 높이 설정 */
	overflow: visible !important; /* 컨텐츠가 영역 밖으로 나옴 */
}

.toastui-calendar-weekday-event-title { /* 캘린더 이벤트 조절 */
	font-size: 16px !important;
	font-weight: bold !important;
}

.tui-datepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}

.tui-timepicker {
	z-index: 9999 !important;
	overflow: visible !important;
}
</style>

<body>
	<main id="main" class="main">


		<div class="modal" id="modal_approval_list" tabindex="-1"
			aria-labelledby="modal_approval_list_label" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modal_approval_list_label">기안서 선택</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<!-- ToastUI Grid가 렌더링될 영역 -->
						<div id="approvalGrid"></div>
					</div>
				</div>
			</div>
		</div>


		<!-- 전자결재 등록 모달 -->
		<div class="modal" id="modal_leave_request" tabindex="-1"
			data-bs-backdrop="static" data-bs-keyboard="false">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">휴가 신청서 작성</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="leave_request_form" th:action="@{/insert_LeaveRequest}"
							method="post" enctype="multipart/form-data">
							<!-- Hidden 필드: 기안서 코드 -->
							<input type="hidden" class="form-control" id="approval_cd"
								name="approval_cd">
							<div class="row mb-3">
								<label for="inputDate" class="col-sm-2 col-form-label">시작일<span
									class="text-danger"> *</span></label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="approval_sd"
										name="approval_sd" aria-label="Date">
									<div id="startpicker-container" style="margin-left: -1px;"></div>
								</div>
								<label for="inputDate" class="col-sm-2 col-form-label">종료일</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="approval_ed"
										name="approval_ed" aria-label="Date">
									<div id="endpicker-container" style="margin-left: -1px;"></div>
								</div>
							</div>

							<div class="row mb-3">
								<label for="inputText" class="col-sm-2 col-form-label">제목</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="approval_tt"
										name="approval_tt">
								</div>
							</div>
							<!-- 기안서 구분 표시 -->
							<div class="row mb-3">
								<label for="approval_dv" class="col-sm-2 col-form-label">기안서
									구분</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="approval_dv"
										name="approval_dv" value="휴가 신청서" readonly>
								</div>
							</div>

							<!-- 휴가 종류 선택 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-2 col-form-label">휴가구분</label>
								<div class="col-sm-4">
									<select class="form-select" id="approval_dv" name="approval_dv"
										aria-label="직원 권한">
										<option value="" disabled selected>휴가 종류를 선택하세요</option>
										<option th:each="ANNUAL : ${ANNUAL_list}"
											th:value="${ANNUAL.common_cc}" th:text="${ANNUAL.common_nm}">
										</option>
									</select>
								</div>
							</div>

							<!-- 휴가 사유 입력 -->
							<div class="row mb-3">
								<label for="leave_reason" class="col-sm-2 col-form-label">휴가
									사유</label>
								<div class="col-sm-10">
									<textarea class="form-control" id="leave_reason"
										name="leave_reason" rows="4" placeholder="휴가 사유를 입력하세요"
										required></textarea>
								</div>
							</div>

							<!-- 휴가 기간 선택 -->
							<div class="row mb-3">
								<label for="leave_start_date" class="col-sm-2 col-form-label">휴가
									시작일</label>
								<div class="col-sm-4">
									<input type="date" class="form-control" id="leave_start_date"
										name="leave_start_date" required>
								</div>
								<label for="leave_end_date" class="col-sm-2 col-form-label">휴가
									종료일</label>
								<div class="col-sm-4">
									<input type="date" class="form-control" id="leave_end_date"
										name="leave_end_date" required>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">닫기</button>
						<button type="submit" id="leave_submit_button"
							class="btn btn-primary" form="leave_request_form">등록</button>
					</div>
				</div>
			</div>
		</div>


		<!-- 그리드 및 등록 버튼 -->
		<section class="section">
			<div class="row">
				<div class="col-lg-12">

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">결재 현황</h5>
							<div class="row mb-3">
								<div class="col-sm-12">
									<div id="filterModule" class="mb-3"></div>
									<div id="grid"></div>
								</div>
								<div class="col-sm-12">
									<button type="button" class="btn btn-primary"
										id="openApprovalModal">등록</button>
									<button type="button" id="btn_approval_delete"
										class="btn btn-primary">삭제</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
	<!-- 메인 끝 -->
</body>

<!-- 필터 모듈 JS File -->
<script src="/assets/js/filterModule.js"></script>






<script th:inline="javascript">
	
document.addEventListener('DOMContentLoaded', function () {
    const drafts = [
        { common_cc: 'D001', common_nm: '휴가 신청서' },
        { common_cc: 'D002', common_nm: '급여 결의서' },
        { common_cc: 'D003', common_nm: '출장 신청서' },
    ];

    // ToastUI Grid 초기화
    const grid = new tui.Grid({
        el: document.getElementById('approvalGrid'),
        data: drafts, // 데이터
        columns: [
            {
                header: '기안서 코드',
                name: 'common_cc',
                width: 150,
            },
            {
                header: '기안서명',
                name: 'common_nm',
                width: 200,
            },
            {
                header: '액션',
                name: '',
                renderer: {
                    type: CustomButtonRenderer, // 커스텀 버튼 렌더러
                },
            },
        ],
        rowHeight: 'auto',
        bodyHeight: 300,
        columnOptions: {
            resizable: true,
        },
    });

    // 커스텀 버튼 렌더러 정의
    function CustomButtonRenderer(props) {
        const el = document.createElement('button');
        el.className = 'btn btn-primary select-dp-btn';
        el.innerText = '선택';
        el.addEventListener('click', function () {
            // 선택된 데이터 가져오기
            const rowData = drafts[props.rowKey];
            console.log(rowData);

            // 모달 닫기
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modal_approval_list'));
            modalInstance.hide();
        });
        return el;
    }

    // 모달 열기 버튼
    document.getElementById('openApprovalModal').addEventListener('click', function () {
        const modalElement = document.getElementById('modal_approval_list');
        const modalInstance = new bootstrap.Modal(modalElement);
        modalInstance.show();
    });
});

	
	
	
	
    $(function () {
    	
    	
        // drafts 배열 출력 확인
        console.log(drafts);  // drafts 배열의 내용을 확인

        $('#openApprovalModal').click(function() {
            var modalHtml = '';

            // drafts 배열을 순회하여 모달 내용 추가
            drafts.forEach(function(draft) {
                modalHtml += `
                    <tr>
                        <td>${draft.common_cc}</td>  <!-- 기안서 코드 -->
                        <td>${draft.common_nm}</td>  <!-- 기안서명 -->
                        <td><button class="btn btn-primary select-dp-btn" id="openCreateModal">선택</button></td>
                    </tr>
                `;
            });

            // 모달 HTML 생성
            var modal = `
                <div class="modal" id="modal_approval_list" tabindex="-1" aria-labelledby="modal_approval_list_label" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modal_approval_list_label">기안서 선택</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>기안서코드</th>
                                            <th>기안서명</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${modalHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 모달을 body에 삽입하고 표시
            $('body').append(modal);

            // Bootstrap Modal 초기화 후 표시
            var modalElement = document.getElementById('modal_approval_list');
            var modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
        });
    	
    	
    	
    	
    	
    	
    	
        // 모달이 열릴 때 DatePicker 초기화
        $('#modal_leave_request').on('shown.bs.modal', function () {
            var today = new Date();
            var oneMonthAfter = new Date(today);
            oneMonthAfter.setMonth(today.getMonth() + 1);

            // DatePicker 초기화
            var rangePicker = tui.DatePicker.createRangePicker({
                startpicker: {
                    date: today,
                    input: '#approval_sd',
                    container: '#startpicker-container',
                },
                endpicker: {
                    date: oneMonthAfter,
                    input: '#approval_ed',
                    container: '#endpicker-container',
                    disabled: true,
                },
                format: 'YYYY-MM-dd',
                timePicker: false,
            });

            // 시작일 변경 이벤트
            rangePicker.on('change:start', function (event) {
                if (event && event.date) {
                    console.log("Start Date selected: ", event.date);

                    var minEndDate = new Date(event.date);
                    minEndDate.setDate(minEndDate.getDate() + 1);

                    rangePicker.setEndpickerOptions({
                        date: minEndDate,
                        minDate: minEndDate,
                        disabled: false,
                    });
                } else {
                    console.error("Start date is not available in the event");
                }
            });

            // 종료일 변경 이벤트
            rangePicker.on('change:end', function (event) {
                if (event && event.date) {
                    console.log("End Date selected: ", event.date);
                } else {
                    console.error("End date is not valid.");
                }
            });

            // 초기 값 설정
            rangePicker.setStartpickerDate(today);
            rangePicker.setEndpickerDate(oneMonthAfter);
        });

        // 모달이 닫힐 때 DatePicker 제거 (중복 방지)
        $('#modal_leave_request').on('hidden.bs.modal', function () {
            $('#startpicker-container').empty();
            $('#endpicker-container').empty();
        });
    });

</script>


<script th:inline="javascript">
	$(document).ready(function () {
	    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

		var userRole = /*[[${role}]]*/ 'default';
		
	    let approvalList = []; // 전체 결재 목록
	    let grid;


	    // 데이터 가져오기 및 그리드 초기화
	    $.ajax({
	        url: '/select_APPROVAL',
	        method: 'GET',
	        success: function (data) {
	        	approvalList = data; // 전체 데이터를 approvalList에 저장
	            
	            // Grid 초기화
	            grid = new tui.Grid({
	                el: document.getElementById('grid'),
	                data: approvalList,
	                scrollX: true,
	                scrollY: true,
	                rowHeaders: ['checkbox'],
					columns: [
						{ header: '결재코드', name: 'approval_cd', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true },
						{ header: '시작일', name: 'approval_sd', align: 'center', filter: {type: 'date', options: {format: 'yyyy-MM-dd'}}, sortable: true },
						{ header: '종료일', name: 'approval_ed', align: 'center', filter: {type: 'date', options: {format: 'yyyy-MM-dd'}}, sortable: true },
						{ header: '기안서구분', name: 'approval_dv', align: 'center', filter: {type: 'select'}, sortable: true },
						{ header: '제목', name: 'approval_tt', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true },
					    
					    // 숨김 컬럼
						{ header: '내용', name: 'approval_ct', hidden: true  },
						{ header: '작성자', name: 'approval_wr', hidden: true  },
						{ header: '작성일', name: 'approval_wd', hidden: true  },
						{ header: '수정자', name: 'approval_mf', hidden: true  },
						{ header: '수정일', name: 'approval_md', hidden: true  },
					]
	            });

	            // 그리드 클릭 이벤트 등록
	            grid.on('click', (ev) => {
	                const columnName = ev.columnName;
	                const rowKey = ev.rowKey;
	                const rowData = grid.getRow(rowKey);

					// 헤더 클릭인지 확인
					if (rowKey === null || rowKey === undefined) {
					    console.warn("헤더 클릭은 무시됩니다.");
					    return;
					}
					
					
	                if (columnName === 'approval_cd') {
	                    openEditModal(rowData); // 수정 모드로 모달 열기
	                }
	            });
	        },
	        error: function (error) {
	            console.error('데이터 로드 실패:', error);
	        }
	    });


	    // 삭제 버튼 클릭 이벤트
	    $('#btn_approval_delete').on('click', function () {
	        const checkedRows = grid.getCheckedRows();
	        if (checkedRows.length === 0) {
	            Swal.fire({
	                icon: 'error',
	                title: '오류 발생!',
	                text: '삭제할 결재을 선택하세요.',
	                confirmButtonText: '확인'
	            });
	            return;
	        }

	        const approval_cds = checkedRows.map(row => row.approval_cd);
	        
	        Swal.fire({
	            title: '삭제 확인',
	            text: `선택한 결재(${approval_cds.join(', ')})을 삭제하시겠습니까?`,
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonText: '삭제',
	            cancelButtonText: '취소',
	            reverseButtons: true
	        }).then((result) => {
	            if (result.isConfirmed) {
	                // 확인 버튼을 눌렀을 때 실행할 코드
	                console.log(`선택한 결재(${approval_cds.join(', ')}) 삭제를 진행합니다.`);
	                // 여기에서 실제 삭제 처리 로직을 추가합니다.
	                
	    	        $.ajax({
	    	            url: '/delete_APPROVAL',
	    	            method: 'POST',
	    	            headers: { 'X-CSRF-TOKEN': csrfToken },
	    	            data: JSON.stringify({ approval_cds }),
	    	            contentType: 'application/json',
	    	            success: function () {
	    		            Swal.fire({
	    		                icon: 'success',
	    		                title: '삭제완료!',
	    		                text: '삭제가 완료되었습니다.',
	    		                confirmButtonText: '확인'
	    		            });
	    		            setTimeout(() => {
	    		                location.reload();
	    		            }, 1000);
	    	            },
	    	            error: function (xhr) {
	    	                console.error('삭제 중 오류 발생:', xhr.responseText);
	    		            Swal.fire({
	    		                icon: 'error',
	    		                title: '오류발생',
	    		                text: '삭제 중 오류가 발생했습니다.',
	    		                confirmButtonText: '확인'
	    		            });
	    	            }
	    	        });
	                
	                
	            } else if (result.dismiss === Swal.DismissReason.cancel) {
	                // 취소 버튼을 눌렀거나 팝업을 닫았을 때 실행할 코드
	                console.log('삭제가 취소되었습니다.');
	            }
	        });
	    });
	        
	        

	    // 모달 닫힐 때 상태 초기화
	    $('#modal_leave_request').on('hidden.bs.modal', function () {
			$('#leave_request_form')[0].reset(); // 폼 초기화
			$('#approval_cd').val(''); // 숨겨진 수정용 필드 초기화
			$('#modalTitle').text(''); // 모달 제목 초기화
			$('#modal_submit_button').text(''); // 버튼 텍스트 초기화
	    });

		
		// 등록 모달 열기
		$('#openCreateModal').on('click', function () {
		    openCreateModal($(this));
		});

		// 등록 모달 함수
		function openCreateModal(ele) {
			
			console.log(ele.parent());
			
		    // 모달 초기화
		    resetModal();

		    // 모달 설정
		    $('#modal_submit_button').text('등록');

		    // 모달 열기
		    const modalInstance = new bootstrap.Modal($('#modal_leave_request')[0]);
		    modalInstance.show();
		}

		// 모달 초기화 함수
		function resetModal() {
// 		    $('#leave_request_form')[0].reset(); // 폼 초기화
		 	$('#approval_cd').val(''); // 수정용 필드 초기화
		}
		
		// 수정 모달 열기 함수
		function openEditModal(data) {
		    // 모달 제목 및 버튼 텍스트 설정
		    $('#modalTitle').text('결재 수정');
		    $('#modal_submit_button').text('수정');

				// 데이터 매핑
				Object.keys(data).forEach(key => {
				const $field = $(`#${key}`);
		        if ($field.length && $field.attr('type') !== 'file') {
		            $field.val(data[key] || '');
		        }
		    });


		    // 모달 열기
		    $('#modal_leave_request').modal('show');

		    console.log("수정 모달 열림", data);
		}



		// 폼 제출 이벤트
		$('#leave_request_form').off('submit').on('submit', function (event) {
		    event.preventDefault();

		    const formData = new FormData(); // FormData 객체 생성
		    const mode = $('#modal_submit_button').text().trim(); // 등록/수정 모드 확인
		    const url = mode === '등록' ? '/insert_APPROVAL' : '/update_APPROVAL';

		    // DTO 데이터를 JSON으로 생성
		    const ApprovalDTO = {
				approval_md : $('#approval_md').val(),
				approval_mf : $('#approval_mf').val(),
				approval_wd : $('#approval_wd').val(),
				approval_wr : $('#approval_wr').val(),
				approval_ct : $('#approval_ct').val(),
				approval_tt : $('#approval_tt').val(),
				approval_dv : $('#approval_dv').val(),
				approval_ed : $('#approval_ed').val(),
				approval_sd : $('#approval_sd').val(),
				approval_cd : $('#approval_cd').val()
		    };


		    formData.append('ApprovalDTO', new Blob([JSON.stringify(ApprovalDTO)], { type: 'application/json' })); // JSON 추가

		    $.ajax({
		        url: url,
		        method: 'POST',
		        processData: false,
		        contentType: false,
		        headers: { 'X-CSRF-TOKEN': csrfToken }, // CSRF 토큰 추가
		        data: formData,
		        success: function () {
		        	Swal.fire({
		        		  icon: 'success',
		        		  title: mode === '등록' ? '등록 완료' : '수정 완료',
		        		  text: mode === '등록' ? '등록이 완료되었습니다.' : '수정이 완료되었습니다.',
		        		  confirmButtonText: '확인'
		        		});
		            $('#modal_leave_request').modal('hide'); // 모달 닫기
		            setTimeout(() => {
		                location.reload();
		            }, 1000);
		        },
		        error: function (xhr) {
		            console.error('AJAX Error:', xhr.responseText);
		            console.error('AJAX Error:', ApprovalDTO);
		            Swal.fire({
		                icon: 'error',
		                title: '오류 발생!',
		                text: '작업 중 오류가 발생했습니다.',
		                confirmButtonText: '확인'
		            });
		        }
		    });
		});


		const filterConfig = [
			{ key: 'startDate', label: '조회기간 시작일', type: 'daterangepicker', format: 'YYYY-MM-dd', value: '2024-01-01'},
			{ key: 'endDate', label: '조회기간 종료일', type: 'daterangepicker', format: 'YYYY-MM-dd', value: '2025-12-31'},
	        { key: 'approvalCd', label: '결재코드', type: 'text', placeholder: '결재 CD 입력',  col: 'col-4' },
	        { key: 'approvalDv', label: '기안서구분', type: 'text', placeholder: '기안서 입력',  col: 'col-4' },
	        { key: 'approvalWr', label: '작성자', type: 'text', placeholder: '작성자 입력',  col: 'col-4' }
	    ];
		
		initializeFilterModule('filterModule', filterConfig, (filterValues) => {
		    console.log('적용된 필터:', filterValues);
		
		    // 필터 적용 후 서버 요청 및 Grid 갱신
		    fetch('/select_FILTERED_APPROVAL', {
		        method: 'POST',
		        headers: { 'Content-Type': 'application/json',
		        			[csrfHeader]: csrfToken
		        },
		        body: JSON.stringify(filterValues)
		    })
		    .then(response => response.json())
		    .then(filteredData => {
		        console.log('필터링된 데이터:', filteredData);
		
		        // Grid 데이터 갱신
		        grid.resetData(filteredData);
		    })
		    .catch(error => console.error('필터 적용 오류:', error));
		});
		
	});
	
    
</script>
</html>