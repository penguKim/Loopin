<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
				layout:decorate="~{layout}" 
				layout:fragment="content">


<body>
	<main id="main" class="main">
		<!-- 인사카드 등록 모달 -->
		<div class="modal fade" id="modal_appointment_save" tabindex="-1">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modalTitle">인사카드 등록</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="appointment_form" th:action="@{/insert_EMPLOYEE}" method="post">
							<input type="hidden" id="modalMode" name="modalMode" value="create">
                    		<input type="hidden" id="employee_cd" name="employee_cd"> <!-- 수정 시 사용 -->
							<!-- 아이디 및 비밀번호 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">아이디</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_id" name="employee_id">
								</div>
								<label for="inputEmail" class="col-sm-1 col-form-label">비밀번호</label>
								<div class="col-sm-4">
									<input type="password" class="form-control" id="employee_pw" name="employee_pw">
								</div>
							</div>
							<!-- 부서코드 및 직급코드 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">부서코드</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_dp" name="employee_dp">
								</div>
								<label for="inputText" class="col-sm-1 col-form-label">직급코드</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_gd" name="employee_gd">
								</div>
							</div>
							<!-- 입사일 및 퇴사일 -->
							<div class="row mb-3">
								<label for="inputDate" class="col-sm-1 col-form-label">입사일</label>
								<div class="col-sm-2">
									<input type="text" class="form-control" id="employee_hd" name="employee_hd"
										aria-label="Date-Time">
								</div>
								<div class="col-sm-2">
									<div id="hd_wrapper"></div>
								</div>
								<label for="inputDate" class="col-sm-1 col-form-label">퇴사일</label>
								<div class="col-sm-2">
									<input type="text" class="form-control" id="employee_rd" name="employee_rd"
										aria-label="Date-Time">
								</div>
								<div class="col-sm-2">
									<div id="rd_wrapper"></div>
								</div>
							</div>
							<!-- 퇴사사유 -->
							<div class="row mb-3">
								<label for="inputPassword" class="col-sm-1 col-form-label">퇴사사유</label>
								<div class="col-sm-5">
									<textarea class="form-control" style="height: 100px"
										id="employee_rr" name="employee_rr"></textarea>
								</div>
							</div>
							<!-- 채용구분 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">채용구분</label>
								<div class="col-sm-4">
									<select class="form-select" aria-label="Default select example"
										id="employee_cg" name="employee_cg">
										<option value="신입" selected>신입</option>
										<option value="경력">경력</option>
									</select>
								</div>
							</div>
							<!-- 비고 -->
							<div class="row mb-3">
								<label for="inputPassword" class="col-sm-1 col-form-label">비고</label>
								<div class="col-sm-5">
									<textarea class="form-control" id="employee_nt" name="employee_nt"
										style="height: 100px"></textarea>
								</div>
							</div>
							<!-- 사원명 및 생년월일 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">사원명</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_nm" name="employee_nm">
								</div>
								<label for="inputDate" class="col-sm-1 col-form-label">생년월일</label>
								<div class="col-sm-2">
									<input type="text" class="form-control" id="employee_bd" name="employee_bd"
										aria-label="Date-Time">
								</div>
								<div class="col-sm-2">
									<div id="bd_wrapper"></div>
								</div>
							</div>
							<!-- 우편 번호 및 주소 -->
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">우편번호</label>
								<div class="col-sm-4">
									<input type="text" class="form-control form-control-user"
										id="employee_zc"  name="zipCode" placeholder="우편번호" readonly
										onclick="findAddr()">
								</div>
							</div>
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">기본주소</label>
								<div class="col-sm-4">
									<input type="text" class="form-control form-control-user"
										id="employee_sa" name="employee_sa" placeholder="도로명 주소"
										readonly>
								</div>
								<label for="inputEmail" class="col-sm-1 col-form-label">상세주소</label>
								<div class="col-sm-4">
									<input type="text" class="form-control form-control-user"
										id="employee_da" name="employee_da" placeholder="상세 주소">
								</div>
							</div>
							<!-- 주소 값 히든 -->
							<input type="hidden" id="employee_ad" name="employee_ad">
							<fieldset class="row mb-3">
								<legend class="col-form-label col-sm-1 pt-0">성별</legend>
								<div class="col-sm-10">
									<div class="form-check">
										<input class="form-check-input" type="radio" 
											id="employee_sb1" name="employee_sb1" value="option1" checked> <label
											class="form-check-label" for="gridRadios1"> 남 </label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="radio" 
											id="employee_sb2" name="employee_sb2" value="option2"> <label
											class="form-check-label" for="gridRadios2"> 여 </label>
									</div>
								</div>
							</fieldset>
							<!-- 이메일 -->
							<div class="row mb-3">
							    <label for="inputText" class="col-sm-1 col-form-label">이메일</label>
							    <div class="col-sm-3">
							        <input type="text" class="form-control" id="employee_username" name="employee_username" placeholder="아이디 입력">
							    </div>
							    <div class="col-auto">@</div>
								<div class="col-sm-3">
								    <input class="form-control" id="custom_domain" name="custom_domain" type="text" placeholder="직접 입력" aria-label="직접 도메인 입력">
								</div>
							    <div class="col-sm-3">
									<select class="form-select" id="employee_domain" name="employee_domain" aria-label="도메인 선택">
									    <option value="custom" selected>직접 입력</option>
									    <option value="naver.com">naver.com</option>
									    <option value="google.com">google.com</option>
									    <option value="hanmail.net">hanmail.net</option>
									    <option value="nate.com">nate.com</option>
									    <option value="kakao.com">kakao.com</option>
									</select>
							    </div>
							</div>
							<input type="hidden" id="employee_em" name="employee_em">
							<div class="row mb-3">
								<label for="inputNumber" class="col-sm-1 col-form-label">사진등록</label>
								<div class="col-sm-5">
									<input class="form-control" type="file" id="employee_pi" name="employee_pi">
								</div>
							</div>
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">기본급</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_bs" name="employee_bs">
								</div>
								<label for="inputText" class="col-sm-1 col-form-label">은행</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_bk" name="employee_bk">
								</div>
							</div>
							<div class="row mb-3">
								<label for="inputText" class="col-sm-1 col-form-label">계좌번호</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_an" name="employee_an">
								</div>
								<label for="inputText" class="col-sm-1 col-form-label">예금주</label>
								<div class="col-sm-4">
									<input type="text" class="form-control" id="employee_dt" name="employee_dt">
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
								<button type="submit" id="modal_submit_button" class="btn btn-primary">등록</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="modal_department_list" tabindex="-1" aria-labelledby="modal_department_list_label" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modal_department_list_label">부서 선택</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<table id="dpTable" class="table table-striped">
							<thead>
								<tr>
									<th>부서코드</th>
									<th>부서명</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>DEPT001</td>
									<td>영업부</td>
									<td><button class="btn btn-primary select-dp-btn">선택</button></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="modal_grade_list" tabindex="-1" aria-labelledby="modal_grade_list_label" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modal_grade_list_label">직위 선택</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<table id="gdTable" class="table table-striped">
							<thead>
								<tr>
									<th>직위코드</th>
									<th>과장</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>GD001</td>
									<td>차장</td>
									<td><button class="btn btn-primary select-gd-btn">선택</button></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		
		
		<!-- 그리드 및 등록 버튼 -->
		<section class="section">
			<div class="row">
				<div class="col-lg-12">

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">인사카드 등록</h5>
							<div class="row mb-3">
								<div class="col-sm-12">
									<div id="grid"></div>
									<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_appointment_save">등록</button>
									<button type="button" id="btn_employee_delete" class="btn btn-primary">삭제</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
	<!-- End main -->
</body>


<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function findAddr(){
        new daum.Postcode({
            oncomplete: function(data) {
            	// 우편번호
                $("#employee_gc").val(data.zonecode);
                // 도로명 및 지번주소
                $("#employee_sa").val(data.roadAddress);
                
                // 상세주소로 포커스 
                $("#employee_da").focus();
				
				// 주소 통합
				let employee_ad = "("+ data.zonecode + ")" + ' ' + data.roadAddress + ' ' + $("#employee_da").val();
				$("#employee_ad").val(employee_ad);
            }
        }).open();
    }

	// 입사일 datepicker
	$(document).ready(function() {
		const datepicker = new tui.DatePicker('#hd_wrapper', {
	        date: new Date(),
	        input: {
	            element: '#employee_hd',
	            format: 'yyyy-MM-dd'
	        }
	    });
	});

	// 퇴사일 datepicker
	$(document).ready(function() {
		const datepicker = new tui.DatePicker('#rd_wrapper', {
	        date: new Date(),
	        input: {
	            element: '#employee_rd',
	            format: 'yyyy-MM-dd'
	        }
	    });
	});

	// 생년월일 datepicker
	$(document).ready(function() {
		const datepicker = new tui.DatePicker('#bd_wrapper', {
	        date: new Date(),
	        input: {
	            element: '#employee_bd',
	            format: 'yyyy-MM-dd'
	        }
	    });
	});
	
	// 이메일 관련 처리
	$('#employee_domain').on('change', function () {
	    const customDomainInput = $('#custom_domain');
	    if ($(this).val() !== "custom") {
	        customDomainInput.val($(this).val()).prop('disabled', true);
	    } else {
	        customDomainInput.val('').prop('disabled', false).attr('placeholder', '직접 입력');
	    }
	});

	// 이메일 합치기
	function updateFullEmail() {
	    const username = $('#employee_username').val().trim();
	    const domainSelect = $('#employee_domain');
	    const customDomainInput = $('#custom_domain');
	    const fullEmailInput = $('#employee_em');

	    let domain = domainSelect.val();
	    if (domain === "custom") {
	        domain = customDomainInput.val().trim();
	    }

	    fullEmailInput.val(username + '@' + domain);
	}

	// 이벤트 핸들러 등록
	$('#employee_username').on('input', updateFullEmail);
	$('#employee_domain').on('change', updateFullEmail);
	$('#custom_domain').on('input', updateFullEmail);
	
	
	
</script>

	
<script th:inline="javascript">
$(document).ready(function () {
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    let grid;

    
    // 데이터 가져오기 및 그리드 초기화
    $.ajax({
        url: '/select_EMPLOYEE',
        method: 'GET',
        success: function (employeeList) {
        	
        	console.log(employeeList);
        	
            grid = new tui.Grid({
                el: document.getElementById('grid'),
                data: employeeList,
                scrollX: true,
                scrollY: true,
                rowHeaders: ['checkbox'],
                columns: [
                    { header: '사원코드', name: 'employee_cd', align: 'center', sortable: true },
                    { header: '사원명', name: 'employee_nm', align: 'center', sortable: true },
                    { header: '부서', name: 'employee_dp', align: 'center', sortable: true },
                    { header: '직급', name: 'employee_gd', align: 'center', sortable: true },
                    { header: '생년월일', name: 'employee_bd', align: 'center', sortable: true },
                    { header: '주소', name: 'employee_ad', align: 'center', sortable: true },
                    { header: '연락처', name: 'employee_ph', align: 'center', sortable: true },
                    { header: '이메일', name: 'employee_em', align: 'center', sortable: true },
                    { header: '입사일', name: 'employee_hd', align: 'center', sortable: true },
                    { header: '채용구분', name: 'employee_cg', align: 'center', sortable: true },
                ]
            });

            // 그리드 클릭 이벤트 등록
            grid.on('click', (ev) => {
                const columnName = ev.columnName;
                const rowKey = ev.rowKey;
                const rowData = grid.getRow(rowKey);
                
                if (columnName === 'employee_cd' || columnName === 'employee_nm' || columnName === 'employee_nm' ) {
                    openModal('edit', rowData); // 수정 모드로 모달 열기
                }

//                 if (targetType === 'columnHeader' || targetType === 'rowHeader') {
//                     return;
//                 }
                
            });
        },
        error: function (error) {
            console.error('오류 발생:', error);
        }
    });

    // 모달 열기 함수
    function openModal(mode, data = null) {
        const $modalTitle = $('#modalTitle');
        const $modalMode = $('#modalMode');
        const $submitButton = $('#modal_submit_button');

        if (mode === 'create') {
            $modalTitle.text('인사카드 등록');
            $submitButton.text('등록');
            $modalMode.val('create');
            $('#appointment_form')[0].reset();
        } else if (mode === 'edit') {
            $modalTitle.text('인사카드 수정');
            $submitButton.text('수정');
            $modalMode.val('edit');
            console.log('모달 모드 설정:', $modalMode.val()); // 디버깅 출력

            if (data) {
                Object.keys(data).forEach(key => {
                    $(`#${key}`).val(data[key]);
                });
            }
        }

        $('#modal_appointment_save').modal('show');
    }

    // 모달 닫힘 처리
    $('#modal_appointment_save').on('hide.bs.modal', function () {
        $('#appointment_form')[0].reset();
    });

    // 폼 제출 처리
    $('#appointment_form').off('submit').on('submit', function (event) {
        event.preventDefault();
        
        
        const mode = $('#modalMode').val();
        const url = mode === 'create' ? '/insert_EMPLOYEE' : '/update_EMPLOYEE';
        const method = mode === 'create' ? 'POST' : 'POST';
	
        
        const formData = {
       		employee_id : $('#employee_id').val(),
       		employee_pw : $('#employee_pw').val(),
       		employee_dp : $('#employee_dp').val(),
       		employee_gd : $('#employee_gd').val(),
       		employee_hd : $('#employee_hd').val(),
       		employee_rd : $('#employee_rd').val(),
       		employee_rr : $('#employee_rr').val(),
       		employee_cg : $('#employee_cg').val(),
       		employee_nt : $('#employee_nt').val(),
       		employee_nm : $('#employee_nm').val(),
       		employee_bd : $('#employee_bd').val(),
       		employee_ad : $('#employee_ad').val(),
       		employee_sb : $('#employee_sb').val(),
       		employee_ph : $('#employee_ph').val(),
       		employee_em : $('#employee_em').val(),
       		employee_pi : $('#employee_pi').val(),
       		employee_bs : $('#employee_bs').val(),
       		employee_bk : $('#employee_bk').val(),
       		employee_an : $('#employee_an').val(),
       		employee_dt : $('#employee_dt').val(),
       		employee_wr : $('#employee_wr').val(),
       		employee_wd : $('#employee_wd').val(),
       		employee_mf : $('#employee_mf').val(),
       		employee_md : $('#employee_md').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            headers: { 'X-CSRF-TOKEN': csrfToken },
            data: JSON.stringify(formData),
            success: function () {
                alert(mode === 'create' ? '등록이 완료되었습니다.' : '수정이 완료되었습니다.');
                $('#appointment_form')[0].reset();
                $('#modal_appointment_save').modal('hide');
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', xhr.responseText, status, error);
                alert('작업 중 오류가 발생했습니다.');
            },
        });
    });
    
    // 삭제 버튼 클릭 처리
    $('#btn_employee_delete').off('click').on('click', function () {
        const checkedRows = grid.getCheckedRows();
        console.log(checkedRows);

        if (checkedRows.length === 0) {
            alert('삭제할 데이터를 선택하세요.');
            return;
        }

        const cdsToDelete = checkedRows.map(row => row['employee_cd']);
        console.log('삭제할 ID 리스트:', cdsToDelete);

        if (!confirm('선택한 데이터를 삭제하시겠습니까?')) {
            return;
        }

        $.ajax({
            url: '/delete_EMPLOYEE',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                [csrfHeader]: csrfToken
            },
            data: JSON.stringify({cds: cdsToDelete}),
            success: function (data) {
                console.log('서버 응답:', data);
                if (data.success) {
                    alert('삭제가 완료되었습니다.');
                    setTimeout(() => location.reload(), 500);
                } else {
                    alert('삭제에 실패했습니다: ' + data.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('오류 발생:', xhr.responseText, status, error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        });
    });
    
    $('#employee_dp').on('click', function () {
        const modalDepartmentList = new bootstrap.Modal($('#modal_department_list')[0]);
        modalDepartmentList.show();
    });

    $('#employee_gd').on('click', function () {
        const modalDepartmentList = new bootstrap.Modal($('#modal_grade_list')[0]);
        modalDepartmentList.show();
    });

 	// 부서 선택 버튼 클릭 이벤트 처리
	$(document).on('click', '.select-dp-btn', function () {
		// 클릭된 버튼이 속한 행(`tr`)을 가져옴
		const selectedRow = $(this).closest('tr');

		// 행의 각 열(`td`)에서 데이터를 가져옴
		const departmentName  = selectedRow.find('td').eq(1).text(); // 부서명

		// 기존 모달의 필드에 값 설정
		$('#employee_dp').val(departmentName);

		// 부서 선택 모달 닫기
		const modalDepartmentList = bootstrap.Modal.getInstance($('#modal_department_list')[0]);
		modalDepartmentList.hide();
	});
 	
 	// 직위 선택 버튼 클릭 이벤트 처리
	$(document).on('click', '.select-gd-btn', function () {
		// 클릭된 버튼이 속한 행(`tr`)을 가져옴
		const selectedRow = $(this).closest('tr');

		// 행의 각 열(`td`)에서 데이터를 가져옴
		const gradeName = selectedRow.find('td').eq(1).text(); // 직위명

		// 기존 모달의 필드에 값 설정
		$('#employee_gd').val(gradeName);

		// 부서 선택 모달 닫기
		const modalGradeList = bootstrap.Modal.getInstance($('#modal_grade_list')[0]);
		modalGradeList.hide();
	});
    
});
</script>
</html>