<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
	.tui-grid-cell-summary {
	    background-color: #ddd;
	    border-color: #fff;
	    border-left-width: 1px;
	    border-right-width: 1px;
	    color: #333;
	}
</style>
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
						<div class="card-body">
							<h1 class="card-title">제품 관리</h1>
							<div id="filterModule" class="mb-3"></div>
							<div id="grid"></div>
							<div id="btn_area" class="mt-3">
								<button type="button" class="btn btn-primary" id="btn_insert">등록</button>
								<button type="button" class="btn btn-primary" id="btn_delete">삭제</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</body>
<script th:inline="javascript">
	// 변수 지정
	let grid, modal_grid, modal;
	let modal_product_cd, modal_product_nm, modal_product_gc, modal_product_cc, modal_product_sz
		, modal_product_cr, modal_product_gd, modal_product_un, modal_product_wh, modal_product_us, modal_product_rm;
	let modalData = {}; // 모달 초기화 시 사용
	const btn_insert = $('#btn_insert');
	const btn_delete = $('#btn_delete');
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	const filterConfig = [
	    { key: 'product_cd', label: '제품코드', type: 'text', placeholder: '창고코드 입력', col: 'col-2' },
	    { key: 'product_nm', label: '제품명', type: 'text', placeholder: '창고명 입력', col: 'col-2' },
	    // { key: 'product_tp', label: '품목대분류', type: 'select', list: setFilterList(whtypeList), col: 'col-2' },
	    { key: 'product_gc', label: '품목대분류', type: 'select', list: [], col: 'col-2' },
	    { key: 'product_cc', label: '품목소분류', type: 'select', list: [], col: 'col-2' },
	    { key: 'product_wh', label: '보관창고', type: 'select', list: [], col: 'col-2' },
	    { key: 'product_us', label: '사용여부', type: 'radio', list: [], col: 'col-auto' },
	];
	let commonList = [];
	let warehouseList = /*[[${warehouseList}]]*/[];

	// ------------------------------
	
	$(function() {
		tui.Grid.setLanguage('ko');
		tui.Grid.applyTheme('striped');
		
		make_grid();
		getList();
		
		// 창크기
		setElementHeight('.card', -105);
		setGridHeight(grid, -380);
		
		$(window).resize(function() {
			setTimeout(() => {
				setElementHeight('.card', -105);
				setGridHeight(grid, -380);
				setGridWidth(grid, 0);
			}, 300);
		});

		// 검색필터
        initializeFilterModule('filterModule', filterConfig, (filterValues) => {
            getGridList(filterValues);
        });
		
		// 엑셀 버튼 추가
		addExcelButton(grid, '제품관리');
		
		$(document).on('filterToggled', function(e) {
		    if(e.detail.isVisible) {
		        setGridHeight(grid, -450);
		    } else {
		        setGridHeight(grid, -380);
		    }
		});
		
		// 필터 엔터키 검색 이벤트
		$('#filterModule').on('keypress', function(e) {
		    if (e.keyCode !== 13) return;
		    
		    const filterValues = {};
		    
		    for (const config of filterConfig) {
		        const input = $(`#${config.key}`);
		        const value = input.val();
		        filterValues[config.key] = value;
		    }
		    getGridList(filterValues);
		});
		
		
		// 등록 모달 클릭
		btn_insert.on('click', function() {
			modalData = {};
			make_modal_detail();
		});

		// 	창고코드 중복검사	
		$(document).on('blur', '#modal_warehouse_cd', async function() {
			if ($('#div_WAREHOUSE_modal').is(':hidden')) {
			    return;
			}
			let warehouse_cd = $(this).val();
			let jsonData = JSON.stringify({warehouse_cd});
			let ajaxData = await callAjaxPost('/check_WAREHOUSE_CD', jsonData);
			if(!ajaxData['result']) {
				showToast($(this), 'error', ajaxData['title'], ajaxData['msg']);
				setTimeout(() => {
			        $(this).val('');
			    }, 1500);
			}
		});
		
		// 제품 등록
		$(document).on('click', '#btn_modal_save', function() {
			insert_PRODUCT();
		});
		
		// 창고 초기화 버튼
		$(document).on('click', '#btn_modal_reset', function() {
			if(modalData) {
				setModalValues(modalData);
			} else {
				const modal = $(this).closest('.modal');
				modal.find('input').val('');
				modal.find('select').val('');
			}
		});

		// 창고 삭제
		btn_delete.on('click', function() {
			let checkedRows = grid.getCheckedRows();
			console.log(checkedRows);
			if (!checkedRows.length) {
				showAlert('', 'warning', '삭제 항목 체크', '삭제할 창고를 체크해주세요.');
			    return;
			}
			delect_WAREHOUSE(checkedRows);				
		});
		
		setTimeout(() => {
			createSelectBox('#product_gc', commonList['PRDTYPE'], '선택하세요.');
			createSelectBox('#product_gc', commonList['PRDTYPE'], '선택하세요.');
			// createRadio('#product_us', comList['USEYN'], 'product_us', true);
		}, 500);
	});
	
	
	// --------------------------------
	
	async function getList() {
		commonList = await getCommonList("USE", "USEYN", "SIZE", "SHOEGENDER", "COLOR", 
				"UNIT", "PRDTYPE", "MATERIALS", "SUBMAT", "HALFPRO", "PRODUCT");
	}

	// 그리드 생성
	function make_grid() {
		const dataSource = {
		    api: {
		        readData: {
		            url: '/select_PRODUCT_list',
		            method: 'POST',
		            contentType: 'application/json',
		            headers: {
		                [header]: token
		            }
		        }
		    }
		}
		
		grid = new tui.Grid({
			el : document.getElementById('grid'),
			data : dataSource,
			scrollX : false,
			scrollY : true,
			rowHeaders : [
				{type : 'rowNum',}, 
				{type : 'checkbox',}, 
			],
			bodyHeight : 600,
			columns : [
				{header : '제품코드', name : 'product_cd', sortable : true, filter: 'text'},
				{header : '제품명', name : 'product_nm', sortable : true, filter: 'text'},
				{header : '품목대분류', name : 'product_gc', sortable : true, filter: 'select'},
				{header : '품목소분류', name : 'product_cc', sortable : true, filter: 'select'},
				{header : '기준단위', name : 'product_un', sortable : true, filter: 'select'},
				{header : '보관창고', name : 'product_wh', sortable : true, filter: 'select'},
				{header : '비고', name : 'product_rm', sortable : true, filter: 'text'}, 
				{header : '사용여부', name : 'product_us', align: 'center', sortable : true, filter: 'select',
					formatter: function({value}) {
						return value == true ? '사용' : value == false ? '미사용' : '';
					}
				}, 
			],
			summary: {
			    height: 40,
			    position: 'bottom', // or 'top'
			    columnContent: {
			    	warehouse_us: {
			            template: (valueMap) => {
			                return `총  ${valueMap.cnt} 건`
			            }
			        }
			    }
			},

		});
		
		grid.on('dblclick', function(ev) {
			let row = grid.getRow(ev.rowKey);
			make_modal_detail('update');
			setModalInput(row);
		});
	}
	
	// 그리드 데이터 조회
	async function getGridList(filter) {
		let jsonData = JSON.stringify({warehouseFilter: filter});
		let ajaxData = await callAjaxPost('/select_WAREHOUSE_list', jsonData);
		grid.resetData(ajaxData.data.contents);
	}
	
	
	// 상세 모달
	function make_modal_detail(process) {
		let text = !process ? '등록' : '수정';
		let title = `제품 ${text}`;
		const div_modal = 'div_PRODUCT_modal';
		let modalElement = document.getElementById('#${div_modal}');
		
		if(!modalElement) {
			let modalHtml = `
			<div class="modal" id="${div_modal}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
				<div class="modal-dialog modal-dialog-centered modal-lg">
		            <div class="modal-content">
						<div class="modal-header">
		            		<h5 class="modal-title">${title}</h5>
		                	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="row mb-3">
								<label for="modal_product_cd" class="col-2 col-form-label">제품코드<span class="text-danger">*</span></label>
								<div class="col-4"><input type="text" class="form-control" id="modal_product_cd" ${!process ? '' : 'disabled'}></div>
								<label for="modal_product_nm" class="col-2 col-form-label">제품명<span class="text-danger">*</span></label>
								<div class="col-4"><input type="text" class="form-control" id="modal_product_nm"></div>
							</div>
							<div class="row mb-3">
								<label for="modal_product_gc" class="col-2 col-form-label">품목대분류<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_gc" class="form-select"></select></div>
								<label for="modal_product_cc" class="col-2 col-form-label">품목소분류<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_cc" class="form-select"></select></div>
							</div>
							<div class="row mb-3">
								<label for="modal_product_sz" class="col-2 col-form-label">사이즈<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_sz" class="form-select" multiple></select></div>
								<label for="modal_product_cr" class="col-2 col-form-label">색상<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_cr" class="form-select" multiple></select></div>
							</div>
							<div class="row mb-3">
								<label for="modal_product_gd" class="col-2 col-form-label">성별<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_gd" class="form-select"></select></div>
								<label for="modal_product_un" class="col-2 col-form-label">기준단위<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_un" class="form-select"></select></div>
							</div>
							<div class="row mb-3">
								<label for="modal_product_wh" class="col-2 col-form-label">보관창고<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_wh" class="form-select"></select></div>
								<label for="modal_product_us" class="col-2 col-form-label">사용여부<span class="text-danger">*</span></label>
								<div class="col-4"><select id="modal_product_us" class="form-select"></select></div>
							</div>
							<div class="row mb-3">
								<label for="modal_product_rm" class="col-2 col-form-label">비고</label>
								<div class="col-4"><input type="text" class="form-control" id="modal_product_rm"></div>
							</div>
						</div>
						<div class="modal-footer d-flex justify-content-between">
							<button type="button" class="btn btn-danger" id="btn_modal_reset">초기화</button>
							<div>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >닫기</button>
								<button type="submit" id="btn_modal_save" class="btn btn-primary">${text}</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			`;
			
			document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
			
			modalElement = document.getElementById(div_modal); // 새로 추가된 모달 참조
		}
		modal = new bootstrap.Modal(modalElement);  // 모달 초기화
		

		
        modalElement.addEventListener('shown.bs.modal', function () {
			createSelectBox($('#modal_product_gc'), commonList['PRDTYPE'], '선택하세요.');
			createSelectBox($('#modal_product_cc'), [], '선택하세요.');
			createSelectBox($('#modal_product_gd'), commonList['SHOEGENDER'], '선택하세요.');
			createSelectBox($('#modal_product_un'), commonList['UNIT'], '선택하세요.');
			createSelectBox('#modal_product_wh', warehouseList, '선택하세요.');
			createSelectBox($('#modal_product_us'), commonList['USEYN'], '선택하세요.');
			
			$('#modal_product_sz').select2({
			    dropdownParent: $('#' + div_modal),
			    placeholder: '사이즈를 선택하세요.',
			    width: '100%',
			    data: commonList['SIZE'].map(item => ({
			        id: item.common_cc,
			        text: `${item.common_nm}`,
			    }))
			}).next().after('<button type="button" class="btn btn-sm btn-secondary mt-1" id="select-all-size">전체 선택</button>');

			// 전체 선택/해제 토글 버튼 이벤트
			$('#select-all-size').on('click', function() {
			    var $select = $('#modal_product_sz');
			    var $button = $(this);
			    
			    if ($select.val() && $select.val().length === $select.find('option').length) {
			        // 모두 선택된 상태면 전체 해제
			        $select.val(null);
			        $button.text('전체 선택');
			    } else {
			        // 일부만 선택되었거나 아무것도 선택되지 않은 상태면 전체 선택
			        var allOptions = $select.find('option').map(function() {
			            return $(this).val();
			        }).get();
			        $select.val(allOptions);
			        $button.text('전체 해제');
			    }
			    
			    $select.trigger('change');
			});
			
			$('#modal_product_cr').select2({
			    dropdownParent: $('#' + div_modal),
			    placeholder: '색상을 선택하세요.',
			    width: '100%',
			    data: commonList['COLOR'].map(item => ({
			        id: item.common_cc,
			        text: `${item.common_nm}`,
			    }))
			}).next().after('<button type="button" class="btn btn-sm btn-secondary mt-1" id="select-all-colors">전체 선택</button>');

			// 전체 선택/해제 토글 버튼 이벤트
			$('#select-all-colors').on('click', function() {
			    var $select = $('#modal_product_cr');
			    var $button = $(this);
			    
			    if ($select.val() && $select.val().length === $select.find('option').length) {
			        // 모두 선택된 상태면 전체 해제
			        $select.val(null);
			        $button.text('전체 선택');
			    } else {
			        // 일부만 선택되었거나 아무것도 선택되지 않은 상태면 전체 선택
			        var allOptions = $select.find('option').map(function() {
			            return $(this).val();
			        }).get();
			        $select.val(allOptions);
			        $button.text('전체 해제');
			    }
			    
			    $select.trigger('change');
			});

			$('#modal_product_cd').mask('Z'.repeat(10), {
			        translation: {'Z': {pattern: /[A-Za-z0-9]/}},
			    })
			    .on('input', function() {
			        $(this).val($(this).val().toUpperCase());
			    });
				
				
			modal_product_cd = $('#modal_product_cd');
			modal_product_nm = $('#modal_product_nm');
			modal_product_gc = $('#modal_product_gc');
			modal_product_cc = $('#modal_product_cc');
			modal_product_sz = $('#modal_product_sz');
			modal_product_cr = $('#modal_product_cr');
			modal_product_gd = $('#modal_product_gd');
			modal_product_un = $('#modal_product_un');
			modal_product_wh = $('#modal_product_wh');
			modal_product_us = $('#modal_product_us');
			modal_product_rm = $('#modal_product_rm');
			
        });
		
		modalElement.addEventListener('hidden.bs.modal', function () {
 			$('button, input, select, textarea').each(function () {
                $(this).blur();
            });
			$('#modal_product_sz').select2('destroy');
			$('#modal_product_cr').select2('destroy');
			modalElement.remove();
		});
		
		modal.show();
		
	}
	
	// 모달 조회
	async function setModalInput(row) {
		let data = {
			warehouse_cd: row['warehouse_cd']
		}
		let jsonData = JSON.stringify(data);
		try {
		    let ajaxData = await callAjaxPost('/select_WAREHOUSE_detail', jsonData);
			let warehouse = ajaxData['warehouse'];
			
			modalData = {
			    warehouse_cd: warehouse['warehouse_cd'],
			    warehouse_nm: warehouse['warehouse_nm'],
			    warehouse_tp: warehouse['warehouse_tp'],
			    warehouse_in: warehouse['warehouse_in'],
			    warehouse_us: warehouse['warehouse_us'] == true ? 1 : 0,
			    warehouse_rm: warehouse['warehouse_rm']
			};
			
			setModalValues(modalData);
		} catch (error) {
			showAlert('', 'error', '조회 실패', error.msg);
		}
	}
	
	// 제품 등록
	async function insert_PRODUCT() {
		/*
		const validations = [
		    { field: modal_warehouse_cd, message: '창고코드를 입력해주세요.' },
		    { field: modal_warehouse_nm, message: '창고명을 입력해주세요.' },
		    { field: modal_warehouse_tp, message: '창고유형을 선택해주세요.' },
		    { field: modal_warehouse_in, message: '정렬순서를 입력해주세요.' },
		    { field: modal_warehouse_us, message: '사용여부를 선택해주세요.' }
		];
		const invalidField = validations.find(v => !v.field.val()?.trim());
		if (invalidField) {
		    showAlert(invalidField.field, 'warning', '', invalidField.message);
		    return;
		}
		*/

		if(!await showConfirm(`제품 등록`, `제품을 등록하시겠습니까?`)) {
			return;
		}
		let product = {
			product_cd: modal_product_cd.val().trim(),
			product_nm: modal_product_nm.val().trim(),
			item_cd: modal_product_cc.val(),
			product_gd: modal_product_gd.val(),
			product_un: modal_product_un.val(),
			product_wh: modal_product_wh.val(),
			product_us: modal_product_us.val() == 1 ? true : false,
			product_rm: modal_product_rm.val().trim(),
		}
		
		let data = {
			product: product,
			sizeList: modal_product_sz.val(),
			colorList: modal_product_cr.val(),
		}
		
		let jsonData = JSON.stringify(data);
		try {
		    let ajaxData = await callAjaxPost('/insert_PRODUCT', jsonData);
		    // 성공 시 실행되는 코드
			showAlert('', 'success', '등록 성공', '');
			grid.resetData(ajaxData['list']);
			// resetSearchInput();
			modal.hide();
		} catch (error) {
			showAlert('', 'error', '등록 실패', error.msg);
		}
	}
	
	// 창고 삭제
	async function delect_WAREHOUSE(checkedRows) {
		if (!await showConfirm(`창고 삭제`, '선택한 창고를 삭제하시겠습니까?')) { 
			return;
		}
		
		let jsonData = JSON.stringify({warehouseList: checkedRows});
		let ajaxData = await callAjaxPost('/delete_WAREHOUSE', jsonData);
		try {
			grid.resetData(ajaxData['list']);
			resetSearchInput();
			showAlert('', 'success', '삭제 성공', '삭제에 성공했습니다.');
		} catch (error) {
			showAlert('', 'error', '삭제 실패', error['msg']);
		}
	}

	// 인풋 입력
	function setModalValues(data) {
	    modal_warehouse_cd.val(data.warehouse_cd);
	    modal_warehouse_nm.val(data.warehouse_nm);
	    modal_warehouse_tp.val(data.warehouse_tp);
	    modal_warehouse_in.val(data.warehouse_in);
	    modal_warehouse_us.val(data.warehouse_us);
	    modal_warehouse_rm.val(data.warehouse_rm);
	}
	
	// 검색 인풋 초기화
	function resetSearchInput(){
		$('#warehouse_cd').val('');
		$('#warehouse_nm').val('');
		$('#warehouse_tp').val('');
		setRadioValue('warehouse_us', 'ALL');
	}

</script>
</html>