<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">
<!-- Toast UI grid CSS File-->
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<main id="main" class="main">
	<div class="pagetitle">
		<!-- Page Title -->
		<h1>급여</h1>
		<!-- Start Page Title -->
		<nav>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="/log">급여</a></li>
				<li class="breadcrumb-item">급여 조회</li>
			</ol>
		</nav>
	</div>
	<!-- End Page Title -->
	<div id="grid"></div>
</main>
<!-- Toast UI grid JS File -->
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script type="text/javascript">
	$(function() {
		const grid = new tui.Grid({
			el : document.getElementById('grid'),
			responsive: true,
			scrollX:true,
			scrollY:true,
			columns : [ 
				{
					header : 'NO.',
					name : 'num'
				}, 
				{
					header : '지급년월',
					name : 'givedate'
				}, 
				{
					header : '귀속년월',
					name : 'workdate'
				}, 
				{
					header : '실지급액',
					name : 'codename'
				}, 
				{
					header : '명세서',
					name : 'details',
					formatter: function() {
                        return ` 
                            <button type="button" class="btn btn-link btn_detail" data-bs-toggle="modal" data-bs-target="#verticalycentered" >조회</button>
                            <button type="button" class="btn btn-link btn_email">이메일</button>
                        `;
                    }
				} 
			],
			data : [ 
				{
					num: 1,
					givedate: '24.11',
					workdate: '24.10',
					codename: '1800000'
				},
				{
					num: 2,
					givedate: '24.10',
					workdate: '24.11',
					codename: '1800000'
				},
			]
		});
		
		// 이벤트 위임 방식으로 클릭 이벤트 처리
       document.getElementById('grid').addEventListener('click', function (event) {
			const target = event.target;
			if (target.classList.contains('btn_detail')) {
				console.log('조회 버튼 클릭 확인');

				// 부모 셀 요소에서 행(Row)의 rowKey 가져오기
				const cellElement = target.closest('.tui-grid-cell'); // 가장 가까운 셀 요소
				const rowKey = cellElement?.dataset?.rowKey; // rowKey 가져오기

				if (rowKey) {
					const rowData = grid.getRow(Number(rowKey)); // 행 데이터 가져오기
					console.log('행 데이터:', rowData);

					// 모달 ID
					const modalId = 'verticalycentered';
					let modalElement = document.getElementById(modalId);

					// 기존 모달이 없으면 새로 생성
					if (!modalElement) {
						const modalHtml = 
						`<div class="modal fade" id="${modalId}" tabindex="-1">
	                       <div class="modal-dialog modal-dialog-centered modal-xl">
	                           <div class="modal-content">
	                               <div class="modal-header">
	                                   <h5 class="modal-title">${rowData.workdate}(귀속년월) 명세서</h5>
	                                   <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	                               </div>
	                               <div class="modal-body">
	                                   <div id="gridOnespe"></div>
	                               </div>
	                               <div class="modal-footer">
	                                   <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	                                   <button type="button" class="btn btn-primary">Save changes</button>
	                               </div>
	                           </div>
	                       </div>
	                   </div>`;
						document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
						modalElement = document.getElementById(modalId); // 새로 추가된 모달 참조
					}

					// 모달이 열리고 나서 그리드를 초기화
	                const modal = new bootstrap.Modal(modalElement);  // 모달 초기화
	                modalElement.addEventListener('shown.bs.modal', function () {
	                    // 모달이 열릴 때 그리드 초기화
	                    const gridOnespe = new tui.Grid({
	                        el: document.getElementById('gridOnespe'),
	                        scrollX: true,
	                        scrollY: true,
	                        columns: [
	                            { header: 'NO.', name: 'num' }
	                        ],
	                        data: [
	                            { num: 'test' } 
	                        ]
	                    });

	                    console.log(gridOnespe.getData());
	                });
					
					// 모달이 닫힐 때 DOM에서 제거
					modalElement.addEventListener('hidden.bs.modal', function () {
						modalElement.remove();
						console.log('모달이 닫히고 삭제되었습니다.');
					});
					
					modal.show();
				}
			}

			if (target.classList.contains('btn_email')) {
				console.log('이메일 버튼 클릭 확인');
				/* 이메일 전송 라이브러리 가져올 예정 */
			}
		});
	});
</script>
</html>
