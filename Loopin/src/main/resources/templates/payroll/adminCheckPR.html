<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">
<!-- Toast UI grid CSS File-->
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<main id="main" class="main">
	<div id="grid"></div>
</main>
<!-- Toast UI grid JS File -->
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script type="text/javascript">
	$.ajax({
				url : "/checkpradmin",
				method : "GET",
				dataType : "JSON",
				success : function(data) {
					console.log('가져온데이터',data);
					const result = data.map((item, index) => ({
						...item,
						INDEX : data.length - index
					}))
					grid.resetData(result);
				},
				error : function(xhr, status, error) {
					console.error("급여 조회 데이터를 불러오는 데 실패했습니다.", error);
				}
			}); 
			const grid = new tui.Grid({
				el: document.getElementById('grid'),
				responsive: true,
				scrollX: true,
				scrollY: true,
				bodyHeight : 485,
				columns: [
					{header: 'NO.', name: 'INDEX'},
					{header: '지급년월', name: 'PR_GM'},
					{header: '귀속년월', name: 'PR_WM'},
					{header: '지급총액', name: 'PR_TA'},
					{header: '공제총액', name: 'PR_TD'},
					{
						header: '명세서',
						name: 'details',
						formatter: function () {
							return `
							<button type="button" class="btn btn-link btn_detail" data-bs-toggle="modal" data-bs-target="#verticalycentered">조회</button>
							<button type="button" class="btn btn-link btn_email">이메일</button>
						`;
						}
					}
				],
			});

			document.getElementById('grid').addEventListener('click', function (event) {
				const target = event.target;
				if (target.classList.contains('btn_detail')) {
					console.log('조회 버튼 클릭 확인');

					const cellElement = target.closest('.tui-grid-cell');
					const rowKey = cellElement?.dataset?.rowKey;

					if (rowKey) {
						const rowData = grid.getRow(Number(rowKey));
						console.log('행 데이터:', rowData);

						const modalId = 'verticalycentered';
						let modalElement = document.getElementById(modalId);

						if (!modalElement) {
							const modalHtml = `
								<div class="modal fade" id="${modalId}" tabindex="-1">
									<div class="modal-dialog modal-dialog-centered modal-xl">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title">${rowData.PR_WM}(귀속년월) 명세서</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<div id="gridspes"></div>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
												<button type="button" class="btn btn-primary">Save changes</button>
											</div>
										</div>
									</div>
								</div>`;
							document.body.insertAdjacentHTML('beforeend', modalHtml);
							modalElement = document.getElementById(modalId);
						}

						const modal = new bootstrap.Modal(modalElement);
						// 모달이 열릴 때에만 그리드를 초기화
						modalElement.addEventListener('shown.bs.modal', function () {
							const pr_id = rowData.PR_ID;
		    				console.log('id 데이터:', pr_id);
							$.ajax({
		            			url : "/adminprmodal",
		            			method : "GET",
		            			dataType : "JSON",
		            			data:{
		            				pr_id : pr_id
		            			}, 
		            			success : function(result) {
		            				console.log('모달데이터1',result);
		            				const transresult = result.map((item, index) =>({
		            					...item,
		            					num : result.length - index,
		            				}));
		            				gridspes.resetData(transresult);
		            			},
		            			error : function(xhr, status, error) {
		            				console.error("급여 모달1 조회 데이터를 불러오는 데 실패했습니다.", error);
		            			}
		            		}); 
							const gridspes = new tui.Grid({
								el: document.getElementById('gridspes'),
								scrollX: true,
								scrollY: true,
								columns: [
									{header: 'NO.', name: 'num'},
									{header: '사원코드', name: 'EMPLOYEE_CD'},
									{header: '사원명', name: 'PRDETAIL_NM'},
									{header: '기본급', name: 'PRDETAIL_BS'},
									{header: '총지급액', name: 'PRDETAIL_TA'},
									{header: '총공제액', name: 'PRDETAIL_TD'},
									{header: '실지급액', name: 'PRDETAIL_RS'},
								],
							});

							console.log("first grid", gridspes.getData());

							// gridspes 그리드 클릭 이벤트 처리
							document.getElementById('gridspes').addEventListener('click', function (e) {
								const clickedCell = e.target.closest('.tui-grid-cell');
								if (clickedCell) {
									console.log('사원 상세 클릭:', clickedCell);

									const rowKey2 = clickedCell?.dataset?.rowKey;
									const rowData2 = gridspes.getRow(Number(rowKey2));
									console.log('사원 상세 데이터:', rowData2);

									const newModalId = 'newModal';
									let newModalElement = document.getElementById(newModalId);

									if (!newModalElement) {
										const newModalHtml = `
						                    <div class="modal fade" id="${newModalId}" tabindex="-1">
						                        <div class="modal-dialog modal-dialog-centered modal-xl">
						                            <div class="modal-content">
						                                <div class="modal-header">
						                                    <h5 class="modal-title">사원 상세</h5>
						                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						                                </div>
						                                <div class="modal-body">
						                                    <div id="newGrid"></div>
						                                </div>
						                                <div class="modal-footer">
						                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
						                                    <button type="button" class="btn btn-primary">Save changes</button>
						                                </div>
						                            </div>
						                        </div>
						                    </div>`;
										document.body.insertAdjacentHTML('beforeend', newModalHtml);
										newModalElement = document.getElementById(newModalId);
									}

									const newModal = new bootstrap.Modal(newModalElement);
									newModal.show();

									// 새로운 그리드를 모달이 열리고 나서 초기화
									newModalElement.addEventListener('shown.bs.modal', function () {
										const newGrid = new tui.Grid({
											el: document.getElementById('newGrid'),
											scrollX: true,
											scrollY: true,
											columns: [
												{header: '사원코드', name: 'employee_cd'},
												{header: '이름', name: 'employee_name'},
												{header: '부서', name: 'department'},
											],
											data: [
												{employee_cd: 'E001', employee_name: '홍길동', department: '인사부'},
											]
										});

										console.log("second grid", newGrid.getData());
									});

									// 모달이 닫히면 그리드를 제거할 수 있도록 처리
									newModalElement.addEventListener('hidden.bs.modal', function () {
										newModalElement.remove();
									});
								}
							});
						});

						modal.show();
					}
				}

				if (target.classList.contains('btn_email')) {
					console.log('이메일 버튼 클릭 확인');
					/* 이메일 전송 라이브러리 가져올 예정 */
				}
			});
</script>
</html>
