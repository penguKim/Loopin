<html lang="ko" xmln	s:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout}" layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<!-- Toast UI grid CSS File-->
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<body>
<span id="employee_cd" sec:authentication="principal.employee_cd" style="display: none;"></span>
<span id="employee_nm" sec:authentication="principal.employee_nm" style="display: none;"></span>
	<main id="main" class="main">
		<div class="pagetitle"></div>
		<div class="col-lg-12">
			<div class="card">
				<div class="d-flex items-align-center justify-content-">
				</div>
				<div class="card-body">
					<div class="card-title d-flex">
						<h5 id="premth"></h5>
						<h5>급여이체</h5>
					</div>
					<div class="d-flex justify-content-end align-items-end p-3">
						<input type="button" id="btn_wt" class="btn btn-primary ml-3" data-bs-toggle="modal"
							data-bs-target="#wtmodal" value="근태마감">
					</div>
					<div id="grid" class="p-3"></div>
					<div class="d-flex justify-content-end align-items-end">
						<input type="button" id="btn_send" class="btn btn-primary ml-3" value="이체하기">
					</div>
				</div>
			</div>
		</div>
	</main>
</body>
<!-- Toast UI grid JS File -->
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script type="text/javascript">
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	var empcd = document.getElementById('employee_cd').textContent;
	tui.Grid.setLanguage('ko');
	tui.Grid.applyTheme('striped');
	
	function formatCurrency(value) {
		  if (value && typeof value === 'object' && value.amount !== undefined) {
		    return value.amount.toLocaleString('ko-KR', { style: 'currency', currency: 'KRW' });  // 객체의 'amount' 속성에 쉼표 추가
		  } else if (typeof value === 'number') {
		    return value.toLocaleString('ko-KR',{ style: 'currency', currency: 'KRW' });  // 숫자에 대해서도 쉼표 추가
		  }
		  return value;  // 객체나 숫자가 아니면 원래 값 그대로 반환
		}
	
	//////////////
	// 그리드 생성 // 
	//////////////
	/* 결과그리드 */
	const grid = new tui.Grid({
		el: document.getElementById('grid'),
		responsive: true,
		scrollX: true,
		scrollY: true,
		bodyHeight: 330,
		header: {
			height: 130,
			complexColumns: [
				{
					header: '지급액',
					name: 'PAY',
					childNames: ['PRDETAIL_BS', 'B_MT', 'B_OT', 'B_NA', 'B_WA', 'B_HA', 'B_RL', 'B_BN']
				},
				{
					header: '공제액',
					name: 'DEDUCATION',
					childNames: ['D_GM', 'D_GY', 'D_GG', 'D_LG']
				},
			]
		},
		columns: [
			{
				header: 'prdetail_id',
				name: 'EMPLOYEE_ID',
				hidden: true,
			},
			{
				header: '사원번호',
				name: 'EMPLOYEE_CD',
				align : 'center'
				
			},
			{
				header: '사원명',
				name: 'EMPLOYEE_NM',
				align : 'center'
			},
			{
				header: '실지급액',
				name: 'PRDETAIL_RS',
				align : 'right'
			},
			{
				header: '총지급액',
				name: 'PRDETAIL_TA',
				align : 'right'
			},
			{
				header: '기본급',
				name: 'PRDETAIL_BS',
				align : 'right'
			},
			{
				header: '식대',
				name: 'PRDETAIL_MT',
				align : 'right'
			},
			{
				header: '연장수당',
				name: 'PRDETAIL_OT',
				align : 'right'
			},
			{
				header: '야근수당',
				name: 'PRDETAIL_NA',
				align : 'right'
			},
			{
				header: '주말근무수당',
				name: 'PRDETAIL_WA',
				align : 'right'
			},
			{
				header: '휴일수당',
				name: 'PRDETAIL_HA',
				align : 'right'
			},
			{
				header: '연차수당',
				name: 'PRDETAIL_RL',
				align : 'right'
			},
			{
				header: '상여',
				name: 'PRDETAIL_BN',
				editor: 'text',
				align : 'right'
			},
			{
				header: '총공제액',
				name: 'PRDETAIL_TD',
				align : 'right'
			},
			{
				header: '국민연금',
				name: 'PRDETAIL_GM',
				align : 'right'
			},
			{
				header: '고용보험',
				name: 'PRDETAIL_GY',
				align : 'right'
			},
			{
				header: '건강보험',
				name: 'PRDETAIL_GG',
				align : 'right'
			},
			{
				header: '장기요양',
				name: 'PRDETAIL_LG',
				align : 'right'
			},
		],
		columnOptions: {
			resizable: true,
		},
		summary: {
		    height: 40,
		    position: 'bottom',
		    columnContent: {
		    	empl: {
		            template: (valueMap) => {
		                return `총  ${valueMap.cnt} 명`
		            }
		        },
		    	rs: {
		            template: (valueMap) => {
		                return `총  ${valueMap.sum} 원`
		            }
		        },
		    	ta: {
		            template: (valueMap) => {
		                return `총  ${valueMap.sum} 원`
		            }
		        },
		    	td: {
		            template: (valueMap) => {
		                return `총  ${valueMap.sum} 원`
		            }
		        },
		    }
		},
	});

	//   ===========
	//	|| 날짜 함수 ||
	//   ===========

	//귀속년월 구하기
	function getpreMth() {
		const today = new Date();
		console.log('today', today)
		today.setMonth(today.getMonth() - 1);
		var year = today.getFullYear();
		console.log('year', year);
		var month = today.getMonth() + 1;
		if (month < 10) {
			month = '0' + month;
		}
		return year + '-' + month;
	};
	const premth = getpreMth();
	document.addEventListener('DOMContentLoaded', function () {
		document.getElementById('premth').innerText = getpreMth();
	});

	/* //1일에 버튼활성화
	function checkAndActivateButton() {
		const today = new Date();
		const dayOfMonth = today.getDate(); // 오늘 날짜

		if (dayOfMonth === 1) {
			$('#btn_wt').prop('disabled', false); // 매월 1일에 버튼 활성화
			console.log("버튼이 활성화되었습니다.");
		}
	}

	// 매일 한번 날짜를 체크
	setInterval(checkAndActivateButton, 24 * 60 * 60 * 1000); // 24시간마다 체크

	// 페이지 로드 시 버튼 상태 확인
	$(document).ready(function () {
		checkAndActivateButton();
	}); */

	//////////
	// AJAX // 
	//////////		

	$.ajax({
		url: "/getempandbs",
		method: "GET",
		dataType: "JSON",
		data:{premth},
		success: function (empdata) {
			console.log('첫 데이터', empdata);
			const firstdata = empdata.map(item => {
				return {
					EMPLOYEE_CD: item.EMPLOYEE_CD,
					EMPLOYEE_NM: item.EMPLOYEE_NM,
					BS: formatCurrency(item.BS),
					PRDETAIL_BS: formatCurrency(item.PRDETAIL_BS),
					PRDETAIL_RS: formatCurrency(item.PRDETAIL_RS),
					PRDETAIL_TA: formatCurrency(item.PRDETAIL_TA),
					PRDETAIL_TD: formatCurrency(item.PRDETAIL_TD),
					PRDETAIL_BN: formatCurrency(item.PRDETAIL_BN),
					PRDETAIL_HA: formatCurrency(item.PRDETAIL_HA),
					PRDETAIL_MT: formatCurrency(item.PRDETAIL_MT),
					PRDETAIL_NA: formatCurrency(item.PRDETAIL_NA),
					PRDETAIL_OT: formatCurrency(item.PRDETAIL_OT),
					PRDETAIL_RL: formatCurrency(item.PRDETAIL_RL),
					PRDETAIL_WA: formatCurrency(item.PRDETAIL_WA),
					PRDETAIL_GG: formatCurrency(item.PRDETAIL_GG),
					PRDETAIL_GM: formatCurrency(item.PRDETAIL_GM),
					PRDETAIL_GY: formatCurrency(item.PRDETAIL_GY),
					PRDETAIL_LG: formatCurrency(item.PRDETAIL_LG),
					
				};
			})
			grid.resetData(firstdata);
			const BSwempcd = empdata.map(item => {return {employee_cd: item.EMPLOYEE_CD, BS: item.BS}});
			const employee_cd = empdata.map(item => item.EMPLOYEE_CD);
			window.BSwempcd = BSwempcd;
			window.employee_cd = employee_cd;
		},
		error: function (xhr, status, error) {
			console.log('premth',typeof(premth));
			console.log('사원정보 데이터 조회 실패했습니다.')
		}
	});

	/////////////
	// 버튼 함수 // 
	/////////////

	//근태확인 버튼
	$('#btn_wt').on('click', function () {
		if ($(this).prop('disabled')) {
			swal.fire({
				title:"이미 마감되었습니다.",
				text:"1일에 다시 마감해주세요",
				icon: 'warning',
			});
		} else {
			const currentday = new Date();
			console.log('근태cday', currentday);
			const day = currentday.getDate();

			const modalid = 'wtmodal';
			let modalEl = document.getElementById(modalid);

			if (!modalEl) {
				const modalHtml = `
            <div class="modal" id="${modalid}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">근태마감</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="grid_wt"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="btn_ct">마감</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </div>
            </div>`;
				document.body.insertAdjacentHTML('beforeend', modalHtml);
				modalEl = document.getElementById(modalid);
			}

			modalEl.addEventListener('hidden.bs.modal', function () {
				modalEl.remove();
				console.log('근태 확인 모달이 닫히고 삭제되었습니다.');
			});

			const modal = new bootstrap.Modal(modalEl);

			modalEl.addEventListener('shown.bs.modal', function () {
				const gridContainer = document.getElementById('grid_wt');
				console.log('gridcon', gridContainer);

				if (gridContainer) {
					console.log('day', day);
					console.log('empCD', employee_cd);

					if (day >= 1 && day <= 20) {
						$.ajax({
							url: "/getworkingtimeformth",
							method: "GET",
							dataType: "JSON",
							data: {employee_cds: employee_cd, premth: premth},
							success: function (data) {
								console.log("근태 데이터", data);
								const wtdata = data.map(item => {
									return {
										employee_cd: item.EMPLOYEE_CD !== undefined ? item.EMPLOYEE_CD : null,
										employee_nm: item.EMPLOYEE_NM !== undefined ? item.EMPLOYEE_NM : "없음",
										workingtime: item.WORKINGTIME !== undefined ? item.WORKINGTIME : 0,
										overworkingtime: item.OVERWORKINGTIME !== undefined ? item.OVERWORKINGTIME : 0,
										nightworkingtime: item.NIGHTWORKINGTIME !== undefined ? item.NIGHTWORKINGTIME : 0,
										weekendworkingtime: item.WEEKENDWORKINGTIME !== undefined ? item.WEEKENDWORKINGTIME : 0,
										holydayworkingtime: item.HOLYDAYWORKINGTIME !== undefined ? item.HOLYDAYWORKINGTIME : 0,
										remainleave: item.ANNUAL_RA !== undefined ? item.ANNUAL_RA : 0,
									};
								});
								console.log('데이터확인', wtdata);
								const grid_wt = new tui.Grid({
									el: gridContainer,
									responsive: true,
									scrollX: false,
									scrollY: true,
									bodyHeight: 330,
									columns: [
										{header: '사원코드', name: 'employee_cd', align: 'center'},
										{header: '사원명', name: 'employee_nm', align: 'center'},
										{header: '일반근무', name: 'workingtime', align: 'center'},
										{header: '연장근무', name: 'overworkingtime', align: 'center'},
										{header: '야간근무', name: 'nightworkingtime', align: 'center'},
										{header: '주말근무', name: 'weekendworkingtime', align: 'center'},
										{header: '휴일근무', name: 'holydayworkingtime', align: 'center'},
										{header: '남은연차', name: 'remainleave', align: 'center'},
									],
									columnOptions: {
										resizable: true,
									},
								});
								grid_wt.resetData(wtdata);

								/* 근태확정버튼 */
								$(document).on('click', '#btn_ct', function () {
									console.log('확정버튼누름!!!!!!!!');
									const wdata = wtdata.map(item => {
										let bsdata = BSwempcd.find(i => i.employee_cd === item.employee_cd);

										return {
											...item,
											BS: bsdata.BS,
											wm: premth,
											wr: empcd,
										}
									});
									console.log('가져와', wdata);
									swal.fire({
										title: "정말 마감하시겠습니까?",
										text: "마감하시면 더이상 수정은 불가능합니다.",
										icon: "warning",
										showCancelButton: true,
										confirmButtonColor: "#774df1",
										cancelButtonColor: "",
										confirmButtonText: "마감"
									}).then((result) => {
										if (result.isConfirmed) {
											$.ajax({
												url: "/update_commuteprandcalpr",
												method: "POST",
												contentType: "application/json",
												data: JSON.stringify(wdata),
												beforeSend: function (xhr) {
													xhr.setRequestHeader(header, token);
												},
												success: function (data) {
													console.log('근태확정', data);
													Swal.fire({
														title: "마감되었습니다.",
														icon: "success"
													});
													// $('#btn_wt').prop('disabled', true);
													const result = data.map(item => {
														const calculatedData = item.calculated;  
														if (Array.isArray(calculatedData)) {
															const result = calculatedData.reduce((acc, calItem) => {
																acc[calItem.prdetail_nm] = calItem.amount;  // prdetail_nm을 키로, amount를 값으로 누적
																return acc;
															}, {
																ta: item.ta,
																td: item.td,
																rs: item.rs,
																employee_cd: item.employee_cd,
																employee_nm: item.employee_nm
															});
															return result;
														}
														return {}; 
													});
													console.log('변환된 데이터:', result);
													const resultA = result.map(item => ({
														...item,
														EMPLOYEE_CD: formatCurrency(item.employee_cd),
														EMPLOYEE_NM: formatCurrency(item.employee_nm),
														PRDETAIL_BS: formatCurrency(item.BS),
														PRDETAIL_RS: formatCurrency(item.rs),
														PRDETAIL_TA: formatCurrency(item.ta),
														PRDETAIL_TD: formatCurrency(item.td),
														PRDETAIL_BN: formatCurrency(item.B_BN),
														PRDETAIL_HA: formatCurrency(item.B_HA),
														PRDETAIL_MT: formatCurrency(item.B_MT),
														PRDETAIL_NA: formatCurrency(item.B_NA),
														PRDETAIL_OT: formatCurrency(item.B_OT),
														PRDETAIL_RL: formatCurrency(item.B_RL),
														PRDETAIL_WA: formatCurrency(item.B_WA),
														PRDETAIL_GG: formatCurrency(item.D_GG),
														PRDETAIL_GM: formatCurrency(item.D_GM),
														PRDETAIL_GY: formatCurrency(item.D_GY),
														PRDETAIL_LG: formatCurrency(item.D_LG),
													}))
													grid.resetData(resultA);
													modal.hide();
												},
												error: function (xhr, status, error) {
													console.log('근태확정 데이터 전송에 실패했습니다.', error);
													Swal.fire({
														title: "마감 실패",
														icon: "error",
														text: "데이터 전송에 실패했습니다. 다시 시도해주세요."
													});
												}
											});
										}
									});
								});
							},
							error: function (xhr, status, error) {
								console.log("근태 확정 데이터 조회에 실패했습니다.", error);
								Swal.fire({
									title: "오류",
									icon: "error",
									text: "근태 데이터를 불러오는 데 실패했습니다."
								});
							}
						});
					} else {
						swal.fire({
							icon: 'error',
							title: '사용불가',
							text: '1일부터 7일 사이에만 조회 가능합니다.'
						});
					}
				}
			});
			modal.show();
		}
	});

	////////////////
	// 상여 업데이트 //
	////////////////

	grid.on('afterChange', function (e) {
		console.log('Changes:', e);

		e.changes.forEach(change => {
			const updaterowid = change.rowKey;  // 변경된 행의 rowKey
			const updatedValue = Number(change.value);  // 변경된 셀의 값
			const updaterowpid = grid.getRow(updaterowid).prdetail_id;


			console.log('Row ID:', updaterowid);
			console.log('Updated Value:', updatedValue);
			console.log('Updated type:', typeof updatedValue);
			console.log('prdetail_id', updaterowpid)

			const originalData = originalValues[updaterowpid];  // 원래 데이터 (서버에서 받아온 값)
			console.log('Original Data:', originalData);

			const RS = originalData.rs; // 원래 급여
			const TA = originalData.ta; // 원래 총액
			const TD = originalData.td;

			console.log('RS:', RS);
			console.log('TA:', TA);
			console.log('TAtype', typeof TA);
			console.log('TD:', TD);

			if (change.columnName === 'B_BN') {
				console.log('bn임');
				const updateta = TA + updatedValue;  // 총액 (ta) 갱신
				const updaters = updateta - TD;      // 실제 급여 (rs) 갱신
				console.log('updateta임', updateta);
				console.log('updaters임', updaters);

				grid.setValue(updaterowid, 'ta', updateta);  // 총액 업데이트
				grid.setValue(updaterowid, 'rs', updaters);  // 실제 급여 업데이트
			}
		});
	});

</script>