<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>작업지시</title>
<style>
.tui-datepicker, .tui-timepicker, .tui-calendar {
	z-index: 9999 !important;
}
</style>
</head>
<body>
	<main id="main" class="main">
		<section class="section">
			<div class="row">
				<div class="col-lg-12">
					<div class="card" id="div_card">
						<div class="card-body">
							<h5 class="card-title">작업지시 관리</h5>

							<!-- 필터 UI (LOT번호, 작업시작일, 작업상태 등) -->
							<div id="filterModule" class="mb-3"></div>

							<!-- 메인 그리드: 작업지시 목록 -->
							<div id="grid"></div>

							<!-- 버튼 영역 -->
							<div id="btn_area" class="mt-3 d-flex">
								<div>
									<button type="button" class="btn btn-primary" id="btn_insert">등록</button>
									<button type="button" class="btn btn-primary" id="btn_delete">삭제</button>
								</div>
							</div>
							<br>

							<!-- 작업지시 등록/수정 모달 -->
							<div class="modal" id="workorderModal" tabindex="-1"
								aria-labelledby="modalLabel" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="workorderModalTitle">작업지시 등록</h5>
											<button type="button" class="btn-close"
												data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<form id="workorderForm">
												<div class="row mb-3">
													<!-- LOT번호 (필드 클릭 → 검색 모달) -->
													<div class="col-md-4">
														<label for="lot_cd" class="form-label">LOT 번호</label> <input
															type="text" class="form-control" id="lot_cd" readonly>
													</div>
													<!-- 공정코드 (LOT 선택 시 자동) -->
													<div class="col-md-4">
														<label for="process_cd" class="form-label">공정코드</label> <input
															type="text" class="form-control" id="process_cd" readonly>
													</div>
													<!-- 작업자(dailyproductplan_jb) : 필드 클릭 → 검색 모달 -->
													<div class="col-md-4">
														<label for="workorder_jb" class="form-label">작업자</label> <input
															type="text" class="form-control" id="workorder_jb"
															readonly>
													</div>
												</div>
												<div class="row mb-3">
													<!-- 작업일자(dailyproductplan_sd) : LOT에서 product_cd 찾아 조회 -->
													<div class="col-md-4">
														<label for="dailyplan_sd" class="form-label">작업일자</label>
														<input type="text" class="form-control" id="dailyplan_sd"
															readonly>
													</div>
													<!-- 작업시작시간(workorder_sd) : 사용자 입력 -->
													<div class="col-md-4">
														<label for="workorder_sd" class="form-label">작업시작시간</label>
														<input type="text" class="form-control" id="workorder_sd">
													</div>
													<!-- 작업종료시간(workorder_ed) : 사용자 입력 -->
													<div class="col-md-4">
														<label for="workorder_ed" class="form-label">작업종료시간</label>
														<input type="text" class="form-control" id="workorder_ed">
													</div>
												</div>
												<div class="row mb-3"></div>
												<!-- 작업지시상태 (기본 "10"=대기) : hidden -->
												<input type="hidden" id="workorder_st" value="10">
											</form>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary"
												data-bs-dismiss="modal">취소</button>
											<button type="button" class="btn btn-primary"
												id="btnSaveWorkOrder">저장</button>
										</div>
									</div>
								</div>
							</div>

							<!-- 검색 모달 (LOT / WORKER) -->
							<div class="modal" id="searchModal" tabindex="-1">
								<div
									class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="searchModalTitle">검색 모달</h5>
											<button type="button" class="btn-close"
												data-bs-dismiss="modal"></button>
										</div>
										<br>
										<div class="col d-flex align-items-center">
											<input type="text" id="searchInput" class="form-control me-2"
												placeholder="검색어 입력"
												style="width: 150px; margin-left: 15px;"> <input
												type="button" id="btnSearch" class="btn btn-primary"
												value="검색">
										</div>
										<div class="modal-body">
											<div id="searchGrid"></div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary"
												data-bs-dismiss="modal">닫기</button>
											<button type="button" class="btn btn-primary" id="selectBtn">추가</button>
										</div>
									</div>
								</div>
							</div>
							<!-- 검색 모달 끝 -->

						</div>
						<!-- card-body -->
					</div>
					<!-- card -->
				</div>
			</div>
		</section>
	</main>

	<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function() {
  // ---------------------------
  // 1) 작업지시 목록 그리드
  // ---------------------------
  const grid = new tui.Grid({
    el: document.getElementById("grid"),
    rowHeaders: ['checkbox'],
    columns: [
      { header: '작업지시번호', name: 'workorder_cd' },
      { header: 'LOT 번호',    name: 'lot_cd' },
      { header: '공정코드',    name: 'process_cd' },
      { header: '작업일자',    name: 'dailyproductplan_sd' }, // DB 저장 시 dailyproductplan_sd
      { header: '작업시작시간',name: 'workorder_sd' },
      { header: '작업종료시간',name: 'workorder_ed' },
      { header: '작업자',      name: 'dailyproductplan_jb' },
      { header: '상태',       name: 'workorder_st' }
    ],
    data: [],
    scrollX: false,
    scrollY: false
  });

  // ---------------------------
  // 2) 검색 모달용 그리드
  // ---------------------------
  let searchGrid;
  let searchMode = "";  // "lot" or "worker"

  // ---------------------------
  // 3) 작업지시 등록 모달
  // ---------------------------
  const workorderModalEl   = document.getElementById("workorderModal");
  const workorderModal     = new bootstrap.Modal(workorderModalEl);

  // 필드들
  const lotCdInput         = document.getElementById("lot_cd");
  const processCdInput     = document.getElementById("process_cd");
  const dailyplanSdInput   = document.getElementById("dailyplan_sd"); // 작업일자
  const workorderSdInput   = document.getElementById("workorder_sd"); // 작업시작시간
  const workorderEdInput   = document.getElementById("workorder_ed"); // 작업종료시간
  const workorderJbInput   = document.getElementById("workorder_jb"); // 작업자
  const workorderStInput   = document.getElementById("workorder_st"); // hidden, default=10

  function openWorkOrderModal(mode, rowData=null) {
    if (mode === "insert") {
      document.getElementById("workorderModalTitle").textContent = "작업지시 등록";
      // 시퀀스 처리
      lotCdInput.value       = "";
      processCdInput.value   = "";
      dailyplanSdInput.value = "";
      workorderSdInput.value = "";
      workorderEdInput.value = "";
      workorderJbInput.value = "";
      workorderStInput.value = "10"; // 대기
    } else if (mode === "update" && rowData) {
      document.getElementById("workorderModalTitle").textContent = "작업지시 수정";
      lotCdInput.value       = rowData.lot_cd || "";
      processCdInput.value   = rowData.process_cd || "";
      dailyplanSdInput.value = rowData.dailyproductplan_sd || "";
      workorderSdInput.value = rowData.workorder_sd || "";
      workorderEdInput.value = rowData.workorder_ed || "";
      workorderJbInput.value = rowData.dailyproductplan_jb || "";
      workorderStInput.value = rowData.workorder_st || "10";
    }
    workorderModal.show();
  }

  // 저장
  document.getElementById("btnSaveWorkOrder").addEventListener("click", () => {
    const reqBody = {
      lot_cd            : lotCdInput.value,
      process_cd        : processCdInput.value,
      dailyproductplan_sd: dailyplanSdInput.value,  // 작업일자
      workorder_sd      : workorderSdInput.value,   // 시작시간
      workorder_ed      : workorderEdInput.value,   // 종료시간
      dailyproductplan_jb: workorderJbInput.value,  // 작업자
      workorder_st      : workorderStInput.value    // "10"
    };

    fetch("/save_WORKORDER", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(reqBody)
    })
    .then(res => {
      if (!res.ok) throw new Error("작업지시 저장 실패");
      return res.text(); // or res.json()
    })
    .then(data => {
      alert("작업지시 저장 완료");
      workorderModal.hide();
      fetchWorkOrderList();
    })
    .catch(err => {
      console.error("작업지시 저장 오류:", err);
      alert("작업지시 저장 중 오류 발생");
    });
  });

  // 등록 버튼 → insert 모달
  document.getElementById("btn_insert").addEventListener("click", () => {
    openWorkOrderModal("insert");
  });

  // 그리드 더블클릭 → update 모달
  grid.on("dblclick", (ev) => {
    const rowData = grid.getRow(ev.rowKey);
    if (!rowData) return;
    openWorkOrderModal("update", rowData);
  });

  // 작업지시 목록 조회
  function fetchWorkOrderList() {
    fetch("/select_WORKORDER_list")
      .then(res => res.json())
      .then(data => {
        grid.resetData(data);
      })
      .catch(err => console.error("작업지시 조회 오류:", err));
  }

  // ---------------------------
  // 4) 필드 클릭 → 검색 모달
  // ---------------------------
  // 로트번호 필드 클릭
  lotCdInput.addEventListener("click", () => {
    openSearchModal("lot");
  });
  // 작업자 필드 클릭
  workorderJbInput.addEventListener("click", () => {
    openSearchModal("worker");
  });

  // ---------------------------
  // 검색 모달
  // ---------------------------
  const searchModalEl = document.getElementById("searchModal");
  const searchModal   = new bootstrap.Modal(searchModalEl, { backdrop: false });
  const searchInput   = document.getElementById("searchInput");
  const btnSearch     = document.getElementById("btnSearch");

  function openSearchModal(mode) {
    searchMode = mode;
    document.getElementById("searchModalTitle").textContent =
      (mode === "lot") ? "LOT 검색" : "작업자 검색";

    // 검색 그리드 생성
    const searchGridContainer = document.getElementById("searchGrid");
    searchGridContainer.innerHTML = "";
    searchGrid = new tui.Grid({
      el: searchGridContainer,
      columns: [],
      scrollX: false,
      scrollY: true,
      rowHeaders: ["checkbox"],
      autoResize: true
    });

    // 모드별 컬럼 & 데이터
    if (mode === "lot") {
      console.log(mode);
      searchGrid.setColumns([
        { header: "LOT번호",        name: "lot_cd",  align: "center" },
        { header: "공정코드",      name: "process_cd", align: "center" },
        { header: "생성일시",      name: "lot_cr", align: "center" },
        { header: "품목코드",    name: "product_cd", align: "center" },
        { header: "색상",          name: "product_cr", align: "center" },
        { header: "사이즈",         name: "product_sz", align: "center" },
        { header: "수량",          name: "lot_am", align: "center" }
      ]);
      fetchSearchList("/select_LOT_list", searchGrid);

      // 더블클릭 시 → LOT정보 & 작업일자(dailyproductplan_sd)
      searchGrid.on("dblclick", (ev) => {
        const rowData = searchGrid.getRow(ev.rowKey);
        if (!rowData) return;

        // LOT번호, 공정코드
        lotCdInput.value      = rowData.lot_cd || "";
        processCdInput.value  = rowData.process_cd || "";

        // LOT에서 dailyproductplan_sd를 직접 주지 않는다면,
        // base_product_cd + product_sz + product_cr => product_cd
        // 그 외 contract_cd 등 조건 → 일일생산계획 조회
        const combinedProductCd = rowData.base_product_cd + "-" +
                                  rowData.product_sz + "-" +
                                  rowData.product_cr;

        // 예: /select_DAILYPLAN_one?product_cd=xxx
        fetch(`/select_DAILYPLAN_one?product_cd=${encodeURIComponent(combinedProductCd)}`)
          .then(res => res.json())
          .then(planData => {
            // planData.dailyproductplan_sd = "2025-02-26"
            dailyplanSdInput.value = planData.dailyproductplan_sd || "";
          })
          .catch(err => console.error("일일생산계획 조회 오류:", err));

        // 검색 모달 닫기 + 작업지시 모달
        bootstrap.Modal.getInstance(searchModalEl).hide();
        workorderModal.show();
      });
    } else if (mode === "worker") {
      // 작업자 검색
      searchGrid.setColumns([
        { header: "사원번호",   name: "employee_cd",    align: "center" },
        { header: "작업자명",   name: "employee_nm",    align: "center" },
        { header: "부서",       name: "departmentName", align: "center" },
        { header: "직급",       name: "positionName",   align: "center" }
      ]);
      fetchSearchList("/select_WORKABLE_EMPLOYEE_list", searchGrid);

      // 더블클릭 시 → 작업자
      searchGrid.on("dblclick", (ev) => {
        const rowData = searchGrid.getRow(ev.rowKey);
        if (!rowData) return;

        // 작업자
        workorderJbInput.value = rowData.employee_cd || "";

        // 검색 모달 닫기 + 작업지시 모달
        bootstrap.Modal.getInstance(searchModalEl).hide();
        workorderModal.show();
      });
    }

    // 검색 모달 표시
    searchModal.show();
  }

  // 실제 검색 (ex: /select_LOT_list?searchValue=xxx)
  function fetchSearchList(apiUrl, grid) {
    // 만약 검색어 사용 시:
    // const val = searchInput.value.trim();
    // if (val) apiUrl += "?searchValue=" + encodeURIComponent(val);

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        grid.resetData(data);
      })
      .catch(err => console.error("검색 오류:", err));
  }

  // -----------------------------------------
  // 초기 조회
  fetchWorkOrderList();
});
</script>
</body>
</html>
