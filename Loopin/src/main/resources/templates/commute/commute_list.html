<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
				layout:decorate="~{layout}" 
				layout:fragment="content">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<body>
	<main id="main" class="main">
	<div class="pagetitle">
	
		<!-- Page Title -->
			<h1>출퇴근 기록부</h1>
		<!-- Start Page Title -->
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/log">TEST</a></li>
					<li class="breadcrumb-item">test1</li>
					<li class="breadcrumb-item active">test2</li>
				</ol>
			</nav>
		</div>
		<!-- End Page Title -->



		<section class="section">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
						<div class="card-body ">
							<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
								<li class="nav-item" role="presentation">
									<button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home"
										type="button" role="tab" aria-controls="pills-home" aria-selected="true">달력</button>
								</li>
								<li class="nav-item" role="presentation">
									<button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile"
										type="button" role="tab" aria-controls="pills-profile" aria-selected="false" onclick="grid_function()">그리드</button>
								</li>
							</ul>
							<div class="tab-content pt-2" id="myTabContent"> 
								<!-- 달력 -->
								<div class="text-center" id='btn_calendar'>
									<button type='button' class='btn btn-outline-secondary' id='btn_calendar_prev'>이전</button>
									<span></span>
									<button type='button' class='btn btn-outline-secondary' id='btn_calendar_next'>다음</button>
								</div>
								<div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="home-tab" style="height: 600px;">
								</div>
								
								<!-- 그리드 -->
								<div style="display: none;">
									<div class="d-flex align-items-center justify-content-between">
										<h5 class="card-title">코드 분류</h5>
										<div>
											<input type="button" id="btn_group_remove" class="btn btn-primary" value="삭제">
											<input type="button" id="btn_group_add" class="btn btn-primary" value="행추가">
											<input type="button" id="btn_group_insert" class="btn btn-primary" value="등록">
										</div>
									</div>
									<!-- 대분류 그리드 -->
									<div id="group_grid"></div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</section>
	</main>
</body>
<script th:inline="javascript">
	// 변수 지정
	let group_grid;
	let grid;
	let select_group_code;
	
	const btn_group_remove = $('#btn_group_remove');
	const btn_group_add = $('#btn_group_add');
	const btn_group_insert = $('#btn_group_insert');
	const token = $("meta[name='_csrf']").attr("content")
	const header = $("meta[name='_csrf_header']").attr("content");
	
	const calendar_container = document.getElementById('pills-home');
	const grid_container = document.getElementById('pills-profile');
	const btn_calendar = document.getElementById('btn_calendar');
	const btn_grid_filter = document.getElementById('btn_grid_filter');
	const btn_calendar_prev = document.getElementById('btn_calendar_prev');
	const btn_calendar_next = document.getElementById('btn_calendar_next');
	const tab = document.getElementById('pills-home-tab');
	
	
	// ------------------------------
	
	$(function() {
		
		make_calendar();
		
		
		// 코드분류 그리드 ----------------------
		group_grid.on('click', function(ev) {
		    let rowdata = group_grid.getRow(ev.rowKey);
			
			if(!rowdata || rowdata['COMMON_CC'] == '') {
				return;
			}
			
		});
		
		// 행 추가
		btn_group_add.on('click', function() {
			group_grid.appendRow({
			        "COMMON_CC": '',
			        "COMMON_NM": '',
			        "COMMON_US": '',
			    },
			    {focus: true}
			);
		});
		
		// 행 등록
		btn_group_insert.on('click', function(ev) {
			const modifiedData = group_grid.getModifiedRows();
			const createdRows = modifiedData.createdRows;
			const updatedRows = modifiedData.updatedRows;
			const json = {
				createdRows: createdRows,
				updatedRows: updatedRows
			}

			const jsonData = JSON.stringify(json);
			
			$.ajax({
				type: 'post',
				url: '/insert_group_code',
				data: jsonData,
				contentType: 'application/json',
				beforeSend : function(xhr) {
				    xhr.setRequestHeader(header, token);
				},
				success: function(data) {
					let row = data.data.contents;
					console.log(row);
					group_grid.focus(-1);
					group_grid.uncheckAll();
					group_grid.resetData(row);
				},
				error : function(xhr, textStatus, errorThrown) {
					console.log('조회 실패');
				}
			});

		});
		
		// 행 데이터 삭제
		btn_group_remove.on('click', function() {
			let rows = group_grid.getCheckedRows();
			
			
			if (rows.length == 0) {
			    alert('삭제할 항목을 선택하세요.');
			    return;
			}
			
			if (!confirm('선택한 항목을 삭제하시겠습니까?')) {
			    return;
			}
			

			
			if(group_grid.removeCheckedRows()) {
				const jsonData = JSON.stringify(rows);
				$.ajax({
					type: 'post',
					url: '/delete_group_code',
					data: jsonData,
					contentType: 'application/json',
					beforeSend : function(xhr) {
					    xhr.setRequestHeader(header, token);
					},
					success: function(data) {
					},
					error : function(xhr, textStatus, errorThrown) {
						console.log('조회 실패');
					}
				});
			}
			
		});

		

	});
	

	// ----------- 초기화 -------------

	
	
	
	// 함수 영역 -------------------
	
	
	function make_calendar(){ 
		
		// 캘린더 초기세팅
		let options = {  
			defaultView: 'month',
			useDetailPopup: true,
			isReadOnly: true,
			calendars: [
				{
					id: 'cal1',
					name: '총결원',
					backgroundColor: '#03bd9e',
				},
				{
					id: 'cal2',
					name: '휴가자',
					backgroundColor: '#ffffff',
					borderLeft: '#ffffff',
				},
				{
					id: 'cal3',
					name: '출장',
					backgroundColor: '#ffffff',
				},
			],

		};

		let calendar = new tui.Calendar(calendar_container, options);
		
		calendar.on('clickDayname', function(event) {
		    const clickedDate = event.date; // 클릭된 날짜 정보
		    console.log('클릭된 날짜:', clickedDate);

		    // 모달 열기 및 날짜 정보 전달
		    openModal(clickedDate);
		});
		
		
		// 각 이벤트 만들어주는 메서드
		calendar.createEvents([
			{
				id: 'event1',
				calendarId: 'cal1',
				title: '10/1',
				start: '2025-01-01',
				end: '2025-01-01',
				isAllday: true,  // allday 타임스탬프 노상관
				category: 'allday',
			}, 
			{
				id: 'event2',
				calendarId: 'cal2',
				title: '김길동',
				start: '2025-01-01T09:36:50',
				end: '2025-01-01T09:36:37',
				isAllday: true,
				category: 'allday',
			},
			{
				id: 'event3',
				calendarId: 'cal3',
				title: '홍길동',
				start: '2025-01-01T09:36:50',
				end: '2025-01-01T09:36:37',
				isAllday: true,
				category: 'allday',
			},
		]);
		
		
		calendar.setOptions({
			
			// 해당 달만 보여주기
			month: {
				isAlways6Weeks: false, 
			},
			
		});
		
		calendar.setTheme({
			
			// 주말 css
			month: {
					weekend: {
						backgroundColor: 'rgba(255, 64, 64, 0.1)',
					},
			},
		});
		
		
		// Date 객체 문자열 형식으로 변환
		const originalDate = calendar.getDate(); 
		const year = originalDate.getFullYear();
		const month = originalDate.getMonth() + 1;
		const formattedDate = `${year}년 ${month}월`;
		$("#btn_calendar span").text(formattedDate);
		
		
		// 이전 달 보기 이벤트
		btn_calendar_prev.addEventListener('click', function(){ 
			
			calendar.prev();
			
			const originalDate = calendar.getDate(); 
			const year = originalDate.getFullYear();
			const month = originalDate.getMonth() + 1;
			const formattedDate = `${year}년 ${month}월`;
			$("#btn_calendar span").text(formattedDate);
		
		});
		
		
		// 다음 달 보기 이벤트
		btn_calendar_next.addEventListener('click', function(){ 
			
			calendar.next();

			const originalDate = calendar.getDate(); 
			const year = originalDate.getFullYear();
			const month = originalDate.getMonth() + 1;
			const formattedDate = `${year}년 ${month}월`;
			$("#btn_calendar span").text(formattedDate);
			
			
		});

	};
	

	function openModal(date) {
		// 모달 ID
		const modalId = 'modal';
		let modalElement = document.getElementById(modalId);

		// 기존 모달이 없으면 새로 생성
		if (!modalElement) {
			const modalHtml = 
			`<div class="modal fade" id="${modalId}" tabindex="-1">
               <div class="modal-dialog modal-dialog-centered modal-xl">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">${rowData.workdate}(귀속년월) 명세서</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                       </div>
                       <div class="modal-body">
                           <div id="gridOnespe"></div>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                           <button type="button" class="btn btn-primary">Save changes</button>
                       </div>
                   </div>
               </div>
           </div>`;
			document.body.insertAdjacentHTML('beforeend', modalHtml); // Modal 동적 추가
			modalElement = document.getElementById(modalId); // 새로 추가된 모달 참조
		}

		// 모달이 열리고 나서 그리드를 초기화
        const modal = new bootstrap.Modal(modalElement);  // 모달 초기화
        modalElement.addEventListener('shown.bs.modal', function () {

        });
		
		// 모달이 닫힐 때 DOM에서 제거
		modalElement.addEventListener('hidden.bs.modal', function () {
			modalElement.remove();
			console.log('모달이 닫히고 삭제되었습니다.');
		});
		
		modal.show();
	}
	
	function make_group_grid(gridData) {
		const dataSource = {
				  api: {
					    readData: {url: '/test222', method: 'GET' },
					    createData: {url: '/insert_group_code', method: 'POST' },
					    updateData: {url: '/update_group_code', method: 'POST' },
					    modifyData: {url: '/modify_group_code', method: 'POST' },
						deleteData: {url: '/delete_group_code', method: 'POST' }
				  	}
				}
		
		group_grid = new tui.Grid({
			el : document.getElementById('group_grid'),
/* 			data : {
				api : {
					readData : {
						url : '/test222',
						method : 'get',
						// initParams:{ code : ''}
					},
				}
			}, */
			data : dataSource,
			scrollX : false,
			scrollY : false,
			rowHeaders : [ // 헤더 추가
				{type : 'rowNum',}, 
				{type : 'checkbox',}, 
			],
			selectionUnit : 'row', // 행 선택
			bodyHeight : 600,
			columns : [ 
				{header : '코드명', name : 'COMMON_GC', hidden: true},
				{header : '코드명', name : 'COMMON_CC', sortable : true, editor: 'text', 
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				},
				{header : '항목명', name : 'COMMON_NM', sortable : true, editor: 'text', 
					filter: {
						type: 'select',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '설명', name : 'COMMON_CT', sortable : true, editor: 'text', 
					filter: {
						type: 'text',
						showApplyBtn: true,
						showClearBrn: true 
					}
				}, 
				{header : '사용여부', name : 'COMMON_US', hidden: true }
			]
		});
		
	}


</script>
</html>