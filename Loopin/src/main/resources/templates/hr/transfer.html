<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">

<body>

	<main id="main" class="main">

		<!-- End Page Title -->

		<section class="section">
			<div class="row">
				<div class="col-lg-12">

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">인사발령 조회</h5>

							<!-- General Form Elements -->

							<div class="col-lg-12" id="grid" style="margin-top: 20px;"></div>
							<br>



							<div
								th:if="${#authentication.principal.employee_rl == 'admin' or #authentication.principal.employee_rl == 'developer'}">
								<button type="button" class="btn btn-primary" data-bs-toggle="modal"
									data-bs-target="#modal_appointment_save">신규</button>
								<button type="button" id="btn_transfer_delete" class="btn btn-primary">삭제</button>
							</div>


							<!-- End General Form Elements -->

						</div>
					</div>

				</div>


			</div>
		</section>

	</main>
	<!-- End #main -->

	<!-- Bootstrap Modal -->
	<div class="modal fade" id="modal_appointment_save" tabindex="-1" aria-labelledby="modal_appointment_save_label"
		data-mode="insert" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_appointment_save_label">인사발령</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="modal_appointment_save_form" th:action="@{/insert_TRANSFER}" method="post">
						<div class="col">
							<label for="employee_nm" class="form-label">이름</label>
							<div class="input-group">
								<input type="text" id="employee_nm" class="form-control" readonly required>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="employee_cd" class="form-label">사원코드</label>
								<div class="input-group">
									<input type="text" id="employee_cd" class="form-control" readonly required>
								</div>
							</div>
							<div class="col">
								<label for="transfer_mg" class="form-label">부서구분</label> <select id="transfer_mg"
									class="form-select">
									<option value="" disabled selected>부서구분을 선택하세요</option>
									<option th:each="dptype : ${DPType_list}" th:value="${dptype.common_nm}"
										th:text="${dptype.common_nm == 'true' ? '부서장' : '부서직원'}">
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_ad" class="form-label">발령일</label> <input type="text"
									id="transfer_ad" class="form-control" placeholder="YYYY-MM-DD" required>
							</div>
							<div class="col-sm-2">
								<div id="wrapper"></div>
							</div>
							<div class="col">
								<label for="transfer_ac" class="form-label">발령구분</label> <select id="transfer_ac"
									class="form-select">
									<option value="" disabled selected>발령구분을 선택하세요</option>
									<option th:each="trtype : ${TRType_list}" th:value="${trtype.common_cc}"
										th:text="${trtype.common_nm}">
									</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_og" class="form-label">기존직위</label> <select id="transfer_og"
									class="form-select">
									<option value="" disabled selected>직위를 선택하세요</option>
									<option th:each="grade : ${grade_list}" th:value="${grade.common_cc}"
										th:text="${grade.common_nm}">
									</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_ag" class="form-label">발령직위</label> <select id="transfer_ag"
									class="form-select">
									<option value="" disabled selected>직위를 선택하세요</option>
									<option th:each="grade : ${grade_list}" th:value="${grade.common_cc}"
										th:text="${grade.common_nm}">
									</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_od" class="form-label">기존부서</label> <select id="transfer_od"
									class="form-select">
									<option value="" disabled selected>부서를 선택하세요</option>
									<option th:each="dept : ${dept_list}" th:value="${dept.common_cc}"
										th:text="${dept.common_nm}">
									</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_adp" class="form-label">발령부서</label> <select id="transfer_adp"
									class="form-select">
									<option value="" disabled selected>부서를 선택하세요</option>
									<option th:each="dept : ${dept_list}" th:value="${dept.common_cc}"
										th:text="${dept.common_nm}">
									</option>
								</select>
							</div>
						</div>
						<div class="modal-footer d-flex justify-content-between">
							<button type="button" class="btn btn-secondary" id="btn_modal_reset">초기화</button>
							<div>
								<button type="submit" class="btn btn-primary">저장</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade" id="modal_employee_list" tabindex="-1" aria-labelledby="modal_employee_list_label"
		aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_employee_list_label">사원 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<table id="empTable" class="table table-striped">
						<thead>
							<tr>
								<th>사원코드</th>
								<th>이름</th>
								<th>부서</th>
								<th>직위</th>
								<th>선택</th>
							</tr>
						</thead>
						<tbody>
							<!-- 여기에 사원 정보를 동적으로 추가 -->

						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	</div>


</body>
<script th:inline="javascript">

	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	// 	const transferData = /*[[${transferList}]]*/[];
	// 	console.log(transferData);


	document.addEventListener('DOMContentLoaded', function () {

		fetch('/select_TRANSFER', {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('네트워크 응답이 실패했습니다.');
				}
				return response.json();
			})
			.then(transferData => {
				console.log('서버 응답 데이터:', transferData);

				// Grid 초기화
				grid = new tui.Grid({
					el: document.getElementById('grid'),
					data: transferData.map(row => ({
						transfer_id: row.transfer_id,
						employee_nm: row.employee_nm,
						employee_cd: row.employee_cd,
						transfer_ad: row.transfer_ad,
						transfer_ac: row.transfer_ac,
						transfer_og: row.transfer_og,
						transfer_ag: row.transfer_ag,
						transfer_od: row.transfer_od,
						transfer_adp: row.transfer_adp,
						transfer_aw: row.transfer_aw,
						transfer_mg: row.transfer_mg
					})),
					columns: [
						{header: '이름', name: 'employee_nm', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
						{header: '사원코드', name: 'employee_cd', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
						{header: '인사발령일', name: 'transfer_ad', align: 'center', filter: {type: 'date', showApplyBtn: true}, sortable: true},
						{header: '발령구분', name: 'transfer_ac', align: 'center', filter: {type: 'select'}, sortable: true},
						{header: '기존직위', name: 'transfer_og', align: 'center', filter: {type: 'select'}, sortable: true},
						{header: '변경직위', name: 'transfer_ag', align: 'center', filter: {type: 'select'}, sortable: true},
						{header: '기존부서', name: 'transfer_od', align: 'center', filter: {type: 'select'}, sortable: true},
						{header: '발령부서', name: 'transfer_adp', align: 'center', filter: {type: 'select'}, sortable: true},
						{header: '발령현황', name: 'transfer_aw', align: 'center', filter: {type: 'select'}, sortable: true}
					],
					rowHeaders: ['checkbox'],
					autoWidth: true,
					rowHeight: 'auto',
					bodyHeight: 'auto',
					scrollX: true,
					scrollY: true
				});

				// Grid 클릭 이벤트 등록
				grid.on('click', (ev) => {
					const columnName = ev.columnName; // 클릭된 열 이름
					const rowKey = ev.rowKey; // 클릭된 행의 키
					const rowData = grid.getRow(rowKey); // 클릭된 행 데이터

					// 헤더 클릭 무시
					if (rowKey === null || rowKey === undefined) {
						console.warn("헤더 클릭은 무시됩니다.");
						return;
					}

					// employee_nm 열 클릭 시 모달 열기
					if (columnName === 'employee_nm') {
						console.log("모달에 표시할 데이터:", rowData);
						console.log(document.getElementById('employee_nm')); // null이면 렌더링 문제
						console.log(document.getElementById('employee_cd'));
						openEditModal(rowData);
					}

				});


				// 모달 열기 함수
				function openEditModal(rowData) {
					console.log("수정 모달 열기 데이터:", rowData);

					const modal = document.getElementById('modal_appointment_save');
					modal.setAttribute('data-mode', 'update'); // 수정 모드 설정

					// Select 필드 처리 (공통코드 매칭 포함)
					const selectFields = ['transfer_ac', 'transfer_og', 'transfer_ag', 'transfer_od', 'transfer_adp', 'transfer_mg'];
					selectFields.forEach(field => {
						const $select = $(`#${field}`);
						if ($select.length) {
							const textToMatch = rowData[field]; // 예: "승진", true, false
							const matchingOption = $select.find('option').filter((_, option) => {
								return $(option).val() === String(textToMatch); // 옵션 value와 매칭
							});

							if (matchingOption.length) {
								$select.val(matchingOption.val()).prop('selected', true); // 매칭된 value 선택
							} else {
								console.warn(`'${field}'에 '${textToMatch}' 값이 존재하지 않습니다.`);
							}
						}
					});

					// 일반 입력 필드 처리
					Object.keys(rowData).forEach(key => {
						const $field = $(`#${key}`);
						if ($field.length && $field.is('input, textarea')) {
							$field.val(rowData[key] || '');
						}
					});

					// 모달 열기
					$('#modal_appointment_save').modal('show');
				}





			})
			.catch(error => {
				console.error('오류 발생:', error);
			});

		// 삭제 버튼 클릭 이벤트
		document.querySelector('#btn_transfer_delete').addEventListener('click', function () {
			if (!grid) {
				alert('Grid가 초기화되지 않았습니다.');
				return;
			}

			// 체크된 행 데이터 가져오기
			const checkedRows = grid.getCheckedRows();
			console.log('체크된 행 데이터:', checkedRows);

			if (checkedRows.length === 0) {
				alert('삭제할 데이터를 선택하세요.');
				return;
			}

			// transfer_id만 추출
			const idsToDelete = checkedRows.map(row => row.transfer_id); // rows_id_delete
			// 로그로 확인
			console.log('삭제할 ID 리스트:', idsToDelete);

			if (!confirm('선택한 데이터를 삭제하시겠습니까?')) {
				return;
			}

			// AJAX 요청으로 삭제
			fetch('/delete_TRANSFER', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					// CSRF 토큰 추가
					[csrfHeader]: csrfToken
				},
				// 삭제할 ID 배열 전달
				body: JSON.stringify({ids: idsToDelete})
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('삭제 요청 실패');
					}
					return response.json();
				})
				.then(data => {
					if (data.success) {
						alert('삭제가 완료되었습니다.');
						// 페이지 새로고침
						location.reload();
					} else {
						alert('삭제에 실패했습니다: ' + data.message);
					}
				})
				.catch(error => {
					console.error('오류 발생:', error);
					alert('삭제 중 오류가 발생했습니다.');
				});
		});

		// TOAST UI Date Picker
		// 모달 열릴 때 Date Picker 초기화
		document.getElementById('modal_appointment_save').addEventListener('shown.bs.modal', function () {
			// Date Picker 초기화
			new tui.DatePicker('#wrapper', {
				input: {
					element: '#transfer_ad',
					format: 'yyyy-MM-dd'
				},
				// 오늘 날짜
				date: new Date()
			});
		});
	});

	// 폼 데이터를 초기화
	document.getElementById('btn_modal_reset').addEventListener('click', function () {
		const modalForm = document.getElementById('modal_appointment_save_form');
		modalForm.reset();
	});

	// 모달이 닫힐 때 폼 데이터 초기화
	document.getElementById('modal_appointment_save').addEventListener('hidden.bs.modal', function () {
		const modalForm = document.getElementById('modal_appointment_save_form');
		modalForm.reset();
	});

	// 이름 또는 사원코드 클릭 시 사원 선택 모달 열기
	document.getElementById('employee_nm').addEventListener('click', function () {
		const modal_employee_list = new bootstrap.Modal(document.getElementById('modal_employee_list'));
		modal_employee_list.show();

		// 서버에서 사원 정보를 가져오는 요청
		fetch('/select_EMPLOYEE_COMMON', {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json',
			},
		})
			.then((response) => {
				if (!response.ok) {
					throw new Error('서버 응답 오류');
				}
				return response.json();
			})
			.then((data) => {
				// 데이터 가져온 후 테이블 갱신
				const tbody = document.querySelector('#empTable tbody');
				tbody.innerHTML = ''; // 기존 내용 초기화

				// 데이터를 테이블에 동적으로 추가
				data.forEach((employee) => {
					const row = document.createElement('tr');
					row.innerHTML = `
                    <td>${employee.employee_cd}</td>
                    <td>${employee.employee_nm}</td>
                    <td>${employee.department_name}</td>
                    <td>${employee.position_name}</td>
                    <td><button type="button" class="btn btn-primary select-emp-btn">선택</button></td>
                `;
					tbody.appendChild(row);
				});
			})
			.catch((error) => console.error('사원 목록 가져오기 실패:', error));
	});


	document.addEventListener('click', function (event) {
		// 선택 버튼(`select-emp-btn`) 클릭 처리
		if (event.target.classList.contains('select-emp-btn')) {
			const selectedRow = event.target.closest('tr');

			const employee_cd = selectedRow.cells[0].textContent;
			const employee_nm = selectedRow.cells[1].textContent;
			const employee_dept = selectedRow.cells[2].textContent;
			const employee_position = selectedRow.cells[3].textContent;

			document.getElementById('employee_cd').value = employee_cd;
			document.getElementById('employee_nm').value = employee_nm;

			const transfer_od = document.getElementById('transfer_od');
			const transfer_og = document.getElementById('transfer_og');

			Array.from(transfer_od.options).forEach(option => {
				if (option.textContent === employee_dept) {
					option.selected = true;
				}
			});

			Array.from(transfer_og.options).forEach(option => {
				if (option.textContent === employee_position) {
					option.selected = true;
				}
			});

			const modal_employee_list = bootstrap.Modal.getInstance(document.getElementById('modal_employee_list'));
			modal_employee_list.hide();
		}
	});




	document.getElementById('modal_appointment_save').addEventListener('submit', function (event) {
		event.preventDefault(); // 폼 기본 동작 방지

		const mode = document.getElementById('modal_appointment_save').getAttribute('data-mode');

		// 모달 입력값 가져오기
		const transferData = {
			employee_cd: document.getElementById('employee_cd').value,
			transfer_ad: document.getElementById('transfer_ad').value,
			transfer_ac: document.getElementById('transfer_ac').value,
			transfer_og: document.getElementById('transfer_og').value,
			transfer_ag: document.getElementById('transfer_ag').value,
			transfer_od: document.getElementById('transfer_od').value,
			transfer_adp: document.getElementById('transfer_adp').value,
			transfer_mg: document.getElementById('transfer_mg').value
		};

		if (transferData.transfer_mg !== "true") {
			// 부서장이 아닌 경우 바로 저장/수정
			if (mode === 'insert') {
				saveTransfer(transferData);
			} else if (mode === 'update') {
				updateTransfer(transferData);
			}
			return;
		}

		// 부서장이 선택된 경우 부서장 체크 로직 호출
		checkDepartmentManager(transferData, mode);
	});

	// 공통 부서장 체크 로직
	function checkDepartmentManager(transferData, mode) {
		fetch('/select_department_manager', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRF-TOKEN': csrfToken,
			},
			body: JSON.stringify({
				transfer_adp: transferData.transfer_adp, // 발령 부서
			}),
		})
			.then(response => response.json())
			.then(managerCheck => {
				console.log("부서장 정보@@@ : " + managerCheck.managerInfo);
				console.log("부서장 tf@@@ : " + managerCheck.manager_exists);
				if (managerCheck.manager_exists) {
					// 부서장이 존재하는 경우 사용자에게 확인 요청
					const managerInfo = managerCheck.manager_info; // 서버에서 전달된 부서장 정보
					const confirmProceed = confirm(
						`해당 부서(${managerInfo.department_name})에는 이미 부서장(${managerInfo.employee_nm})이 존재합니다.\n계속 진행하시겠습니까?`
					);

					if (!confirmProceed) {
						return; // 사용자가 진행하지 않으면 종료
					}
				}

				// 부서장이 없거나 부서장이 존재하지만 사용자가 진행을 선택한 경우
				if (mode === 'insert') {
					saveTransfer(transferData);
				} else if (mode === 'update') {
					updateTransfer(transferData);
				}
			})
			.catch(error => {
				console.error('부서장 체크 중 오류 발생:', error);
				alert('부서장 확인 중 오류가 발생했습니다.');
			});
	}

	// 발령 데이터를 저장하는 함수
	function saveTransfer(transferData) {
		fetch('/insert_TRANSFER', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRF-TOKEN': csrfToken,
			},
			body: JSON.stringify(transferData),
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('등록 요청 실패');
				}
				return response.json();
			})
			.then(data => {
				alert(data.message);
				location.reload();
			})
			.catch(error => {
				console.error('등록 중 오류 발생:', error);
				alert('등록 중 문제가 발생했습니다.');
			});
	}

	// 업데이트 요청 처리 함수
	function updateTransfer(transferData) {
		fetch('/update_TRANSFER', {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRF-TOKEN': csrfToken
			},
			body: JSON.stringify(transferData)
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('업데이트 요청 실패');
				}
				return response.json();
			})
			.then(data => {
				alert('수정이 완료되었습니다.');
				location.reload();
			})
			.catch(error => {
				console.error('업데이트 중 오류 발생:', error);
				alert('업데이트 중 문제가 발생했습니다.');
			});
	}




</script>

</html>