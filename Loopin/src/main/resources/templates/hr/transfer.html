<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">

<body>

	<main id="main" class="main">

		<div class="pagetitle">
			<h1>인사발령</h1>
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="index.html">Home</a></li>
					<li class="breadcrumb-item">인사관리</li>
					<li class="breadcrumb-item active">인사발령</li>
				</ol>
			</nav>
		</div>
		<!-- End Page Title -->

		<section class="section">
			<div class="row">
				<div class="col-lg-12">

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">인사발령 조회</h5>

							<!-- General Form Elements -->

							<div id="grid" style="margin-top: 20px;"></div> <br>

							<button type="button" class="btn btn-primary" data-bs-toggle="modal"
								data-bs-target="#modal_appointment_save">신규</button>
							<button type="button" class="btn btn-primary">삭제</button>

							<!-- End General Form Elements -->

						</div>
					</div>

				</div>


			</div>
		</section>

	</main>
	<!-- End #main -->

	<!-- Bootstrap Modal -->
	<div class="modal fade" id="modal_appointment_save" tabindex="-1" aria-labelledby="modal_appointment_save_label"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_appointment_save_label">인사발령</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="modal_appointment_save" th:action="@{/insert_TRANSFER}" method="post">
						<div class="row mb-3">
							<div class="col">
								<label for="employee_nm" class="form-label">이름</label>
								<div class="input-group">
									<input type="text" id="employee_nm" class="form-control" readonly required>
								</div>
							</div>
							<div class="col">
								<label for="employee_cd" class="form-label">사원코드</label>
								<div class="input-group">
									<input type="text" id="employee_cd" class="form-control" readonly required>
								</div>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_ad" class="form-label">발령일</label>
								<input type="text" id="transfer_ad" class="form-control" placeholder="YYYY-MM-DD"
									required>
							</div>
							<div class="col">
								<label for="transfer_ac" class="form-label">발령구분</label>
								<select id="transfer_ac" class="form-select">
									<option value="승진">승진</option>
									<option value="전근">전근</option>
									<option value="복직">복직</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_og" class="form-label">기존직위</label>
								<select id="transfer_og" class="form-select">
									<option value="사원">사원</option>
									<option value="대리">대리</option>
									<option value="과장">과장</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_ag" class="form-label">발령직위</label>
								<select id="transfer_ag" class="form-select">
									<option value="사원">사원</option>
									<option value="대리">대리</option>
									<option value="과장">과장</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_od" class="form-label">기존부서</label>
								<select id="transfer_od" class="form-select">
									<option value="영업부">영업부</option>
									<option value="개발부">개발부</option>
									<option value="기획부">기획부</option>
									<option value="인사부">인사부</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_adp" class="form-label">발령부서</label>
								<select id="transfer_adp" class="form-select">
									<option value="영업부">영업부</option>
									<option value="개발부">개발부</option>
									<option value="기획부">기획부</option>
									<option value="인사부">인사부</option>
								</select>
							</div>
						</div>
						<button type="submit" class="btn btn-primary">저장</button>
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modal_employee_list" tabindex="-1" aria-labelledby="modal_employee_list_label"
		aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_employee_list_label">사원 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<table id="empTable" class="table table-striped">
						<thead>
							<tr>
								<th>사원코드</th>
								<th>이름</th>
								<th>부서</th>
								<th>직위</th>
								<th>선택</th>
							</tr>
						</thead>
						<tbody>
							<!-- 여기에 사원 정보를 동적으로 추가 -->
							<tr>
								<td>EMP001</td>
								<td>홍길동</td>
								<td>영업부</td>
								<td>대리</td>
								<td><button class="btn btn-primary select-emp-btn">선택</button></td>
							</tr>
							<tr>
								<td>EMP002</td>
								<td>김철수</td>
								<td>개발부</td>
								<td>과장</td>
								<td><button class="btn btn-primary select-emp-btn">선택</button></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	</div>


</body>
<script th:inline="javascript">

	const transferData = /*[[${transferList}]]*/[];
	console.log(transferData);
	// Grid initiation
	const grid = new tui.Grid({
		el: document.getElementById('grid'),
		data: transferData,
		columns: [
			{header: '이름', name: 'employee_nm', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
			{header: '사원코드', name: 'employee_cd', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
			{header: '인사발령일', name: 'transfer_ad', align: 'center', filter: {type: 'date', showApplyBtn: true}, sortable: true},
			{header: '발령구분', name: 'transfer_ac', align: 'center', filter: {type: 'select', options: ['승진', '전근', '복직']}, sortable: true},
			{header: '기존직위', name: 'transfer_og', align: 'center', filter: {type: 'select', options: ['사원', '대리', '과장']}, sortable: true},
			{header: '변경직위', name: 'transfer_ag', align: 'center', filter: {type: 'select', options: ['사원', '대리', '과장']}, sortable: true},
			{header: '기존부서', name: 'transfer_od', align: 'center', filter: {type: 'select', options: ['영업부', '개발부', '기획부', '인사부']}, sortable: true},
			{header: '발령부서', name: 'transfer_adp', align: 'center', filter: {type: 'select', options: ['영업부', '개발부', '기획부', '인사부']}, sortable: true}
		],
		rowHeaders: ['checkbox'],
		autoWidth: true,
		rowHeight: 'auto',
		bodyHeight: 'auto',
		scrollX: true,
		scrollY: true
	});

	// TOAST UI Date Picker
	document.addEventListener('DOMContentLoaded', function () {
		// 모달 열릴 때 Date Picker 초기화
		document.getElementById('modal_appointment_save').addEventListener('shown.bs.modal', function () {
			// Date Picker 초기화
			new tui.DatePicker('#transfer_ad', {
				language: 'ko', // 한국어 설정
				input: {
					element: '#transfer_ad', // 발령일 필드 ID
					format: 'yyyy-MM-dd' // 날짜 포맷
				},
				date: new Date() // 초기값 설정 (오늘 날짜)
			});
		});
	});


	// 이름 또는 사원코드 클릭 시 사원 선택 모달 열기
	document.getElementById('employee_nm').addEventListener('click', function () {
		const selectEmpModal = new bootstrap.Modal(document.getElementById('modal_employee_list'));
		selectEmpModal.show();
	});

	document.getElementById('employee_cd').addEventListener('click', function () {
		const selectEmpModal = new bootstrap.Modal(document.getElementById('modal_employee_list'));
		selectEmpModal.show();
	});

	// 선택 버튼 클릭 이벤트 처리
	document.addEventListener('click', function (event) {
		// 선택 버튼(`select-emp-btn`)이 클릭되었는지 확인
		if (event.target.classList.contains('select-emp-btn')) {
			// 클릭된 버튼이 속한 행(`tr`)을 가져옴
			const selectedRow = event.target.closest('tr');

			// 행의 각 열(`td`)에서 데이터를 가져옴
			const empCode = selectedRow.cells[0].textContent; // 사원코드
			const name = selectedRow.cells[1].textContent;    // 이름

			// 기존 모달의 필드에 값 설정
			document.getElementById('employee_cd').value = empCode;
			document.getElementById('employee_nm').value = name;

			// 사원 선택 모달 닫기
			const selectEmpModal = bootstrap.Modal.getInstance(document.getElementById('modal_employee_list'));
			selectEmpModal.hide();
		}
	});

	// 모달 저장 버튼 클릭 시 이벤트 처리
	document.getElementById('modal_appointment_save').addEventListener('submit', function (event) {
		event.preventDefault(); // 폼 기본 동작 방지

		const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

		// 모달 입력값 가져오기
		const employee_cd = document.getElementById('employee_cd').value;
		const transfer_ad = document.getElementById('transfer_ad').value;
		const transfer_ac = document.getElementById('transfer_ac').value;
		const transfer_og = document.getElementById('transfer_og').value;
		const transfer_ag = document.getElementById('transfer_ag').value;
		const transfer_od = document.getElementById('transfer_od').value;
		const transfer_adp = document.getElementById('transfer_adp').value;

		// AJAX 요청
		fetch('/insert_TRANSFER', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRF-TOKEN': csrfToken,
			},
			body: JSON.stringify({
				employee_cd: employee_cd,
				transfer_ad: transfer_ad,
				transfer_ac: transfer_ac,
				transfer_og: transfer_og,
				transfer_ag: transfer_ag,
				transfer_od: transfer_od,
				transfer_adp: transfer_adp,
			}),
		})
			.then(response => response.json()) // JSON 응답 처리
			.then(data => {
				alert(data.message); // 서버 응답 메시지 표시
				location.reload(); // 페이지 새로고침
			})
			.catch(error => {
				console.error('오류 발생:', error);
			});
	});

</script>

</html>