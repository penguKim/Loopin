<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}" layout:fragment="content">

<body>

	<main id="main" class="main">

		<!-- End Page Title -->

		<section class="section">
			<div class="row">
				<div class="col-lg-12">

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">인사발령 조회</h5>

							<!-- General Form Elements -->

							<div class="col-lg-12" id="grid" style="margin-top: 20px;"></div>
							<br>

							<button type="button" class="btn btn-primary"
								data-bs-toggle="modal" data-bs-target="#modal_appointment_save">신규</button>
							<button type="button" id="btn_transfer_delete"
								class="btn btn-primary">삭제</button>

							<!-- End General Form Elements -->

						</div>
					</div>

				</div>


			</div>
		</section>

	</main>
	<!-- End #main -->

	<!-- Bootstrap Modal -->
	<div class="modal fade" id="modal_appointment_save" tabindex="-1"
		aria-labelledby="modal_appointment_save_label" aria-hidden="true"
		data-bs-backdrop="static" data-bs-keyboard="false">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_appointment_save_label">인사발령</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="modal_appointment_save_form"
						th:action="@{/insert_TRANSFER}" method="post">
						<div class="row mb-3">
							<div class="col">
								<label for="employee_nm" class="form-label">이름</label>
								<div class="input-group">
									<input type="text" id="employee_nm" class="form-control"
										readonly required>
								</div>
							</div>
							<div class="col">
								<label for="employee_cd" class="form-label">사원코드</label>
								<div class="input-group">
									<input type="text" id="employee_cd" class="form-control"
										readonly required>
								</div>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_ad" class="form-label">발령일</label> <input
									type="text" id="transfer_ad" class="form-control"
									placeholder="YYYY-MM-DD" required>
							</div>
							<div class="col-sm-2">
								<div id="wrapper"></div>
							</div>
							<div class="col">
								<label for="transfer_ac" class="form-label">발령구분</label> <select
									id="transfer_ac" class="form-select">
									<option value="승진">승진</option>
									<option value="전근">전근</option>
									<option value="복직">복직</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_og" class="form-label">기존직위</label> <select
									id="transfer_og" class="form-select">
									<option value="" disabled selected>직위를 선택하세요</option>
									<option th:each="grade : ${grade_list}"
										th:value="${grade.common_cc}" th:text="${grade.common_nm}">
									</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_ag" class="form-label">발령직위</label> <select
									id="transfer_ag" class="form-select">
									<option value="" disabled selected>직위를 선택하세요</option>
									<option th:each="grade : ${grade_list}"
										th:value="${grade.common_cc}" th:text="${grade.common_nm}">
									</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col">
								<label for="transfer_od" class="form-label">기존부서</label> <select
									id="transfer_od" class="form-select">
									<option value="" disabled selected>부서를 선택하세요</option>
									<option th:each="dept : ${dept_list}"
										th:value="${dept.common_cc}" th:text="${dept.common_nm}">
									</option>
								</select>
							</div>
							<div class="col">
								<label for="transfer_adp" class="form-label">발령부서</label> <select
									id="transfer_adp" class="form-select">
									<option value="" disabled selected>부서를 선택하세요</option>
									<option th:each="dept : ${dept_list}"
										th:value="${dept.common_cc}" th:text="${dept.common_nm}">
									</option>
								</select>
							</div>
						</div>
						<div class="modal-footer d-flex justify-content-between">
							<button type="button" class="btn btn-secondary"
								id="btn_modal_reset">초기화</button>
							<div>
								<button type="submit" class="btn btn-primary">저장</button>
								<button type="button" class="btn btn-secondary"
									data-bs-dismiss="modal">닫기</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade" id="modal_employee_list" tabindex="-1"
		aria-labelledby="modal_employee_list_label" aria-hidden="true"
		data-bs-backdrop="false" data-bs-keyboard="false">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal_employee_list_label">사원 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<table id="empTable" class="table table-striped">
						<thead>
							<tr>
								<th>사원코드</th>
								<th>이름</th>
								<th>부서</th>
								<th>직위</th>
								<th>선택</th>
							</tr>
						</thead>
						<tbody>
							<!-- 여기에 사원 정보를 동적으로 추가 -->

						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	</div>


</body>
<script th:inline="javascript">

	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

// 	const transferData = /*[[${transferList}]]*/[];
// 	console.log(transferData);


	document.addEventListener('DOMContentLoaded', function () {

		fetch('/select_TRANSFER', {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(response => {
				if (!response.ok) {
					throw new Error('네트워크 응답이 실패했습니다.');
				}
				return response.json();
			})
			.then(transferData => {
				console.log('서버 응답 데이터:', transferData);

				// Grid 초기화
				grid = new tui.Grid({
					el: document.getElementById('grid'),
					data: transferData.map(row => ({
						transfer_id: row.transfer_id,
						// 빈 값 처리
						employee_nm: '', 
						employee_cd: row.employee_cd,
						transfer_ad: row.transfer_ad,
						transfer_ac: row.transfer_ac,
						transfer_og: row.transfer_og,
						transfer_ag: row.transfer_ag,
						transfer_od: row.transfer_od,
						transfer_adp: row.transfer_adp,
						
					})),
					columns: [
						{header: '이름', name: 'employee_nm', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
						{header: '사원코드', name: 'employee_cd', align: 'center', filter: {type: 'text', showApplyBtn: true}, sortable: true},
						{header: '인사발령일', name: 'transfer_ad', align: 'center', filter: {type: 'date', showApplyBtn: true}, sortable: true},
						{header: '발령구분', name: 'transfer_ac', align: 'center', filter: {type: 'select', options: ['승진', '전근', '복직']}, sortable: true},
						{header: '기존직위', name: 'transfer_og', align: 'center', filter: {type: 'select', options: ['사원', '대리', '과장']}, sortable: true},
						{header: '변경직위', name: 'transfer_ag', align: 'center', filter: {type: 'select', options: ['사원', '대리', '과장']}, sortable: true},
						{header: '기존부서', name: 'transfer_od', align: 'center', filter: {type: 'select', options: ['영업부', '개발부', '기획부', '인사부']}, sortable: true},
						{header: '발령부서', name: 'transfer_adp', align: 'center', filter: {type: 'select', options: ['영업부', '개발부', '기획부', '인사부']}, sortable: true}
					],
					rowHeaders: ['checkbox'],
					autoWidth: true,
					rowHeight: 'auto',
					bodyHeight: 'auto',
					scrollX: true,
					scrollY: true
				});
			})
			.catch(error => {
				console.error('오류 발생:', error);
			});

		// 삭제 버튼 클릭 이벤트
		document.querySelector('#btn_transfer_delete').addEventListener('click', function () {
			if (!grid) {
				alert('Grid가 초기화되지 않았습니다.');
				return;
			}

			// 체크된 행 데이터 가져오기
			const checkedRows = grid.getCheckedRows();
			console.log('체크된 행 데이터:', checkedRows);

			if (checkedRows.length === 0) {
				alert('삭제할 데이터를 선택하세요.');
				return;
			}

			// transfer_id만 추출
			const idsToDelete = checkedRows.map(row => row.transfer_id); // rows_id_delete
			// 로그로 확인
			console.log('삭제할 ID 리스트:', idsToDelete);

			if (!confirm('선택한 데이터를 삭제하시겠습니까?')) {
				return;
			}

			// AJAX 요청으로 삭제
			fetch('/delete_TRANSFER', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					// CSRF 토큰 추가
					[csrfHeader]: csrfToken
				},
				// 삭제할 ID 배열 전달
				body: JSON.stringify({ids: idsToDelete}) 
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('삭제 요청 실패');
					}
					return response.json();
				})
				.then(data => {
					if (data.success) {
						alert('삭제가 완료되었습니다.');
						// 페이지 새로고침
						location.reload(); 
					} else {
						alert('삭제에 실패했습니다: ' + data.message);
					}
				})
				.catch(error => {
					console.error('오류 발생:', error);
					alert('삭제 중 오류가 발생했습니다.');
				});
		});

		// TOAST UI Date Picker
		// 모달 열릴 때 Date Picker 초기화
		document.getElementById('modal_appointment_save').addEventListener('shown.bs.modal', function () {
			// Date Picker 초기화
			new tui.DatePicker('#wrapper', {
				input: {
					element: '#transfer_ad',
					format: 'yyyy-MM-dd'
				},
				// 오늘 날짜
				date: new Date()
			});
		});
	});
	
	// 폼 데이터를 초기화
	document.getElementById('btn_modal_reset').addEventListener('click', function () {
	    const modalForm = document.getElementById('modal_appointment_save_form');
	    modalForm.reset(); 
	});
	
	// 모달이 닫힐 때 폼 데이터 초기화
	document.getElementById('modal_appointment_save').addEventListener('hidden.bs.modal', function () {
	    const modalForm = document.getElementById('modal_appointment_save_form');
	    modalForm.reset();
	});
	
	// 이름 또는 사원코드 클릭 시 사원 선택 모달 열기
	document.getElementById('employee_nm').addEventListener('click', function () {
    const modal_employee_list = new bootstrap.Modal(document.getElementById('modal_employee_list'));
    modal_employee_list.show();

    // 서버에서 사원 정보를 가져오는 요청
    fetch('/select_EMPLOYEE_COMMON', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
        .then((response) => {
            if (!response.ok) {
                throw new Error('서버 응답 오류');
            }
            return response.json();
        })
        .then((data) => {
            // 데이터 가져온 후 테이블 갱신
            const tbody = document.querySelector('#empTable tbody');
            tbody.innerHTML = ''; // 기존 내용 초기화

            // 데이터를 테이블에 동적으로 추가
            data.forEach((employee) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.employee_cd}</td>
                    <td>${employee.employee_nm}</td>
                    <td>${employee.department_name}</td>
                    <td>${employee.position_name}</td>
                    <td><button type="button" class="btn btn-primary select-emp-btn">선택</button></td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch((error) => console.error('사원 목록 가져오기 실패:', error));
});


	document.getElementById('employee_cd').addEventListener('click', function () {
		const modal_employee_list = new bootstrap.Modal(document.getElementById('modal_employee_list'));
		modal_employee_list.show();
	});

	// 선택 버튼 클릭 이벤트 처리
	document.addEventListener('click', function (event) {
		// 선택 버튼(`select-emp-btn`)이 클릭되었는지 확인
		if (event.target.classList.contains('select-emp-btn')) {
			// 클릭된 버튼이 속한 행(`tr`)을 가져옴
			const selectedRow = event.target.closest('tr'); // tr_

			// 행의 각 열(`td`)에서 데이터를 가져옴
			const employee_cd = selectedRow.cells[0].textContent; // 사원코드
			const employee_nm = selectedRow.cells[1].textContent;    // 이름

			// 기존 모달의 필드에 값 설정
			document.getElementById('employee_cd').value = employee_cd;
			document.getElementById('employee_nm').value = employee_nm;

			// 사원 선택 모달 닫기
			const modal_employee_list = bootstrap.Modal.getInstance(document.getElementById('modal_employee_list'));
			modal_employee_list.hide();
		}
	});

	// 모달 저장 버튼 클릭 시 이벤트 처리
	document.getElementById('modal_appointment_save').addEventListener('submit', function (event) {
		event.preventDefault(); // 폼 기본 동작 방지

		// 모달 입력값 가져오기
		const employee_cd = document.getElementById('employee_cd').value;
		const transfer_ad = document.getElementById('transfer_ad').value;
		const transfer_ac = document.getElementById('transfer_ac').value;
		const transfer_og = document.getElementById('transfer_og').value;
		const transfer_ag = document.getElementById('transfer_ag').value;
		const transfer_od = document.getElementById('transfer_od').value;
		const transfer_adp = document.getElementById('transfer_adp').value;

		// AJAX 요청
		fetch('/insert_TRANSFER', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRF-TOKEN': csrfToken,
			},
			body: JSON.stringify({
				employee_cd: employee_cd,
				transfer_ad: transfer_ad,
				transfer_ac: transfer_ac,
				transfer_og: transfer_og,
				transfer_ag: transfer_ag,
				transfer_od: transfer_od,
				transfer_adp: transfer_adp,
			}),
		})
			// JSON 응답 처리
			.then(response => response.json())
			// 서버 응답 메시지 표시
			.then(data => {
				alert(data.message);
				// 페이지 새로고침
				location.reload();
			})
			.catch(error => {
				console.error('오류 발생:', error);
			});
	});

</script>

</html>