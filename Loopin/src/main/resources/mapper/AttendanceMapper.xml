<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.c4d2412t3p1.mapper.AttendanceMapper">
    
    <select id="select_ATTENDANCE" resultType="map">
	   SELECT 
	        a.*, 
	        e.EMPLOYEE_NM, 
	        c.COMMON_NM, 
	        e.EMPLOYEE_HD,
	        a.EMPLOYEE_CD,
	        CASE 
	            WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 1 
	            THEN TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')))) || '개월'
	            ELSE TO_CHAR(FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12)) || '년'
	        END AS SERVICE_YEARS,
	        c.COMMON_NM AS DEPARTMENT_NAME,
	        CASE 
		        WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 1 
		            THEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd'))) + NVL(a.ANNUAL_RA, 0)
		        WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 3 
		            THEN 15 + NVL(a.ANNUAL_RA, 0)
		        ELSE 
		            LEAST(15 + FLOOR((FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) - 3) / 2), 25) + NVL(a.ANNUAL_RA, 0)
		    END AS EXPECT_ANNUAL
	    FROM ANNUAL a
		LEFT JOIN EMPLOYEE e 
	       	   ON a.EMPLOYEE_CD = e.EMPLOYEE_CD
	    LEFT JOIN COMMON_CODE c
	       	   ON e.EMPLOYEE_DP = c.COMMON_CC
	   WHERE 1=1
	   		 AND c.COMMON_GC = 'DEPARTMENT'
			 AND EMPLOYEE_US = '1'
	   ORDER BY a.ANNUAL_YR DESC, a.EMPLOYEE_CD DESC
	</select>
    
    <select id="select_EMPLOYEE_ANNUAL" resultType="map">
        SELECT e.*, c.*
          FROM EMPLOYEE e
	 LEFT JOIN COMMON_CODE c ON e.EMPLOYEE_DP = c.COMMON_CC AND c.COMMON_GC = 'DEPARTMENT'
         WHERE 1=1
			   AND e.EMPLOYEE_NM LIKE '%' || #{employee_nm} || '%'
	  ORDER BY e.EMPLOYEE_CD DESC
    </select>
    
    <select id="select_filer_ANNUAL" resultType="map">
	    SELECT 
	        a.*,
	        e.EMPLOYEE_NM,
	        e.EMPLOYEE_HD,
	        c.COMMON_NM,
	        CASE 
		        WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 1 
		        THEN TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')))) || '개월'
		        ELSE TO_CHAR(FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12)) || '년'
		    END AS service_years
	    FROM ANNUAL a
		LEFT JOIN EMPLOYEE e 
	        ON a.EMPLOYEE_CD = e.EMPLOYEE_CD
        LEFT JOIN COMMON_CODE c
       	    ON e.EMPLOYEE_DP = c.COMMON_CC
	    <where> 1=1
	    		AND c.COMMON_GC = 'DEPARTMENT'
	        <if test="employee_cd != null and employee_cd != ''">
	            AND a.EMPLOYEE_CD = #{employee_cd}
	        </if>
	        <if test="employee_nm != null and employee_nm != ''">
	            AND e.EMPLOYEE_NM = #{employee_nm}
	        </if>
	        <if test="employee_dp != null and employee_dp != ''">
	            AND e.EMPLOYEE_DP = #{employee_dp}
	        </if>
	        <if test="employee_hd1 != null and employee_hd1 != '' and employee_hd2 != null and employee_hd2 != ''">
	            AND #{employee_hd1} &lt;= e.EMPLOYEE_HD AND e.EMPLOYEE_HD &lt;= #{employee_hd2}
	        </if>
	        <if test="annual_ra != null and annual_ra != ''">
	            AND a.ANNUAL_RA = #{annual_ra}
	        </if>
	    </where>
	   ORDER BY a.ANNUAL_YR DESC, a.EMPLOYEE_CD DESC
	</select>
	
	
    <insert id="insert_ANNUAL" parameterType="map">
		INSERT INTO ANNUAL (EMPLOYEE_CD
						    , ANNUAL_YR
						    , ANNUAL_UA
						    , ANNUAL_RA
						    , ANNUAL_AA
						    , ANNUAL_RU
						    , ANNUAL_RD
						    , ANNUAL_UU
						    , ANNUAL_UD
							)
					VALUES (#{EMPLOYEE_CD}
							, #{ANNUAL_YR}+1
							, 0 
							, #{EXPECT_ANNUAL} 
							, #{EXPECT_ANNUAL} 
							, #{ANNUAL_RU} 
							, #{ANNUAL_RD} 
							, NULL
							, NULL)
	</insert>
	
	<select id="select_APPROVAL_ANNUAL" resultType="map">
		 SELECT 
		    e.EMPLOYEE_CD, -- 사원코드
		    e.EMPLOYEE_NM, -- 이름
		    a.APPROVAL_DV, -- 휴가코드
		    CASE 
		        WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 1 
		        THEN TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')))) || '개월'
		        ELSE TO_CHAR(FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12)) || '년'
		    END AS SERVICE_YEARS,
		    cc.COMMON_NM AS DEPARTMENT_NAME,
		    COUNT(a.APPROVAL_CD) AS total_approvals, -- 승인받은 휴가 개수 합산
		    SUM(
		        CASE 
		            WHEN JSON_VALUE(a.APPROVAL_CT, '$.annualtype') = 'AN'  
		            THEN TO_DATE(JSON_VALUE(a.APPROVAL_CT, '$.endday'), 'YYYY-MM-DD') 
		                 - TO_DATE(JSON_VALUE(a.APPROVAL_CT, '$.startday'), 'YYYY-MM-DD') + 1
		            ELSE 0
		        END
		    ) AS total_days, -- AN의 전체 일수 합산
		    SUM(
		        CASE 
		            WHEN JSON_VALUE(a.APPROVAL_CT, '$.annualtype') = 'AN' THEN 1  
		            WHEN JSON_VALUE(a.APPROVAL_CT, '$.annualtype') = 'BN' THEN 0.5
		            ELSE 0
		        END
		    ) AS total_mapped_value 			-- 연차 시작 끝 고려안하고 갯수만 들어갔고, 반차 갯수만 들어감 고쳐야함
		    , ann.ANNUAL_AA
		FROM APPROVAL a
		LEFT OUTER JOIN COMMON_CODE c 
		    ON a.APPROVAL_DV = c.COMMON_CC 
		   AND c.COMMON_GC = 'DRAFT' 
		LEFT JOIN EMPLOYEE e 
		    ON a.EMPLOYEE_CD = e.EMPLOYEE_CD
		LEFT JOIN COMMON_CODE cc -- 부서 코드 테이블 조인
		    ON e.EMPLOYEE_DP = cc.COMMON_CC 
		   AND cc.COMMON_GC = 'DEPARTMENT' -- 부서 코드
		   LEFT JOIN ANNUAL ann -- ANNUAL 테이블 조인
		    ON e.EMPLOYEE_CD = ann.EMPLOYEE_CD 
		   AND ann.ANNUAL_YR = '2024' 														-- 동적 변환!!!!!!!!
		WHERE a.APPROVAL_DV = '50'  														-- 동적 변환!!!!!!!!
		GROUP BY 
		    e.EMPLOYEE_CD, 
		    e.EMPLOYEE_NM, 
		    a.APPROVAL_DV, -- 기안코드
		    cc.COMMON_NM, -- 부서명 
		    CASE 
		        WHEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12) &lt; 1 
		        THEN TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')))) || '개월'
		        ELSE TO_CHAR(FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(e.EMPLOYEE_HD, 'yyyy-MM-dd')) / 12)) || '년'
		    END, -- 근속연수
		   ann.ANNUAL_AA
    </select>
	
</mapper>
